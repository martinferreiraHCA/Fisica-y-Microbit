<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>micro:bit DataLab Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- regression-js: Librer√≠a para ajuste de curvas por m√≠nimos cuadrados -->
    <!-- Autor: Tom Alexander - https://github.com/Tom-Alexander/regression-js -->
    <script src="https://cdn.jsdelivr.net/npm/regression@2.0.1/dist/regression.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: white;
            color: #000;
        }

        /* Toolbar minimalista */
        .toolbar {
            background: white;
            border-bottom: 2px solid black;
            padding: 12px 16px;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .toolbar-btn {
            background: white;
            border: 2px solid black;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .toolbar-btn:hover:not(:disabled) {
            background: black;
            color: white;
        }

        .toolbar-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .toolbar-btn.primary {
            background: black;
            color: white;
        }

        .toolbar-btn.primary:hover:not(:disabled) {
            background: #333;
        }

        .toolbar-btn.success {
            background: #2e7d32;
            color: white;
            border-color: #2e7d32;
        }

        .toolbar-btn.success:hover:not(:disabled) {
            background: #1b5e20;
        }

        .toolbar-separator {
            width: 2px;
            height: 24px;
            background: black;
            margin: 0 4px;
        }

        .status-text {
            margin-left: auto;
            font-size: 0.9rem;
            font-weight: 500;
            padding: 8px 16px;
            border: 2px solid black;
        }

        /* Layout principal */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 340px;
            height: calc(100vh - 58px);
        }

        /* Panel de gr√°ficas */
        .graph-panel {
            background: white;
            border-right: 2px solid black;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .graphs-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            flex: 1;
        }

        .graph-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 300px;
        }

        .graph-wrapper.single {
            min-height: 500px;
        }

        .graph-wrapper.double {
            min-height: 400px;
        }

        .graph-wrapper.triple {
            min-height: 300px;
        }

        .graph-title {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .chart-container {
            flex: 1;
            position: relative;
            min-height: 250px;
        }

        .chart-container canvas {
            position: relative;
        }

        /* Panel lateral */
        .side-panel {
            background: white;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .panel-section {
            border-bottom: 2px solid black;
        }

        .section-header {
            background: white;
            padding: 12px 16px;
            font-weight: 700;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ccc;
        }

        .section-header:hover {
            background: #f5f5f5;
        }

        .section-content {
            padding: 16px;
            background: white;
        }

        .section-content.collapsed {
            display: none;
        }

        .input-row {
            margin-bottom: 12px;
        }

        .input-row label {
            display: block;
            font-size: 0.85rem;
            margin-bottom: 6px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-row input, .input-row select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid black;
            font-size: 0.9rem;
            background: white;
        }

        .input-row input[type="color"] {
            height: 40px;
            padding: 4px;
        }

        .input-row input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        .input-row input:focus, .input-row select:focus {
            outline: none;
            background: #f5f5f5;
        }

        .btn-full {
            width: 100%;
            margin-top: 8px;
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            padding: 8px;
            border: 2px solid #e0e0e0;
            cursor: pointer;
        }

        .checkbox-row:hover {
            background: #f5f5f5;
        }

        .checkbox-row input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-row label {
            cursor: pointer;
            flex: 1;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        .variable-config {
            border: 2px solid black;
            padding: 12px;
            margin-bottom: 12px;
            background: #f9f9f9;
        }

        .variable-config h4 {
            font-size: 0.85rem;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .color-preview {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid black;
            vertical-align: middle;
            margin-left: 8px;
        }

        /* Tabla minimalista */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .data-table thead {
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        .data-table th {
            padding: 8px;
            text-align: left;
            border-bottom: 2px solid black;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.75rem;
        }

        .data-table td {
            padding: 6px 8px;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table tr:hover {
            background: #f5f5f5;
        }

        .data-table tr.selected {
            background: #ffebee;
            border-left: 3px solid #ff0000;
        }

        .data-table tr.selected td {
            color: #d32f2f;
            font-weight: 600;
        }

        .data-table input {
            width: 100%;
            border: none;
            background: transparent;
            padding: 4px;
            font-size: 0.85rem;
        }

        .data-table input:focus {
            background: white;
            border: 1px solid black;
            outline: none;
        }

        .delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            padding: 0 4px;
        }

        .delete-btn:hover {
            color: #666;
        }

        .table-controls {
            padding: 12px;
            background: #f5f5f5;
            border-bottom: 2px solid black;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .table-search {
            flex: 1;
            padding: 6px 10px;
            border: 2px solid black;
            font-size: 0.85rem;
        }

        .table-filter {
            padding: 6px 10px;
            border: 2px solid black;
            font-size: 0.85rem;
            background: white;
        }

        /* Caja de resultados minimalista */
        .fit-box {
            background: white;
            border: 2px solid black;
            padding: 12px;
            margin-top: 12px;
            font-family: 'Courier New', monospace;
        }

        .fit-box .title {
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .fit-box .equation {
            font-size: 1.1rem;
            margin: 8px 0;
            font-weight: 600;
        }

        .fit-box .stats {
            font-size: 0.85rem;
            margin-top: 8px;
            line-height: 1.6;
        }

        /* Stats modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border: 3px solid black;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .modal-body {
            font-family: 'Courier New', monospace;
            line-height: 2;
        }

        .modal-close {
            margin-top: 16px;
            width: 100%;
        }

        /* Help/Tutorial modal */
        .help-modal {
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .help-section {
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .help-section:last-child {
            border-bottom: none;
        }

        .help-section h3 {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .help-section p {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .help-section ul {
            margin-left: 20px;
            margin-bottom: 12px;
        }

        .help-section li {
            margin-bottom: 6px;
            line-height: 1.5;
        }

        .code-block {
            background: #f5f5f5;
            border: 2px solid black;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            margin: 12px 0;
        }

        .code-block pre {
            margin: 0;
            white-space: pre;
        }

        .step-number {
            display: inline-block;
            background: black;
            color: white;
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
            border-radius: 50%;
            font-weight: 700;
            margin-right: 8px;
        }

        .feature-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .feature-icon {
            font-weight: 700;
            font-size: 1.2rem;
            margin-right: 12px;
            min-width: 24px;
        }

        .feature-text {
            flex: 1;
        }

        .feature-text strong {
            display: block;
            margin-bottom: 4px;
        }

        /* Video modal */
        .video-modal {
            max-width: 900px;
            width: 95%;
        }

        .video-container {
            background: black;
            border: 2px solid black;
            margin-top: 16px;
            position: relative;
        }

        .video-container video {
            width: 100%;
            display: block;
        }

        .video-info {
            padding: 12px;
            background: white;
            border-top: 2px solid black;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .video-controls {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        /* Camera preview */
        .camera-preview {
            background: black;
            border: 2px solid black;
            margin-top: 12px;
            position: relative;
        }

        .camera-preview video {
            width: 100%;
            display: block;
        }

        .recording-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: black;
            color: white;
            padding: 6px 12px;
            font-size: 0.8rem;
            font-weight: 700;
            letter-spacing: 1px;
            display: none;
        }

        .recording-indicator.active {
            display: block;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .info-box {
            background: #e3f2fd;
            border: 2px solid #1976d2;
            padding: 12px;
            margin-bottom: 12px;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .info-box strong {
            display: block;
            margin-bottom: 4px;
            color: #1565c0;
        }

        .warning-box {
            background: #fff3e0;
            border: 2px solid #f57c00;
            padding: 12px;
            margin-bottom: 12px;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .warning-box strong {
            display: block;
            margin-bottom: 4px;
            color: #e65100;
        }

        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
            }
            .graph-panel {
                border-right: none;
                border-bottom: 2px solid black;
            }
        }
    </style>
</head>
<body>
    <!-- Toolbar -->
    <div class="toolbar">
        <button id="connectBtn" class="toolbar-btn primary">CONECTAR</button>
        <button id="collectBtn" class="toolbar-btn primary" style="display:none;">CAPTURAR</button>
        <button id="stopBtn" class="toolbar-btn" style="display:none;">DETENER</button>

        <div class="toolbar-separator"></div>

        <button id="cameraBtn" class="toolbar-btn">C√ÅMARA</button>
        <button id="statsBtn" class="toolbar-btn">ESTAD√çSTICAS</button>

        <div class="toolbar-separator"></div>

        <button id="exportBtn" class="toolbar-btn" disabled>EXPORTAR CSV</button>
        <button id="importBtn" class="toolbar-btn">IMPORTAR CSV</button>
        <input type="file" id="importFile" accept=".csv" style="display: none;">
        <button id="clearBtn" class="toolbar-btn">LIMPIAR</button>

        <div class="toolbar-separator"></div>

        <a href="https://makecode.microbit.org/" target="_blank" class="toolbar-btn" style="text-decoration: none; display: inline-flex; align-items: center;">
            MAKECODE ‚Üó
        </a>

        <div class="toolbar-separator"></div>

        <button id="helpBtn" class="toolbar-btn">AYUDA</button>

        <span class="status-text" id="pointInfo" style="display: none; background: #ffebee; border-color: #ff0000; color: #d32f2f;"></span>
        <span class="status-text" id="statusText">DESCONECTADO</span>
    </div>

    <!-- Main -->
    <div class="main-container">
        <!-- Gr√°ficas -->
        <div class="graph-panel">
            <div class="graphs-container" id="graphsContainer">
                <!-- Las gr√°ficas se generan din√°micamente aqu√≠ -->
            </div>
        </div>

        <!-- Panel lateral -->
        <div class="side-panel">
            <!-- Video -->
            <div class="panel-section" id="videoSection" style="display:none;">
                <div class="section-header" onclick="toggleSection(this)">
                    VIDEO <span>‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="camera-preview">
                        <video id="cameraPreview" autoplay muted></video>
                        <div class="recording-indicator" id="recordingIndicator">‚óè REC</div>
                    </div>
                    <button class="toolbar-btn btn-full" id="stopCameraBtn">
                        DETENER C√ÅMARA
                    </button>
                </div>
            </div>

            <!-- Configuraci√≥n de Variables -->
            <div class="panel-section">
                <div class="section-header" onclick="toggleSection(this)">
                    VARIABLES <span>‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="input-row">
                        <label>N√∫mero de Variables</label>
                        <select id="numVariables">
                            <option value="1" selected>1 Variable</option>
                            <option value="2">2 Variables</option>
                            <option value="3">3 Variables</option>
                        </select>
                    </div>

                    <!-- Variable 1 -->
                    <div class="variable-config" id="var1Config">
                        <h4>Variable 1</h4>
                        <div class="input-row">
                            <label>Nombre</label>
                            <input type="text" id="var1Name" value="Variable 1">
                        </div>
                        <div class="input-row">
                            <label>Color <span class="color-preview" id="var1ColorPreview" style="background: #000000;"></span></label>
                            <input type="color" id="var1Color" value="#000000">
                        </div>
                    </div>

                    <!-- Variable 2 -->
                    <div class="variable-config hidden" id="var2Config">
                        <h4>Variable 2</h4>
                        <div class="input-row">
                            <label>Nombre</label>
                            <input type="text" id="var2Name" value="Variable 2">
                        </div>
                        <div class="input-row">
                            <label>Color <span class="color-preview" id="var2ColorPreview" style="background: #ff0000;"></span></label>
                            <input type="color" id="var2Color" value="#ff0000">
                        </div>
                    </div>

                    <!-- Variable 3 -->
                    <div class="variable-config hidden" id="var3Config">
                        <h4>Variable 3</h4>
                        <div class="input-row">
                            <label>Nombre</label>
                            <input type="text" id="var3Name" value="Variable 3">
                        </div>
                        <div class="input-row">
                            <label>Color <span class="color-preview" id="var3ColorPreview" style="background: #0000ff;"></span></label>
                            <input type="color" id="var3Color" value="#0000ff">
                        </div>
                    </div>

                    <button class="toolbar-btn primary btn-full" id="applyVarConfigBtn">
                        APLICAR CONFIGURACI√ìN
                    </button>
                </div>
            </div>

            <!-- Configuraci√≥n de Gr√°ficas -->
            <div class="panel-section">
                <div class="section-header" onclick="toggleSection(this)">
                    CONFIGURACI√ìN DE GR√ÅFICAS <span>‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="input-row">
                        <label>N√∫mero de Gr√°ficas</label>
                        <select id="numGraphs">
                            <option value="1" selected>1 Gr√°fica</option>
                            <option value="2">2 Gr√°ficas</option>
                            <option value="3">3 Gr√°ficas</option>
                        </select>
                    </div>

                    <div class="info-box">
                        <strong>CONFIGURACI√ìN DE EJES:</strong>
                        Personaliza qu√© variables mostrar en cada gr√°fica y en qu√© ejes.
                    </div>

                    <!-- Configuraci√≥n Gr√°fica 1 -->
                    <div id="graph1Config">
                        <h4 style="margin-bottom: 8px; font-size: 0.85rem;">GR√ÅFICA 1</h4>
                        <div class="input-row">
                            <label>Eje X</label>
                            <select id="graph1XAxis">
                                <option value="time">Tiempo</option>
                            </select>
                        </div>
                        <div class="input-row">
                            <label>Variables en Eje Y</label>
                            <div id="graph1YVars">
                                <!-- Checkboxes din√°micos -->
                            </div>
                        </div>
                        <div class="input-row">
                            <label>Etiqueta Eje X</label>
                            <input type="text" id="graph1XLabel" value="Tiempo (s)">
                        </div>
                        <div class="input-row">
                            <label>Etiqueta Eje Y</label>
                            <input type="text" id="graph1YLabel" value="Valor">
                        </div>
                    </div>

                    <!-- Configuraci√≥n Gr√°fica 2 -->
                    <div id="graph2Config" class="hidden" style="margin-top: 16px; padding-top: 16px; border-top: 2px solid #e0e0e0;">
                        <h4 style="margin-bottom: 8px; font-size: 0.85rem;">GR√ÅFICA 2</h4>
                        <div class="input-row">
                            <label>Eje X</label>
                            <select id="graph2XAxis">
                                <option value="time">Tiempo</option>
                            </select>
                        </div>
                        <div class="input-row">
                            <label>Variables en Eje Y</label>
                            <div id="graph2YVars">
                                <!-- Checkboxes din√°micos -->
                            </div>
                        </div>
                        <div class="input-row">
                            <label>Etiqueta Eje X</label>
                            <input type="text" id="graph2XLabel" value="Tiempo (s)">
                        </div>
                        <div class="input-row">
                            <label>Etiqueta Eje Y</label>
                            <input type="text" id="graph2YLabel" value="Valor">
                        </div>
                    </div>

                    <!-- Configuraci√≥n Gr√°fica 3 -->
                    <div id="graph3Config" class="hidden" style="margin-top: 16px; padding-top: 16px; border-top: 2px solid #e0e0e0;">
                        <h4 style="margin-bottom: 8px; font-size: 0.85rem;">GR√ÅFICA 3</h4>
                        <div class="input-row">
                            <label>Eje X</label>
                            <select id="graph3XAxis">
                                <option value="time">Tiempo</option>
                            </select>
                        </div>
                        <div class="input-row">
                            <label>Variables en Eje Y</label>
                            <div id="graph3YVars">
                                <!-- Checkboxes din√°micos -->
                            </div>
                        </div>
                        <div class="input-row">
                            <label>Etiqueta Eje X</label>
                            <input type="text" id="graph3XLabel" value="Tiempo (s)">
                        </div>
                        <div class="input-row">
                            <label>Etiqueta Eje Y</label>
                            <input type="text" id="graph3YLabel" value="Valor">
                        </div>
                    </div>

                    <div class="input-row" style="margin-top: 16px;">
                        <label>Unidad tiempo</label>
                        <select id="timeUnit">
                            <option value="1">Milisegundos</option>
                            <option value="1000" selected>Segundos</option>
                            <option value="60000">Minutos</option>
                        </select>
                    </div>

                    <div class="checkbox-row">
                        <input type="checkbox" id="showLinesToggle" checked>
                        <label for="showLinesToggle">Mostrar L√≠neas</label>
                    </div>

                    <button class="toolbar-btn primary btn-full" id="applyGraphConfigBtn">
                        APLICAR CONFIGURACI√ìN
                    </button>

                    <button class="toolbar-btn btn-full" id="setZeroBtn" disabled>
                        ESTABLECER T=0
                    </button>
                </div>
            </div>

            <!-- Ajuste de Curva -->
            <div class="panel-section">
                <div class="section-header" onclick="toggleSection(this)">
                    AJUSTE DE CURVA <span>‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="info-box">
                        <strong>REGRESI√ìN POR M√çNIMOS CUADRADOS:</strong>
                        Ajusta una funci√≥n matem√°tica a tus datos experimentales.
                    </div>

                    <div class="input-row">
                        <label>Tipo de Ajuste</label>
                        <select id="fitType">
                            <option value="linear">Lineal (y = mx + b)</option>
                            <option value="quadratic">Cuadr√°tico (y = ax¬≤ + bx + c)</option>
                            <option value="cubic">C√∫bico (y = ax¬≥ + bx¬≤ + cx + d)</option>
                            <option value="exponential">Exponencial (y = a¬∑e^(bx))</option>
                            <option value="power">Potencia (y = a¬∑x^b)</option>
                            <option value="logarithmic">Logar√≠tmico (y = a¬∑ln(x) + b)</option>
                            <option value="inverse">Inverso (y = a/x + b)</option>
                        </select>
                    </div>

                    <div class="input-row">
                        <label>Variable a Ajustar</label>
                        <select id="fitVariable">
                            <option value="0">Variable 1</option>
                        </select>
                    </div>

                    <div class="input-row">
                        <label>Gr√°fica de Referencia</label>
                        <select id="fitGraphSelect">
                            <option value="0">Gr√°fica 1</option>
                        </select>
                    </div>

                    <div style="margin-top: 12px; padding: 10px; background: #f9f9f9; border-radius: 4px;">
                        <div style="margin-bottom: 8px; font-weight: bold; font-size: 11px;">DATOS A AJUSTAR:</div>

                        <div class="checkbox-row">
                            <input type="radio" id="fitModeAll" name="fitMode" value="all" checked>
                            <label for="fitModeAll">Todos los Datos</label>
                        </div>

                        <div class="checkbox-row">
                            <input type="radio" id="fitModeSelected" name="fitMode" value="selected">
                            <label for="fitModeSelected">Puntos Seleccionados Manualmente</label>
                        </div>

                        <div class="checkbox-row">
                            <input type="radio" id="fitModeRange" name="fitMode" value="range">
                            <label for="fitModeRange">Rango de Puntos</label>
                        </div>

                        <div id="fitRangeInputs" style="margin-top: 8px; display: none;">
                            <div class="input-row">
                                <label>Desde Punto</label>
                                <input type="number" id="fitRangeFrom" placeholder="Ej: 1" min="1" style="font-size: 12px;">
                            </div>
                            <div class="input-row">
                                <label>Hasta Punto</label>
                                <input type="number" id="fitRangeTo" placeholder="Ej: 50" min="1" style="font-size: 12px;">
                            </div>
                        </div>
                    </div>

                    <button class="toolbar-btn primary btn-full" id="performFitBtn" disabled>
                        REALIZAR AJUSTE
                    </button>

                    <button class="toolbar-btn btn-full" id="clearFitBtn" disabled style="margin-top: 8px;">
                        LIMPIAR AJUSTE
                    </button>

                    <div id="fitResults" style="margin-top: 12px; padding: 12px; background: #f0f0f0; border-radius: 4px; font-family: monospace; font-size: 12px; display: none;">
                        <div style="margin-bottom: 8px;"><strong>Ecuaci√≥n:</strong></div>
                        <div id="fitEquation" style="margin-bottom: 12px; color: #0066cc;"></div>
                        <div style="margin-bottom: 4px;"><strong>Coeficiente R¬≤:</strong> <span id="fitR2"></span></div>
                        <div style="margin-bottom: 4px;"><strong>Puntos usados:</strong> <span id="fitPoints"></span></div>
                    </div>
                </div>
            </div>

            <!-- Depuraci√≥n de Datos -->
            <div class="panel-section">
                <div class="section-header" onclick="toggleSection(this)">
                    DEPURACI√ìN DE DATOS <span>‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="info-box">
                        <strong>ELIMINAR PUNTOS:</strong>
                        Usa estas herramientas para limpiar datos incorrectos o no deseados.
                    </div>

                    <div class="input-row">
                        <label>Eliminar Rango (desde)</label>
                        <input type="number" id="deleteRangeFrom" placeholder="Punto inicial" min="1">
                    </div>

                    <div class="input-row">
                        <label>Eliminar Rango (hasta)</label>
                        <input type="number" id="deleteRangeTo" placeholder="Punto final" min="1">
                    </div>

                    <button class="toolbar-btn btn-full" id="deleteRangeBtn" disabled>
                        ELIMINAR RANGO
                    </button>

                    <button class="toolbar-btn btn-full" id="deleteSelectedBtn" disabled style="margin-top: 8px;">
                        ELIMINAR SELECCIONADOS
                    </button>

                    <button class="toolbar-btn btn-full" id="clearSelectionBtn" disabled style="margin-top: 8px;">
                        LIMPIAR SELECCI√ìN
                    </button>
                </div>
            </div>

            <!-- Datos -->
            <div class="panel-section" style="flex: 1; display: flex; flex-direction: column;">
                <div class="section-header" onclick="toggleSection(this)">
                    DATOS <span>‚ñº</span>
                </div>
                <div class="table-controls">
                    <input type="text" id="tableSearch" class="table-search" placeholder="Buscar...">
                    <select id="tableFilter" class="table-filter">
                        <option value="all">Todos</option>
                        <option value="selected">Seleccionados</option>
                    </select>
                </div>
                <div class="section-content" style="flex: 1; overflow-y: auto; max-height: 400px; padding: 0;">
                    <table class="data-table">
                        <thead>
                            <tr id="dataTableHeader">
                                <th>#</th>
                                <th>T</th>
                                <th>V1</th>
                                <th>üìπ</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 20px;">SIN DATOS</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de estad√≠sticas -->
    <div class="modal" id="statsModal">
        <div class="modal-content">
            <div class="modal-header">ESTAD√çSTICAS</div>
            <div class="modal-body" id="statsBody"></div>
            <button class="toolbar-btn primary modal-close" onclick="closeStatsModal()">CERRAR</button>
        </div>
    </div>

    <!-- Modal de video -->
    <div class="modal" id="videoModal">
        <div class="modal-content video-modal">
            <div class="modal-header">REPRODUCCI√ìN DE VIDEO</div>
            <div class="video-container">
                <video id="playbackVideo" controls></video>
            </div>
            <div class="video-info" id="videoInfo"></div>
            <div class="video-controls">
                <button class="toolbar-btn primary" onclick="closeVideoModal()">CERRAR</button>
            </div>
        </div>
    </div>

    <!-- Modal de ayuda b√°sica -->
    <div class="modal" id="helpModal">
        <div class="modal-content help-modal">
            <div class="modal-header">TUTORIAL Y GU√çA DE USO</div>

            <div class="help-section">
                <h3>üìã COMPONENTES DEL SISTEMA</h3>

                <div class="feature-item">
                    <div class="feature-icon">‚óè</div>
                    <div class="feature-text">
                        <strong>CONECTAR</strong>
                        Establece conexi√≥n serial con la micro:bit v√≠a USB. Usa Web Serial API del navegador.
                    </div>
                </div>

                <div class="feature-item">
                    <div class="feature-icon">‚ñ∂</div>
                    <div class="feature-text">
                        <strong>CAPTURAR / DETENER</strong>
                        Inicia y detiene la captura de datos en tiempo real. Si la c√°mara est√° activa, tambi√©n graba video sincronizado.
                    </div>
                </div>

                <div class="feature-item">
                    <div class="feature-icon">üìπ</div>
                    <div class="feature-text">
                        <strong>C√ÅMARA</strong>
                        Activa la webcam para grabar video del experimento. El video se sincroniza autom√°ticamente con los datos capturados.
                    </div>
                </div>

                <div class="feature-item">
                    <div class="feature-icon">Œ£</div>
                    <div class="feature-text">
                        <strong>ESTAD√çSTICAS</strong>
                        Calcula media, m√≠nimo, m√°ximo, desviaci√≥n est√°ndar y n√∫mero total de puntos.
                    </div>
                </div>

                <div class="feature-item">
                    <div class="feature-icon">üíæ</div>
                    <div class="feature-text">
                        <strong>EXPORTAR/IMPORTAR</strong>
                        Descarga los datos en formato CSV para an√°lisis posterior, o carga experimentos previos.
                    </div>
                </div>
            </div>

            <div class="help-section">
                <h3>‚ö° FRECUENCIA DE MUESTREO</h3>
                <p>El sistema est√° optimizado para captura en tiempo real con visualizaci√≥n fluida:</p>
                <ul>
                    <li><strong>Frecuencia m√≠nima te√≥rica:</strong> Hasta 1000 Hz (1 ms entre muestras)</li>
                    <li><strong>Frecuencia pr√°ctica recomendada:</strong> 10-100 Hz (10-100 ms entre muestras)</li>
                    <li><strong>Limitaciones principales:</strong></li>
                    <ul style="margin-left: 20px; margin-top: 8px;">
                        <li>Puerto serial USB: 115200 baudios (l√≠mite de ~11 KB/s)</li>
                        <li>Procesamiento de micro:bit: Los sensores internos tienen sus propias limitaciones</li>
                        <li>Renderizado del navegador: Optimizado para actualizar cada 50ms</li>
                    </ul>
                </ul>

                <p><strong>üìä Frecuencias recomendadas por tipo de experimento:</strong></p>
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <tr style="background: #f5f5f5; border-bottom: 2px solid black;">
                        <td style="padding: 8px; font-weight: bold;">Experimento</td>
                        <td style="padding: 8px; font-weight: bold;">Frecuencia (Hz)</td>
                        <td style="padding: 8px; font-weight: bold;">Pausa (ms)</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #ccc;">
                        <td style="padding: 8px;">Temperatura</td>
                        <td style="padding: 8px;">1-2 Hz</td>
                        <td style="padding: 8px;">500-1000</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #ccc;">
                        <td style="padding: 8px;">Luz ambiental</td>
                        <td style="padding: 8px;">5-10 Hz</td>
                        <td style="padding: 8px;">100-200</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #ccc;">
                        <td style="padding: 8px;">Aceler√≥metro (movimiento lento)</td>
                        <td style="padding: 8px;">20-50 Hz</td>
                        <td style="padding: 8px;">20-50</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #ccc;">
                        <td style="padding: 8px;">Aceler√≥metro (movimiento r√°pido)</td>
                        <td style="padding: 8px;">50-100 Hz</td>
                        <td style="padding: 8px;">10-20</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px;">Sensores externos anal√≥gicos</td>
                        <td style="padding: 8px;">10-50 Hz</td>
                        <td style="padding: 8px;">20-100</td>
                    </tr>
                </table>

                <p style="margin-top: 12px;"><strong>üí° Tip:</strong> Usa <code>basic.pause(X)</code> en JavaScript o <code>sleep(X)</code> en Python, donde X es el tiempo en milisegundos entre muestras.</p>
            </div>

            <div class="help-section">
                <h3>üöÄ FLUJO DE TRABAJO - UNA VARIABLE</h3>
                <p><span class="step-number">1</span> Conecta tu micro:bit por USB a la computadora</p>
                <p><span class="step-number">2</span> Haz clic en <strong>CONECTAR</strong> y selecciona el puerto USB</p>
                <p><span class="step-number">3</span> (Opcional) Activa la <strong>C√ÅMARA</strong> para grabar video</p>
                <p><span class="step-number">4</span> Haz clic en <strong>CAPTURAR</strong> para iniciar</p>
                <p><span class="step-number">5</span> Realiza tu experimento</p>
                <p><span class="step-number">6</span> Haz clic en <strong>DETENER</strong> cuando termines</p>
                <p><span class="step-number">7</span> Analiza los datos:</p>
                <ul>
                    <li>Click en puntos para seleccionar</li>
                    <li>Bot√≥n ‚ñ∂ en tabla para ver video en ese momento</li>
                    <li>Configura ejes y establece tiempo cero</li>
                    <li>Exporta resultados</li>
                </ul>
            </div>

            <div class="help-section">
                <h3>üíª C√ìDIGO PARA MICRO:BIT - UNA VARIABLE</h3>
                <p>Tu micro:bit debe enviar datos por serial. Aqu√≠ tienes ejemplos b√°sicos:</p>

                <strong>JavaScript (MakeCode):</strong>
                <div class="code-block">
                    <pre>// Enviar valor del aceler√≥metro
basic.forever(function () {
    serial.writeNumber(input.acceleration(Dimension.X))
    serial.writeLine("")
    basic.pause(100)  // 100ms = 10 datos/segundo
})</pre>
                </div>

                <strong>Python (MicroPython):</strong>
                <div class="code-block">
                    <pre># Enviar valor de temperatura
from microbit import *

while True:
    valor = temperature()
    print(valor)
    sleep(100)</pre>
                </div>

                <p><strong>‚ö†Ô∏è IMPORTANTE:</strong></p>
                <ul>
                    <li>Env√≠a <strong>SOLO EL N√öMERO</strong>, sin texto adicional</li>
                    <li>Usa <code>serial.writeNumber()</code> en JavaScript o <code>print()</code> en Python</li>
                    <li>Termina cada valor con salto de l√≠nea (<code>serial.writeLine("")</code> o autom√°tico con <code>print()</code>)</li>
                    <li>Ajusta <code>basic.pause()</code> o <code>sleep()</code> seg√∫n la frecuencia deseada</li>
                </ul>
            </div>

            <div class="help-section">
                <h3>üìπ VIDEO SINCRONIZADO</h3>
                <p>El sistema graba video del experimento y lo sincroniza con los datos:</p>
                <ul>
                    <li>Activa la c√°mara <strong>ANTES</strong> de capturar datos</li>
                    <li>Al hacer clic en <strong>CAPTURAR</strong>, inicia video + datos simult√°neamente</li>
                    <li>Cada dato tiene un timestamp asociado al video</li>
                    <li>Click en bot√≥n <strong>‚ñ∂</strong> en la tabla para ver ese momento exacto</li>
                    <li>El video se reproduce desde el instante del punto seleccionado</li>
                </ul>
            </div>

            <div class="help-section">
                <h3>üéØ EJEMPLOS DE SENSORES</h3>

                <strong>Aceler√≥metro (X, Y o Z):</strong>
                <div class="code-block">
                    <pre>basic.forever(function () {
    serial.writeNumber(input.acceleration(Dimension.X))
    serial.writeLine("")
    basic.pause(50)
})</pre>
                </div>

                <strong>Nivel de luz:</strong>
                <div class="code-block">
                    <pre>basic.forever(function () {
    serial.writeNumber(input.lightLevel())
    serial.writeLine("")
    basic.pause(100)
})</pre>
                </div>

                <strong>Br√∫jula (orientaci√≥n):</strong>
                <div class="code-block">
                    <pre>basic.forever(function () {
    serial.writeNumber(input.compassHeading())
    serial.writeLine("")
    basic.pause(100)
})</pre>
                </div>

                <strong>Sensor anal√≥gico (Pin P0):</strong>
                <div class="code-block">
                    <pre>basic.forever(function () {
    let valor = pins.analogReadPin(AnalogPin.P0)
    serial.writeNumber(valor)
    serial.writeLine("")
    basic.pause(100)
})</pre>
                </div>
            </div>

            <div class="help-section">
                <h3>üöÄ FUNCIONES AVANZADAS - M√öLTIPLES VARIABLES</h3>
                <p>Esta versi√≥n PRO incluye capacidades avanzadas:</p>
                <ul>
                    <li><strong>M√∫ltiples Variables:</strong> Captura hasta 3 variables simult√°neamente</li>
                    <li><strong>M√∫ltiples Gr√°ficas:</strong> Visualiza 1, 2 o 3 gr√°ficas independientes</li>
                    <li><strong>Ejes Personalizables:</strong> Grafica variable vs variable, no solo vs tiempo</li>
                    <li><strong>Colores Personalizados:</strong> Asigna colores a cada variable</li>
                    <li><strong>Toggle de L√≠neas:</strong> Activa/desactiva l√≠neas conectoras</li>
                </ul>
            </div>

            <div class="help-section">
                <h3>üì° C√ìDIGO M√öLTIPLES VARIABLES - FORMATO DE DATOS</h3>
                <p>Para enviar <strong>m√∫ltiples variables</strong>, tu micro:bit debe enviar los valores <strong>separados por comas</strong> en una sola l√≠nea.</p>

                <div class="warning-box">
                    <strong>‚ö†Ô∏è IMPORTANTE:</strong>
                    El n√∫mero de valores enviados debe coincidir con el n√∫mero de variables configurado en la aplicaci√≥n.
                </div>

                <p><strong>Pasos para configurar:</strong></p>
                <ol>
                    <li>En el panel "VARIABLES", selecciona cu√°ntas variables usar (1, 2 o 3)</li>
                    <li>Personaliza el nombre y color de cada variable</li>
                    <li>Haz clic en "APLICAR CONFIGURACI√ìN"</li>
                    <li>Programa tu micro:bit para enviar valores separados por comas</li>
                </ol>
            </div>

            <div class="help-section">
                <h3>üíª EJEMPLOS - 2 VARIABLES</h3>

                <strong>JavaScript (MakeCode):</strong>
                <div class="code-block">
                    <pre>// Ejemplo: Aceler√≥metro X e Y
basic.forever(function () {
    let accelX = input.acceleration(Dimension.X)
    let accelY = input.acceleration(Dimension.Y)

    // Enviar separados por coma
    serial.writeLine("" + accelX + "," + accelY)

    basic.pause(100)  // 100ms entre lecturas
})</pre>
                </div>

                <strong>Python (MicroPython):</strong>
                <div class="code-block">
                    <pre># Ejemplo: Temperatura y nivel de luz
from microbit import *

while True:
    temp = temperature()
    light = display.read_light_level()

    # Enviar separados por coma
    print(str(temp) + "," + str(light))

    sleep(100)</pre>
                </div>
            </div>

            <div class="help-section">
                <h3>üíª EJEMPLOS - 3 VARIABLES</h3>

                <strong>JavaScript (MakeCode):</strong>
                <div class="code-block">
                    <pre>// Ejemplo: Aceler√≥metro X, Y, Z
basic.forever(function () {
    let accelX = input.acceleration(Dimension.X)
    let accelY = input.acceleration(Dimension.Y)
    let accelZ = input.acceleration(Dimension.Z)

    // Enviar separados por coma
    serial.writeLine("" + accelX + "," + accelY + "," + accelZ)

    basic.pause(50)  // 50ms = 20 lecturas/segundo
})</pre>
                </div>

                <strong>Python (MicroPython):</strong>
                <div class="code-block">
                    <pre># Ejemplo: Aceler√≥metro completo
from microbit import *

while True:
    x = accelerometer.get_x()
    y = accelerometer.get_y()
    z = accelerometer.get_z()

    # Enviar separados por coma
    print("{},{},{}".format(x, y, z))

    sleep(50)</pre>
                </div>
            </div>

            <div class="help-section">
                <h3>üéØ EJEMPLOS PR√ÅCTICOS MULTI-VARIABLE</h3>

                <strong>Sensor de distancia + Temperatura:</strong>
                <div class="code-block">
                    <pre>// Usando sensor ultras√≥nico HC-SR04 en P0
basic.forever(function () {
    let distancia = pins.pulseIn(DigitalPin.P0, PulseValue.High)
    let temp = input.temperature()

    serial.writeLine("" + distancia + "," + temp)
    basic.pause(200)
})</pre>
                </div>

                <strong>Sensor anal√≥gico + Luz + Br√∫jula:</strong>
                <div class="code-block">
                    <pre>basic.forever(function () {
    let sensorP0 = pins.analogReadPin(AnalogPin.P0)
    let luz = input.lightLevel()
    let direccion = input.compassHeading()

    serial.writeLine("" + sensorP0 + "," + luz + "," + direccion)
    basic.pause(100)
})</pre>
                </div>
            </div>

            <div class="help-section">
                <h3>‚öôÔ∏è REQUISITOS DEL SISTEMA</h3>
                <ul>
                    <li><strong>Navegador:</strong> Chrome, Edge u Opera (con Web Serial API)</li>
                    <li><strong>Sistema:</strong> Windows, macOS o Linux</li>
                    <li><strong>Hardware:</strong> micro:bit v1 o v2 con cable USB</li>
                    <li><strong>Webcam:</strong> Opcional, para grabaci√≥n de video</li>
                    <li><strong>Conexi√≥n:</strong> No requiere internet una vez cargada la p√°gina</li>
                </ul>
            </div>

            <div class="help-section">
                <h3>‚ùì SOLUCI√ìN DE PROBLEMAS</h3>

                <p><strong>No aparece el puerto al conectar:</strong></p>
                <ul>
                    <li>Verifica que el cable USB est√© bien conectado</li>
                    <li>Prueba con otro puerto USB</li>
                    <li>Reinicia el navegador</li>
                </ul>

                <p><strong>No llegan datos:</strong></p>
                <ul>
                    <li>Aseg√∫rate de que el c√≥digo est√© corriendo en la micro:bit</li>
                    <li>Verifica que uses <code>serial.writeNumber()</code> + <code>serial.writeLine("")</code></li>
                    <li>No env√≠es texto, solo n√∫meros</li>
                </ul>

                <p><strong>La c√°mara no funciona:</strong></p>
                <ul>
                    <li>Permite el acceso a la c√°mara cuando el navegador lo solicite</li>
                    <li>Verifica que otra aplicaci√≥n no est√© usando la c√°mara</li>
                    <li>Prueba en modo inc√≥gnito del navegador</li>
                </ul>

                <p><strong>El video y los datos no coinciden:</strong></p>
                <ul>
                    <li>Activa la c√°mara ANTES de capturar datos</li>
                    <li>Ambos deben iniciar con el mismo bot√≥n CAPTURAR</li>
                </ul>
            </div>

            <button class="toolbar-btn primary modal-close" onclick="closeHelpModal()">CERRAR</button>
        </div>
    </div>

    <!-- Footer con Licencia Creative Commons -->
    <footer style="background: #f5f5f5; border-top: 2px solid #333; padding: 20px; text-align: center; font-size: 12px; margin-top: 20px;">
        <div style="max-width: 800px; margin: 0 auto;">
            <p style="margin: 8px 0; font-weight: bold; font-size: 14px;">
                Sistema de Captura y An√°lisis de Datos - micro:bit
            </p>
            <p style="margin: 8px 0;">
                Desarrollado por <strong>Martin Ferreira</strong> y <strong>Pablo Godoy</strong>
            </p>
            <p style="margin: 8px 0;">
                <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="license"
                   style="color: #0066cc; text-decoration: none; font-weight: bold;">
                    üìÑ Licencia Creative Commons BY-SA 4.0
                </a>
            </p>
            <p style="margin: 8px 0; color: #666; font-size: 11px;">
                Esta obra est√° bajo una Licencia Creative Commons Atribuci√≥n-CompartirIgual 4.0 Internacional.
                <br>
                Eres libre de compartir y adaptar este material, siempre que des cr√©dito a los autores originales
                y distribuyas tus contribuciones bajo la misma licencia.
            </p>
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #ddd;">
                <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="license">
                    <img src="https://licensebuttons.net/l/by-sa/4.0/88x31.png"
                         alt="Licencia Creative Commons"
                         style="border: 0; margin: 4px auto; display: block;">
                </a>
            </div>
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #ddd; color: #666; font-size: 11px;">
                <p style="margin: 4px 0;">
                    <strong>Librer√≠as utilizadas:</strong>
                </p>
                <p style="margin: 4px 0;">
                    ‚Ä¢ <a href="https://github.com/Tom-Alexander/regression-js" target="_blank"
                         style="color: #0066cc; text-decoration: none;">
                        regression-js
                    </a> por <strong>Tom Alexander</strong> - Ajuste de curvas por m√≠nimos cuadrados
                </p>
                <p style="margin: 4px 0;">
                    ‚Ä¢ <a href="https://www.chartjs.org/" target="_blank"
                         style="color: #0066cc; text-decoration: none;">
                        Chart.js
                    </a> - Visualizaci√≥n de gr√°ficas
                </p>
            </div>
        </div>
    </footer>

    <script>
        // Estado global
        let state = {
            port: null,
            reader: null,
            isConnected: false,
            isCollecting: false,
            rawData: [],  // Array de objetos {time, values: [v1, v2, v3], id}
            selectedPoints: new Set(),
            timeZeroOffset: 0,
            // Configuraci√≥n de variables
            numVariables: 1,
            variables: [
                { name: 'Variable 1', color: '#000000' },
                { name: 'Variable 2', color: '#ff0000' },
                { name: 'Variable 3', color: '#0000ff' }
            ],
            // Configuraci√≥n de gr√°ficas
            numGraphs: 1,
            graphs: [
                { xAxis: 'time', yVars: [0], xLabel: 'Tiempo (s)', yLabel: 'Valor' },
                { xAxis: 'time', yVars: [0], xLabel: 'Tiempo (s)', yLabel: 'Valor' },
                { xAxis: 'time', yVars: [0], xLabel: 'Tiempo (s)', yLabel: 'Valor' }
            ],
            showLines: true,
            // Video
            cameraActive: false,
            mediaStream: null,
            mediaRecorder: null,
            recordedChunks: [],
            videoBlob: null,
            recordingStartTime: null,
            // Charts
            charts: [],
            // Curve Fitting
            fitResult: null  // {type, coeffs, equation, r2, graphIndex, varIndex, dataPoints}
        };

        // ========== INICIALIZACI√ìN ==========

        if (!('serial' in navigator)) {
            alert('Web Serial API no soportada. Usa Chrome, Edge u Opera.');
        }

        // Inicializar configuraci√≥n
        initializeConfiguration();
        updateGraphsDisplay();

        // ========== CONFIGURACI√ìN DE VARIABLES ==========

        document.getElementById('numVariables').addEventListener('change', function() {
            const num = parseInt(this.value);
            document.getElementById('var1Config').classList.remove('hidden');
            document.getElementById('var2Config').classList.toggle('hidden', num < 2);
            document.getElementById('var3Config').classList.toggle('hidden', num < 3);
        });

        // Color previews
        ['var1', 'var2', 'var3'].forEach((varId, idx) => {
            const colorInput = document.getElementById(varId + 'Color');
            const preview = document.getElementById(varId + 'ColorPreview');
            colorInput.addEventListener('input', function() {
                preview.style.background = this.value;
            });
        });

        document.getElementById('applyVarConfigBtn').addEventListener('click', applyVariableConfiguration);

        function applyVariableConfiguration() {
            const num = parseInt(document.getElementById('numVariables').value);
            state.numVariables = num;

            for (let i = 0; i < 3; i++) {
                if (i < num) {
                    state.variables[i].name = document.getElementById(`var${i+1}Name`).value;
                    state.variables[i].color = document.getElementById(`var${i+1}Color`).value;
                }
            }

            updateGraphConfiguration();
            updateDataTableHeader();
            updateGraphsDisplay();
            updateFitVariableOptions();

            alert(`Configuraci√≥n aplicada: ${num} variable(s)`);
        }

        // ========== CONFIGURACI√ìN DE GR√ÅFICAS ==========

        document.getElementById('numGraphs').addEventListener('change', function() {
            const num = parseInt(this.value);
            document.getElementById('graph1Config').classList.remove('hidden');
            document.getElementById('graph2Config').classList.toggle('hidden', num < 2);
            document.getElementById('graph3Config').classList.toggle('hidden', num < 3);
        });

        document.getElementById('showLinesToggle').addEventListener('change', function() {
            state.showLines = this.checked;
            updateAllCharts();
        });

        document.getElementById('applyGraphConfigBtn').addEventListener('click', applyGraphConfiguration);

        function initializeConfiguration() {
            updateGraphConfiguration();
            updateFitVariableOptions();
            updateFitGraphOptions();
        }

        function updateGraphConfiguration() {
            // Actualizar opciones de eje X para incluir variables
            for (let g = 1; g <= 3; g++) {
                const select = document.getElementById(`graph${g}XAxis`);
                select.innerHTML = '<option value="time">Tiempo</option>';

                for (let i = 0; i < state.numVariables; i++) {
                    const option = document.createElement('option');
                    option.value = `var${i}`;
                    option.textContent = state.variables[i].name;
                    select.appendChild(option);
                }
            }

            // Actualizar checkboxes de variables en Y
            for (let g = 1; g <= 3; g++) {
                const container = document.getElementById(`graph${g}YVars`);
                container.innerHTML = '';

                for (let i = 0; i < state.numVariables; i++) {
                    const div = document.createElement('div');
                    div.className = 'checkbox-row';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `graph${g}Var${i}`;
                    checkbox.value = i;
                    checkbox.checked = (i === 0);

                    const label = document.createElement('label');
                    label.htmlFor = checkbox.id;
                    label.textContent = state.variables[i].name;

                    const colorSpan = document.createElement('span');
                    colorSpan.className = 'color-preview';
                    colorSpan.style.background = state.variables[i].color;

                    div.appendChild(checkbox);
                    div.appendChild(label);
                    label.appendChild(colorSpan);
                    container.appendChild(div);
                }
            }
        }

        function applyGraphConfiguration() {
            state.numGraphs = parseInt(document.getElementById('numGraphs').value);
            state.showLines = document.getElementById('showLinesToggle').checked;

            // Guardar configuraci√≥n de cada gr√°fica
            for (let g = 0; g < 3; g++) {
                const graphNum = g + 1;
                state.graphs[g].xAxis = document.getElementById(`graph${graphNum}XAxis`).value;
                state.graphs[g].xLabel = document.getElementById(`graph${graphNum}XLabel`).value;
                state.graphs[g].yLabel = document.getElementById(`graph${graphNum}YLabel`).value;

                // Obtener variables seleccionadas para eje Y
                const yVars = [];
                for (let i = 0; i < state.numVariables; i++) {
                    const checkbox = document.getElementById(`graph${graphNum}Var${i}`);
                    if (checkbox && checkbox.checked) {
                        yVars.push(i);
                    }
                }
                state.graphs[g].yVars = yVars;
            }

            // Limpiar ajuste de curva ya que la configuraci√≥n cambi√≥
            state.fitResult = null;
            document.getElementById('fitResults').style.display = 'none';

            updateGraphsDisplay();
            updateFitGraphOptions();
            alert('Configuraci√≥n de gr√°ficas aplicada');
        }

        function updateGraphsDisplay() {
            const container = document.getElementById('graphsContainer');
            container.innerHTML = '';
            state.charts = [];

            const classMap = { 1: 'single', 2: 'double', 3: 'triple' };

            for (let i = 0; i < state.numGraphs; i++) {
                const wrapper = document.createElement('div');
                wrapper.className = `graph-wrapper ${classMap[state.numGraphs]}`;

                const title = document.createElement('div');
                title.className = 'graph-title';
                title.id = `graphTitle${i}`;
                title.textContent = `GR√ÅFICA ${i + 1}`;

                const chartContainer = document.createElement('div');
                chartContainer.className = 'chart-container';

                const canvas = document.createElement('canvas');
                canvas.id = `chart${i}`;

                chartContainer.appendChild(canvas);
                wrapper.appendChild(title);
                wrapper.appendChild(chartContainer);
                container.appendChild(wrapper);

                // Crear chart
                createChart(i);
            }

            // Restaurar datos si existen
            if (state.rawData.length > 0) {
                updateAllCharts();
                updateDataTable();
            }
        }

        function createChart(index) {
            const canvas = document.getElementById(`chart${index}`);
            const ctx = canvas.getContext('2d');

            const chart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    onClick: (evt) => handleChartClick(evt, index),
                    plugins: {
                        legend: {
                            display: state.graphs[index].yVars.length > 1,
                            position: 'top'
                        },
                        tooltip: {
                            enabled: true,
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(4)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: state.graphs[index].xLabel.toUpperCase(),
                                font: { size: 11, weight: 'bold' }
                            },
                            grid: { color: '#e0e0e0', borderColor: '#000', borderWidth: 2 },
                            ticks: { font: { size: 10 } }
                        },
                        y: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: state.graphs[index].yLabel.toUpperCase(),
                                font: { size: 11, weight: 'bold' }
                            },
                            grid: { color: '#e0e0e0', borderColor: '#000', borderWidth: 2 },
                            ticks: { font: { size: 10 } }
                        }
                    }
                }
            });

            state.charts[index] = chart;
        }

        function updateDataTableHeader() {
            const header = document.getElementById('dataTableHeader');
            let html = '<th>#</th><th>T</th>';

            for (let i = 0; i < state.numVariables; i++) {
                html += `<th>${state.variables[i].name.substring(0, 8)}</th>`;
            }

            html += '<th>üìπ</th><th></th>';
            header.innerHTML = html;
        }

        // ========== CONEXI√ìN MICRO:BIT ==========

        document.getElementById('connectBtn').addEventListener('click', async () => {
            try {
                const filters = [
                    { usbVendorId: 0x0d28, usbProductId: 0x0204 },
                    { usbVendorId: 0x0d28 }
                ];

                state.port = await navigator.serial.requestPort({ filters });
                await state.port.open({ baudRate: 115200 });
                state.isConnected = true;

                document.getElementById('connectBtn').style.display = 'none';
                document.getElementById('collectBtn').style.display = 'inline-block';
                document.getElementById('statusText').textContent = 'CONECTADO';
            } catch (err) {
                alert('Error: ' + err.message);
            }
        });

        document.getElementById('collectBtn').addEventListener('click', () => {
            // Establecer tiempo inicial en el momento de comenzar a capturar
            // Esto hace que el primer dato tenga tiempo ‚âà 0
            state.timeZeroOffset = Date.now();

            state.isCollecting = true;
            document.getElementById('collectBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-block';
            document.getElementById('statusText').textContent = 'CAPTURANDO';

            if (state.cameraActive) {
                startVideoRecording();
            }

            startReading();
        });

        document.getElementById('stopBtn').addEventListener('click', async () => {
            state.isCollecting = false;
            stopVideoRecording();

            if (state.reader) {
                try {
                    await state.reader.cancel();
                } catch (err) {
                    console.error('Error al cancelar reader:', err);
                }
            }

            document.getElementById('collectBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('statusText').textContent = 'PAUSADO';
        });

        async function startReading() {
            try {
                const textDecoder = new TextDecoderStream();
                const readableStreamClosed = state.port.readable.pipeTo(textDecoder.writable);
                state.reader = textDecoder.readable.getReader();

                let buffer = '';
                let dataBuffer = [];
                let lastUpdate = Date.now();
                const UPDATE_INTERVAL = 50;

                while (state.isCollecting) {
                    const { value, done } = await state.reader.read();
                    if (done) break;

                    buffer += value;
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        const trimmed = line.trim();
                        if (trimmed) {
                            // Parsear valores separados por coma
                            const parts = trimmed.split(',').map(p => parseFloat(p.trim()));

                            // Verificar que tengamos el n√∫mero correcto de valores
                            if (parts.length === state.numVariables && parts.every(p => !isNaN(p))) {
                                const timestamp = Date.now();
                                const dataPoint = {
                                    time: timestamp,
                                    values: parts,
                                    id: `${timestamp}-${Math.random()}`
                                };

                                dataBuffer.push(dataPoint);

                                const now = Date.now();
                                if (now - lastUpdate >= UPDATE_INTERVAL) {
                                    state.rawData.push(...dataBuffer);
                                    dataBuffer = [];
                                    lastUpdate = now;
                                    requestAnimationFrame(() => updateDisplay());
                                }
                            }
                        }
                    }
                }

                if (dataBuffer.length > 0) {
                    state.rawData.push(...dataBuffer);
                    updateDisplay();
                }
            } catch (err) {
                if (err.name !== 'NetworkError') {
                    console.error('Error en lectura:', err);
                }
            } finally {
                if (state.reader) {
                    try {
                        state.reader.releaseLock();
                    } catch (err) {}
                }
            }
        }

        // ========== AJUSTE DE CURVAS - M√çNIMOS CUADRADOS ==========

        // Funciones auxiliares matem√°ticas
        function matrixSolve(matrix, vector) {
            // Soluci√≥n de sistema lineal Ax = b por eliminaci√≥n Gaussiana
            const n = vector.length;
            const augmented = matrix.map((row, i) => [...row, vector[i]]);

            // Forward elimination
            for (let i = 0; i < n; i++) {
                // Find pivot
                let maxRow = i;
                for (let k = i + 1; k < n; k++) {
                    if (Math.abs(augmented[k][i]) > Math.abs(augmented[maxRow][i])) {
                        maxRow = k;
                    }
                }
                [augmented[i], augmented[maxRow]] = [augmented[maxRow], augmented[i]];

                // Make all rows below this one 0 in current column
                for (let k = i + 1; k < n; k++) {
                    const factor = augmented[k][i] / augmented[i][i];
                    for (let j = i; j <= n; j++) {
                        augmented[k][j] -= factor * augmented[i][j];
                    }
                }
            }

            // Back substitution
            const solution = new Array(n);
            for (let i = n - 1; i >= 0; i--) {
                solution[i] = augmented[i][n];
                for (let j = i + 1; j < n; j++) {
                    solution[i] -= augmented[i][j] * solution[j];
                }
                solution[i] /= augmented[i][i];
            }

            return solution;
        }

        function calculateR2(xData, yData, predictFunc) {
            // Calcula coeficiente de determinaci√≥n R¬≤
            const yMean = yData.reduce((a, b) => a + b, 0) / yData.length;
            let ssRes = 0, ssTot = 0;

            for (let i = 0; i < xData.length; i++) {
                const yPred = predictFunc(xData[i]);
                ssRes += Math.pow(yData[i] - yPred, 2);
                ssTot += Math.pow(yData[i] - yMean, 2);
            }

            return 1 - (ssRes / ssTot);
        }

        // Funci√≥n para crear predictor basado en tipo y coeficientes
        function createPredictor(type, coeffs) {
            switch(type) {
                case 'linear':
                    // y = mx + b
                    return (x) => coeffs[0] * x + coeffs[1];
                case 'quadratic':
                    // y = ax¬≤ + bx + c
                    return (x) => coeffs[0] * x * x + coeffs[1] * x + coeffs[2];
                case 'cubic':
                    // y = ax¬≥ + bx¬≤ + cx + d
                    return (x) => coeffs[0] * x * x * x + coeffs[1] * x * x + coeffs[2] * x + coeffs[3];
                case 'exponential':
                    // y = a¬∑e^(bx)
                    return (x) => coeffs[0] * Math.exp(coeffs[1] * x);
                case 'power':
                    // y = a¬∑x^b
                    return (x) => coeffs[0] * Math.pow(x, coeffs[1]);
                case 'logarithmic':
                    // y = a¬∑ln(x) + b
                    return (x) => coeffs[0] * Math.log(x) + coeffs[1];
                case 'inverse':
                    // y = a/x + b
                    return (x) => coeffs[0] / x + coeffs[1];
                default:
                    return (x) => 0;
            }
        }

        // ========== AJUSTES USANDO REGRESSION-JS ==========
        // Librer√≠a: regression-js por Tom Alexander
        // https://github.com/Tom-Alexander/regression-js

        // Ajustes espec√≠ficos por tipo
        function fitLinear(xData, yData) {
            // y = mx + b usando regression.linear()
            console.log('=== AJUSTE LINEAL (regression-js) ===');
            console.log('N√∫mero de puntos:', xData.length);
            console.log('xData:', xData);
            console.log('yData:', yData);

            // Preparar datos en formato [[x, y], [x, y], ...]
            const data = xData.map((x, i) => [x, yData[i]]);
            console.log('Datos para regression-js:', data);

            // Usar regression-js para el ajuste
            const result = regression.linear(data);

            console.log('Resultado de regression-js:', result);

            // result.equation = [m, b] para y = mx + b
            const m = result.equation[0];
            const b = result.equation[1];

            console.log('Coeficientes: m =', m, ', b =', b);
            console.log('R¬≤ =', result.r2);

            const predict = (x) => m * x + b;
            const equation = `y = ${m.toFixed(4)}x ${b >= 0 ? '+' : ''} ${b.toFixed(4)}`;

            console.log('Ecuaci√≥n:', equation);
            console.log('=== FIN AJUSTE LINEAL ===');

            return { coeffs: [m, b], equation, r2: result.r2, predict };
        }

        function fitQuadratic(xData, yData) {
            // y = ax¬≤ + bx + c usando regression.polynomial(data, 2)
            console.log('=== AJUSTE CUADR√ÅTICO (regression-js) ===');

            const data = xData.map((x, i) => [x, yData[i]]);
            const result = regression.polynomial(data, 2);

            // result.equation = [a, b, c] para y = ax¬≤ + bx + c
            const a = result.equation[0];
            const b = result.equation[1];
            const c = result.equation[2];

            console.log('Coeficientes:', { a, b, c });
            console.log('R¬≤ =', result.r2);

            const predict = (x) => a * x * x + b * x + c;
            const equation = `y = ${a.toFixed(4)}x¬≤ ${b >= 0 ? '+' : ''} ${b.toFixed(4)}x ${c >= 0 ? '+' : ''} ${c.toFixed(4)}`;

            return { coeffs: [a, b, c], equation, r2: result.r2, predict };
        }

        function fitCubic(xData, yData) {
            // y = ax¬≥ + bx¬≤ + cx + d usando regression.polynomial(data, 3)
            console.log('=== AJUSTE C√öBICO (regression-js) ===');

            const data = xData.map((x, i) => [x, yData[i]]);
            const result = regression.polynomial(data, 3);

            // result.equation = [a, b, c, d] para y = ax¬≥ + bx¬≤ + cx + d
            const a = result.equation[0];
            const b = result.equation[1];
            const c = result.equation[2];
            const d = result.equation[3];

            console.log('Coeficientes:', { a, b, c, d });
            console.log('R¬≤ =', result.r2);

            const predict = (x) => a * x * x * x + b * x * x + c * x + d;
            const equation = `y = ${a.toFixed(4)}x¬≥ ${b >= 0 ? '+' : ''} ${b.toFixed(4)}x¬≤ ${c >= 0 ? '+' : ''} ${c.toFixed(4)}x ${d >= 0 ? '+' : ''} ${d.toFixed(4)}`;

            return { coeffs: [a, b, c, d], equation, r2: result.r2, predict };
        }

        function fitExponential(xData, yData) {
            // y = a¬∑e^(bx) usando regression.exponential()
            console.log('=== AJUSTE EXPONENCIAL (regression-js) ===');

            // Verificar que todos los y > 0
            if (yData.some(y => y <= 0)) {
                throw new Error('Datos insuficientes para ajuste exponencial (requiere y > 0)');
            }

            const data = xData.map((x, i) => [x, yData[i]]);
            const result = regression.exponential(data);

            // result.equation = [a, b] para y = a¬∑e^(bx)
            const a = result.equation[0];
            const b = result.equation[1];

            console.log('Coeficientes:', { a, b });
            console.log('R¬≤ =', result.r2);

            const predict = (x) => a * Math.exp(b * x);
            const equation = `y = ${a.toFixed(4)}¬∑e^(${b.toFixed(4)}x)`;

            return { coeffs: [a, b], equation, r2: result.r2, predict };
        }

        function fitPower(xData, yData) {
            // y = a¬∑x^b usando regression.power()
            console.log('=== AJUSTE POTENCIA (regression-js) ===');

            // Verificar que todos los x > 0 y y > 0
            if (xData.some(x => x <= 0) || yData.some(y => y <= 0)) {
                throw new Error('Datos insuficientes para ajuste potencia (requiere x > 0, y > 0)');
            }

            const data = xData.map((x, i) => [x, yData[i]]);
            const result = regression.power(data);

            // result.equation = [a, b] para y = a¬∑x^b
            const a = result.equation[0];
            const b = result.equation[1];

            console.log('Coeficientes:', { a, b });
            console.log('R¬≤ =', result.r2);

            const predict = (x) => a * Math.pow(x, b);
            const equation = `y = ${a.toFixed(4)}¬∑x^${b.toFixed(4)}`;

            return { coeffs: [a, b], equation, r2: result.r2, predict };
        }

        function fitLogarithmic(xData, yData) {
            // y = a¬∑ln(x) + b usando regression.logarithmic()
            console.log('=== AJUSTE LOGAR√çTMICO (regression-js) ===');

            // Verificar que todos los x > 0
            if (xData.some(x => x <= 0)) {
                throw new Error('Datos insuficientes para ajuste logar√≠tmico (requiere x > 0)');
            }

            const data = xData.map((x, i) => [x, yData[i]]);
            const result = regression.logarithmic(data);

            // result.equation = [a, b] para y = a¬∑ln(x) + b
            const a = result.equation[0];
            const b = result.equation[1];

            console.log('Coeficientes:', { a, b });
            console.log('R¬≤ =', result.r2);

            const predict = (x) => a * Math.log(x) + b;
            const equation = `y = ${a.toFixed(4)}¬∑ln(x) ${b >= 0 ? '+' : ''} ${b.toFixed(4)}`;

            return { coeffs: [a, b], equation, r2: result.r2, predict };
        }

        function fitInverse(xData, yData) {
            // y = a/x + b
            const validPoints = [];
            for (let i = 0; i < xData.length; i++) {
                if (xData[i] !== 0) {
                    validPoints.push({ x: xData[i], y: yData[i], invX: 1 / xData[i] });
                }
            }

            if (validPoints.length < 2) {
                throw new Error('Datos insuficientes para ajuste inverso (requiere x ‚â† 0)');
            }

            const xTransformed = validPoints.map(p => p.invX);
            const yOriginal = validPoints.map(p => p.y);

            const linearFit = fitLinear(xTransformed, yOriginal);
            const a = linearFit.coeffs[0];
            const b = linearFit.coeffs[1];

            const predict = (x) => a / x + b;
            const r2 = calculateR2(xData, yData, predict);

            const equation = `y = ${a.toFixed(4)}/x ${b >= 0 ? '+' : ''} ${b.toFixed(4)}`;

            return { coeffs: [a, b], equation, r2, predict };
        }

        // Funci√≥n principal para realizar ajuste
        function performCurveFit(fitType, xData, yData) {
            if (xData.length < 2 || yData.length < 2 || xData.length !== yData.length) {
                throw new Error('Datos insuficientes o inconsistentes para ajuste');
            }

            let result;
            switch (fitType) {
                case 'linear':
                    result = fitLinear(xData, yData);
                    break;
                case 'quadratic':
                    result = fitQuadratic(xData, yData);
                    break;
                case 'cubic':
                    result = fitCubic(xData, yData);
                    break;
                case 'exponential':
                    result = fitExponential(xData, yData);
                    break;
                case 'power':
                    result = fitPower(xData, yData);
                    break;
                case 'logarithmic':
                    result = fitLogarithmic(xData, yData);
                    break;
                case 'inverse':
                    result = fitInverse(xData, yData);
                    break;
                default:
                    throw new Error('Tipo de ajuste no reconocido');
            }

            return {
                type: fitType,
                coeffs: result.coeffs,
                equation: result.equation,
                r2: result.r2,
                predict: result.predict
            };
        }

        // ========== ACTUALIZACI√ìN DE DISPLAY ==========

        let updateScheduled = false;

        function updateDisplay() {
            if (updateScheduled) return;
            updateScheduled = true;

            requestAnimationFrame(() => {
                updateAllCharts();
                updateDataTable();

                document.getElementById('exportBtn').disabled = state.rawData.length === 0;
                document.getElementById('setZeroBtn').disabled = state.selectedPoints.size !== 1;

                updateScheduled = false;
            });
        }

        function updateAllCharts() {
            const timeUnitValue = parseFloat(document.getElementById('timeUnit').value);

            for (let i = 0; i < state.numGraphs; i++) {
                updateChart(i, timeUnitValue);
            }
        }

        function updateChart(index, timeUnitValue) {
            const chart = state.charts[index];
            const config = state.graphs[index];

            // Actualizar t√≠tulo
            document.getElementById(`graphTitle${index}`).textContent =
                `${config.yLabel.toUpperCase()} vs ${config.xLabel.toUpperCase()}`;

            // Actualizar etiquetas de ejes
            chart.options.scales.x.title.text = config.xLabel.toUpperCase();
            chart.options.scales.y.title.text = config.yLabel.toUpperCase();

            // Preparar datasets
            chart.data.datasets = [];

            for (const varIdx of config.yVars) {
                const data = state.rawData.map(d => {
                    let xVal;
                    if (config.xAxis === 'time') {
                        xVal = (d.time - state.timeZeroOffset) / timeUnitValue;
                    } else {
                        const xVarIdx = parseInt(config.xAxis.replace('var', ''));
                        xVal = d.values[xVarIdx];
                    }

                    return {
                        x: xVal,
                        y: d.values[varIdx],
                        id: d.id
                    };
                });

                const pointColors = data.map(d =>
                    state.selectedPoints.has(d.id) ? '#ff0000' : state.variables[varIdx].color
                );

                const pointSizes = data.map(d =>
                    state.selectedPoints.has(d.id) ? 6 : 3
                );

                chart.data.datasets.push({
                    label: state.variables[varIdx].name,
                    data: data,
                    borderColor: state.variables[varIdx].color,
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    pointRadius: pointSizes,
                    pointHoverRadius: 5,
                    pointBackgroundColor: pointColors,
                    pointBorderColor: pointColors,
                    showLine: state.showLines,
                    tension: 0
                });
            }

            // Agregar curva de ajuste si existe y corresponde a esta gr√°fica
            if (state.fitResult && state.fitResult.graphIndex === index) {
                console.log('=== DIBUJANDO CURVA DE AJUSTE ===');
                console.log('Tipo de ajuste:', state.fitResult.type);
                console.log('Coeficientes:', state.fitResult.coeffs);
                console.log('Ecuaci√≥n:', state.fitResult.equation);

                // Obtener rango de datos X
                const xValues = state.rawData.map(d => {
                    if (config.xAxis === 'time') {
                        return (d.time - state.timeZeroOffset) / timeUnitValue;
                    } else {
                        const xVarIdx = parseInt(config.xAxis.replace('var', ''));
                        return d.values[xVarIdx];
                    }
                });

                const xMin = Math.min(...xValues);
                const xMax = Math.max(...xValues);

                console.log('Rango X para curva:', { xMin, xMax });

                // RECREAR la funci√≥n predict bas√°ndose en tipo y coeficientes
                // Esto evita problemas de scope y serializaci√≥n
                const predict = createPredictor(state.fitResult.type, state.fitResult.coeffs);

                // Generar puntos para la curva de ajuste
                // Usar muchos puntos para que curvas complejas se vean suaves
                // pero siguiendo exactamente la ecuaci√≥n matem√°tica
                const numPoints = 300;
                const fitData = [];
                for (let i = 0; i <= numPoints; i++) {
                    const x = xMin + (xMax - xMin) * i / numPoints;
                    const y = predict(x);
                    fitData.push({ x, y });
                }

                console.log('Primeros 5 puntos de la curva:', fitData.slice(0, 5));
                console.log('√öltimos 5 puntos de la curva:', fitData.slice(-5));

                // Agregar dataset de la curva de ajuste
                chart.data.datasets.push({
                    label: `Ajuste: ${state.fitResult.equation}`,
                    data: fitData,
                    borderColor: '#ff00ff',
                    backgroundColor: 'transparent',
                    borderWidth: 3,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    pointHoverRadius: 0,
                    showLine: true,
                    tension: 0  // Sin tensi√≥n: la l√≠nea sigue EXACTAMENTE la ecuaci√≥n matem√°tica
                });

                console.log('=== FIN DIBUJANDO CURVA ===');
            }

            chart.update('none');
        }

        function updateDataTable() {
            const tbody = document.getElementById('dataTableBody');
            const timeUnitValue = parseFloat(document.getElementById('timeUnit').value);
            const searchTerm = document.getElementById('tableSearch').value.toLowerCase();
            const filter = document.getElementById('tableFilter').value;

            if (state.rawData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px;">SIN DATOS</td></tr>';
                return;
            }

            let filteredData = state.rawData.filter((d, idx) => {
                // Filtro de selecci√≥n
                if (filter === 'selected' && !state.selectedPoints.has(d.id)) {
                    return false;
                }

                // Filtro de b√∫squeda
                if (searchTerm) {
                    const adjustedTime = ((d.time - state.timeZeroOffset) / timeUnitValue).toFixed(3);
                    const rowText = `${idx + 1} ${adjustedTime} ${d.values.join(' ')}`.toLowerCase();
                    return rowText.includes(searchTerm);
                }

                return true;
            });

            tbody.innerHTML = filteredData.map((d, displayIdx) => {
                const originalIdx = state.rawData.indexOf(d);
                const adjustedTime = (d.time - state.timeZeroOffset) / timeUnitValue;

                let valuesHtml = '';
                for (let i = 0; i < state.numVariables; i++) {
                    valuesHtml += `
                        <td>
                            <input type="number" value="${d.values[i]}"
                                   onchange="editValue('${d.id}', ${i}, this.value)"
                                   onclick="event.stopPropagation()" step="0.01">
                        </td>
                    `;
                }

                return `
                    <tr class="${state.selectedPoints.has(d.id) ? 'selected' : ''}" onclick="toggleSelect('${d.id}')">
                        <td>${originalIdx + 1}</td>
                        <td>${adjustedTime.toFixed(3)}</td>
                        ${valuesHtml}
                        <td>
                            <button class="toolbar-btn"
                                    style="padding: 2px 6px; font-size: 0.8rem; border: 1px solid black;"
                                    onclick="showVideoForPoint('${d.id}'); event.stopPropagation()">
                                ‚ñ∂
                            </button>
                        </td>
                        <td>
                            <button class="delete-btn" onclick="deletePoint('${d.id}'); event.stopPropagation()">
                                √ó
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ========== INTERACCI√ìN CON DATOS ==========

        function toggleSelect(id) {
            if (state.selectedPoints.has(id)) {
                state.selectedPoints.delete(id);
            } else {
                state.selectedPoints.add(id);
            }

            if (state.selectedPoints.size === 1) {
                const selectedId = Array.from(state.selectedPoints)[0];
                const selectedIndex = state.rawData.findIndex(d => d.id === selectedId);
                document.getElementById('pointInfo').textContent = `PUNTO #${selectedIndex + 1} SELECCIONADO`;
                document.getElementById('pointInfo').style.display = 'inline-block';
            } else if (state.selectedPoints.size > 1) {
                document.getElementById('pointInfo').textContent = `${state.selectedPoints.size} PUNTOS SELECCIONADOS`;
                document.getElementById('pointInfo').style.display = 'inline-block';
            } else {
                document.getElementById('pointInfo').style.display = 'none';
            }

            updateDisplay();
        }

        function editValue(id, varIndex, newValue) {
            const point = state.rawData.find(d => d.id === id);
            if (point) {
                point.values[varIndex] = parseFloat(newValue) || point.values[varIndex];
                updateDisplay();
            }
        }

        function deletePoint(id) {
            state.rawData = state.rawData.filter(d => d.id !== id);
            state.selectedPoints.delete(id);
            updateDisplay();
        }

        function handleChartClick(evt, chartIndex) {
            const chart = state.charts[chartIndex];
            const points = chart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);

            if (points.length > 0) {
                const datasetIndex = points[0].datasetIndex;
                const dataIndex = points[0].index;
                const dataset = chart.data.datasets[datasetIndex];
                const pointId = dataset.data[dataIndex].id;

                if (pointId) {
                    toggleSelect(pointId);
                }
            }
        }

        // ========== TABLA - B√öSQUEDA Y FILTROS ==========

        document.getElementById('tableSearch').addEventListener('input', updateDataTable);
        document.getElementById('tableFilter').addEventListener('change', updateDataTable);

        // ========== ESTABLECER TIEMPO CERO ==========

        document.getElementById('setZeroBtn').addEventListener('click', () => {
            if (state.selectedPoints.size === 1) {
                const selectedId = Array.from(state.selectedPoints)[0];
                const point = state.rawData.find(d => d.id === selectedId);
                if (point) {
                    state.timeZeroOffset = point.time;
                    updateDisplay();
                }
            }
        });

        document.getElementById('timeUnit').addEventListener('change', updateDisplay);

        // ========== DEPURACI√ìN DE DATOS ==========

        // Habilitar/deshabilitar botones seg√∫n datos disponibles
        function updateDebugButtons() {
            const hasData = state.rawData.length > 0;
            const hasSelection = state.selectedPoints.size > 0;
            const from = parseInt(document.getElementById('deleteRangeFrom').value);
            const to = parseInt(document.getElementById('deleteRangeTo').value);
            const hasValidRange = !isNaN(from) && !isNaN(to) && from > 0 && to > 0 && from <= to && to <= state.rawData.length;

            document.getElementById('deleteRangeBtn').disabled = !hasData || !hasValidRange;
            document.getElementById('deleteSelectedBtn').disabled = !hasSelection;
            document.getElementById('clearSelectionBtn').disabled = !hasSelection;
        }

        // Actualizar botones cuando cambien los inputs
        document.getElementById('deleteRangeFrom').addEventListener('input', updateDebugButtons);
        document.getElementById('deleteRangeTo').addEventListener('input', updateDebugButtons);

        // Eliminar rango
        document.getElementById('deleteRangeBtn').addEventListener('click', () => {
            const from = parseInt(document.getElementById('deleteRangeFrom').value);
            const to = parseInt(document.getElementById('deleteRangeTo').value);

            if (from && to && from <= to) {
                const fromIdx = from - 1;
                const toIdx = to - 1;

                if (fromIdx >= 0 && toIdx < state.rawData.length) {
                    const pointsToRemove = state.rawData.slice(fromIdx, toIdx + 1);
                    pointsToRemove.forEach(p => state.selectedPoints.delete(p.id));
                    state.rawData.splice(fromIdx, toIdx - fromIdx + 1);

                    document.getElementById('deleteRangeFrom').value = '';
                    document.getElementById('deleteRangeTo').value = '';

                    updateDisplay();
                    updateDebugButtons();
                }
            }
        });

        // Eliminar seleccionados
        document.getElementById('deleteSelectedBtn').addEventListener('click', () => {
            if (state.selectedPoints.size > 0) {
                const idsToDelete = Array.from(state.selectedPoints);
                state.rawData = state.rawData.filter(d => !idsToDelete.includes(d.id));
                state.selectedPoints.clear();
                document.getElementById('pointInfo').style.display = 'none';

                updateDisplay();
                updateDebugButtons();
            }
        });

        // Limpiar selecci√≥n
        document.getElementById('clearSelectionBtn').addEventListener('click', () => {
            state.selectedPoints.clear();
            document.getElementById('pointInfo').style.display = 'none';
            updateDisplay();
            updateDebugButtons();
        });

        // Actualizar botones con cada cambio en los datos
        const originalUpdateDisplay = updateDisplay;
        updateDisplay = function() {
            originalUpdateDisplay();
            updateDebugButtons();
            updateCurveFitButtons();
        };

        // ========== AJUSTE DE CURVAS - CONTROLES ==========

        function updateCurveFitButtons() {
            const hasData = state.rawData.length >= 2;
            const hasSelection = state.selectedPoints.size >= 2;
            const fitModeChecked = document.querySelector('input[name="fitMode"]:checked');
            const fitMode = fitModeChecked ? fitModeChecked.value : 'all';

            let canPerformFit = hasData;

            if (fitMode === 'selected') {
                // Necesita puntos seleccionados
                canPerformFit = hasSelection;
            } else if (fitMode === 'range') {
                // Necesita rango v√°lido
                const from = parseInt(document.getElementById('fitRangeFrom').value);
                const to = parseInt(document.getElementById('fitRangeTo').value);
                canPerformFit = hasData && from >= 1 && to >= 1 && from <= to &&
                                from <= state.rawData.length && to <= state.rawData.length &&
                                (to - from + 1) >= 2; // Al menos 2 puntos en el rango
            }

            document.getElementById('performFitBtn').disabled = !canPerformFit;
            document.getElementById('clearFitBtn').disabled = !state.fitResult;
        }

        function updateFitVariableOptions() {
            const select = document.getElementById('fitVariable');
            select.innerHTML = '';
            for (let i = 0; i < state.numVariables; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = state.variables[i].name;
                select.appendChild(option);
            }
        }

        function updateFitGraphOptions() {
            const select = document.getElementById('fitGraphSelect');
            select.innerHTML = '';
            for (let i = 0; i < state.numGraphs; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Gr√°fica ${i + 1}`;
                select.appendChild(option);
            }
        }

        // Event handlers para curve fitting
        // Mostrar/ocultar inputs de rango seg√∫n modo seleccionado
        document.querySelectorAll('input[name="fitMode"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const rangeInputs = document.getElementById('fitRangeInputs');
                rangeInputs.style.display = this.value === 'range' ? 'block' : 'none';
                updateCurveFitButtons();
            });
        });

        // Actualizar botones cuando cambien los inputs de rango
        document.getElementById('fitRangeFrom').addEventListener('input', updateCurveFitButtons);
        document.getElementById('fitRangeTo').addEventListener('input', updateCurveFitButtons);

        document.getElementById('performFitBtn').addEventListener('click', () => {
            try {
                const fitType = document.getElementById('fitType').value;
                const varIndex = parseInt(document.getElementById('fitVariable').value);
                const graphIndex = parseInt(document.getElementById('fitGraphSelect').value);
                const fitMode = document.querySelector('input[name="fitMode"]:checked').value;

                // Obtener configuraci√≥n del gr√°fico seleccionado
                const graphConfig = state.graphs[graphIndex];

                // Preparar datos seg√∫n el modo seleccionado
                let dataToFit = state.rawData;

                if (fitMode === 'selected') {
                    // Solo puntos seleccionados manualmente
                    dataToFit = state.rawData.filter(d => state.selectedPoints.has(d.id));
                } else if (fitMode === 'range') {
                    // Rango de puntos
                    const from = parseInt(document.getElementById('fitRangeFrom').value);
                    const to = parseInt(document.getElementById('fitRangeTo').value);

                    if (!from || !to || from < 1 || to < 1 || from > to) {
                        alert('Por favor ingresa un rango v√°lido (desde ‚â§ hasta)');
                        return;
                    }

                    if (from > state.rawData.length || to > state.rawData.length) {
                        alert(`El rango excede el n√∫mero de datos (m√°ximo: ${state.rawData.length})`);
                        return;
                    }

                    // Extraer el rango (los √≠ndices son base-1, convertir a base-0)
                    const fromIdx = from - 1;
                    const toIdx = to - 1;
                    dataToFit = state.rawData.slice(fromIdx, toIdx + 1);

                    console.log(`Ajustando rango: puntos ${from} a ${to} (${dataToFit.length} puntos)`);
                }
                // Si fitMode === 'all', dataToFit ya es state.rawData

                if (dataToFit.length < 2) {
                    alert('Necesitas al menos 2 puntos de datos para realizar el ajuste');
                    return;
                }

                // Extraer datos X e Y seg√∫n configuraci√≥n del gr√°fico
                const timeUnit = parseFloat(document.getElementById('timeUnit').value);
                let xData, yData;

                if (graphConfig.xAxis === 'time') {
                    // Eje X es tiempo
                    xData = dataToFit.map(d => (d.time - state.timeZeroOffset) / timeUnit);
                    yData = dataToFit.map(d => d.values[varIndex]);
                } else {
                    // Eje X es otra variable
                    const xVarIndex = parseInt(graphConfig.xAxis.replace('var', ''));
                    xData = dataToFit.map(d => d.values[xVarIndex]);
                    yData = dataToFit.map(d => d.values[varIndex]);
                }

                // Debug: verificar que los datos son v√°lidos
                console.log('Datos para ajuste:', { fitType, xData, yData, varIndex, graphConfig });

                if (xData.some(x => isNaN(x)) || yData.some(y => isNaN(y))) {
                    alert('Error: Datos inv√°lidos detectados. Verifica la configuraci√≥n de la gr√°fica.');
                    console.error('Datos inv√°lidos:', { xData, yData });
                    return;
                }

                // Realizar ajuste
                const fitResult = performCurveFit(fitType, xData, yData);

                // Guardar resultado en estado
                state.fitResult = {
                    ...fitResult,
                    graphIndex: graphIndex,
                    varIndex: varIndex,
                    xAxis: graphConfig.xAxis,
                    dataPoints: dataToFit.length
                };

                // Mostrar resultados
                document.getElementById('fitResults').style.display = 'block';
                document.getElementById('fitEquation').textContent = fitResult.equation;
                document.getElementById('fitR2').textContent = fitResult.r2.toFixed(6);
                document.getElementById('fitPoints').textContent = dataToFit.length;

                // Actualizar gr√°fico con la curva de ajuste
                updateAllCharts();
                updateCurveFitButtons();

            } catch (error) {
                alert('Error al realizar el ajuste: ' + error.message);
                console.error('Error en curve fit:', error);
            }
        });

        document.getElementById('clearFitBtn').addEventListener('click', () => {
            state.fitResult = null;
            document.getElementById('fitResults').style.display = 'none';
            updateAllCharts();
            updateCurveFitButtons();
        });

        // ========== ESTAD√çSTICAS ==========

        document.getElementById('statsBtn').addEventListener('click', () => {
            if (state.rawData.length === 0) {
                alert('No hay datos');
                return;
            }

            let statsHtml = '';

            for (let i = 0; i < state.numVariables; i++) {
                const values = state.rawData.map(d => d.values[i]);
                const mean = values.reduce((a, b) => a + b, 0) / values.length;
                const min = Math.min(...values);
                const max = Math.max(...values);
                const stdDev = Math.sqrt(values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length);

                statsHtml += `
                    <strong>${state.variables[i].name}:</strong><br>
                    MEDIA: ${mean.toFixed(4)}<br>
                    M√çNIMO: ${min.toFixed(4)}<br>
                    M√ÅXIMO: ${max.toFixed(4)}<br>
                    DESV. EST: ${stdDev.toFixed(4)}<br>
                    <br>
                `;
            }

            statsHtml += `PUNTOS TOTALES: ${state.rawData.length}`;

            document.getElementById('statsBody').innerHTML = statsHtml;
            document.getElementById('statsModal').classList.add('active');
        });

        function closeStatsModal() {
            document.getElementById('statsModal').classList.remove('active');
        }

        // ========== EXPORTAR/IMPORTAR ==========

        document.getElementById('exportBtn').addEventListener('click', () => {
            const timeUnitValue = parseFloat(document.getElementById('timeUnit').value);

            // Header
            let header = 'Tiempo';
            for (let i = 0; i < state.numVariables; i++) {
                header += ',' + state.variables[i].name;
            }

            // Datos
            const dataRows = state.rawData.map(d => {
                const adjustedTime = (d.time - state.timeZeroOffset) / timeUnitValue;
                let row = adjustedTime.toFixed(6);
                for (let i = 0; i < state.numVariables; i++) {
                    row += ',' + d.values[i].toFixed(6);
                }
                return row;
            }).join('\n');

            const csv = header + '\n' + dataRows;

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;

            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            a.download = `microbit_data_${timestamp}.csv`;

            a.click();
            URL.revokeObjectURL(url);
        });

        document.getElementById('importBtn').addEventListener('click', () => {
            document.getElementById('importFile').click();
        });

        document.getElementById('importFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const csv = event.target.result;
                    const lines = csv.split('\n');

                    if (lines.length < 2) {
                        alert('Archivo CSV vac√≠o o inv√°lido');
                        return;
                    }

                    // Parsear header
                    const header = lines[0].split(',').map(h => h.trim());
                    const numVars = header.length - 1; // Menos la columna de tiempo

                    if (numVars < 1 || numVars > 3) {
                        alert('El CSV debe tener entre 1 y 3 variables (m√°s la columna de tiempo)');
                        return;
                    }

                    // Parsear datos
                    const importedData = [];
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;

                        const parts = line.split(',').map(p => parseFloat(p.trim()));
                        if (parts.length !== numVars + 1 || parts.some(p => isNaN(p))) continue;

                        const [time, ...values] = parts;

                        // Convertir tiempo relativo a timestamp
                        const timeUnitValue = parseFloat(document.getElementById('timeUnit').value);
                        const timestamp = Date.now() + (time * timeUnitValue);

                        importedData.push({
                            time: timestamp,
                            values: values,
                            id: `${timestamp}-${Math.random()}`
                        });
                    }

                    if (importedData.length === 0) {
                        alert('No se pudieron importar datos v√°lidos');
                        return;
                    }

                    // Configurar variables seg√∫n el CSV
                    document.getElementById('numVariables').value = numVars;
                    document.getElementById('numVariables').dispatchEvent(new Event('change'));

                    for (let i = 0; i < numVars; i++) {
                        if (header[i + 1]) {
                            document.getElementById(`var${i+1}Name`).value = header[i + 1];
                        }
                    }

                    // Aplicar configuraci√≥n y cargar datos
                    applyVariableConfiguration();
                    state.rawData = importedData;
                    updateDisplay();

                    alert(`Se importaron ${importedData.length} puntos con ${numVars} variable(s)`);
                } catch (err) {
                    alert('Error al importar CSV: ' + err.message);
                }
            };

            reader.readAsText(file);
            e.target.value = ''; // Reset input
        });

        // ========== LIMPIAR ==========

        document.getElementById('clearBtn').addEventListener('click', () => {
            if (confirm('¬øEliminar todos los datos y video?')) {
                state.rawData = [];
                state.selectedPoints.clear();
                state.timeZeroOffset = 0;
                state.videoBlob = null;
                state.recordedChunks = [];
                document.getElementById('pointInfo').style.display = 'none';
                updateDisplay();
            }
        });

        // ========== C√ÅMARA Y VIDEO ==========

        document.getElementById('cameraBtn').addEventListener('click', async () => {
            if (!state.cameraActive) {
                try {
                    state.mediaStream = await navigator.mediaDevices.getUserMedia({
                        video: true,
                        audio: false
                    });
                    document.getElementById('cameraPreview').srcObject = state.mediaStream;
                    state.cameraActive = true;
                    document.getElementById('videoSection').style.display = 'block';
                    document.getElementById('cameraBtn').classList.add('primary');
                } catch (err) {
                    alert('No se pudo acceder a la c√°mara: ' + err.message);
                }
            }
        });

        document.getElementById('stopCameraBtn').addEventListener('click', () => {
            stopCamera();
        });

        function stopCamera() {
            if (state.mediaStream) {
                state.mediaStream.getTracks().forEach(track => track.stop());
                state.mediaStream = null;
                document.getElementById('cameraPreview').srcObject = null;
            }
            state.cameraActive = false;
            document.getElementById('videoSection').style.display = 'none';
            document.getElementById('cameraBtn').classList.remove('primary');

            if (state.mediaRecorder && state.mediaRecorder.state === 'recording') {
                state.mediaRecorder.stop();
            }
        }

        function startVideoRecording() {
            if (!state.cameraActive || !state.mediaStream) return;

            state.recordedChunks = [];
            state.recordingStartTime = Date.now();

            state.mediaRecorder = new MediaRecorder(state.mediaStream, {
                mimeType: 'video/webm;codecs=vp9'
            });

            state.mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    state.recordedChunks.push(event.data);
                }
            };

            state.mediaRecorder.onstop = () => {
                state.videoBlob = new Blob(state.recordedChunks, { type: 'video/webm' });
            };

            state.mediaRecorder.start();
            document.getElementById('recordingIndicator').classList.add('active');
        }

        function stopVideoRecording() {
            if (state.mediaRecorder && state.mediaRecorder.state === 'recording') {
                state.mediaRecorder.stop();
                document.getElementById('recordingIndicator').classList.remove('active');
            }
        }

        function showVideoForPoint(id) {
            const point = state.rawData.find(d => d.id === id);
            if (!point) return;

            if (!state.videoBlob) {
                alert('No hay video grabado para este experimento');
                return;
            }

            const timeUnitValue = parseFloat(document.getElementById('timeUnit').value);
            const adjustedTime = (point.time - state.timeZeroOffset) / timeUnitValue;
            const videoTime = (point.time - state.recordingStartTime) / 1000;

            if (videoTime < 0) {
                alert('Este punto fue capturado antes de iniciar la grabaci√≥n');
                return;
            }

            const videoURL = URL.createObjectURL(state.videoBlob);
            const playbackVideo = document.getElementById('playbackVideo');
            playbackVideo.src = videoURL;
            playbackVideo.currentTime = videoTime;

            let valuesText = '';
            for (let i = 0; i < state.numVariables; i++) {
                valuesText += `${state.variables[i].name}: ${point.values[i].toFixed(4)}<br>`;
            }

            document.getElementById('videoInfo').innerHTML = `
                TIEMPO: ${adjustedTime.toFixed(3)} s<br>
                ${valuesText}
                VIDEO EN: ${videoTime.toFixed(2)} segundos
            `;

            document.getElementById('videoModal').classList.add('active');
        }

        function closeVideoModal() {
            document.getElementById('videoModal').classList.remove('active');
            document.getElementById('playbackVideo').pause();
            document.getElementById('playbackVideo').src = '';
        }

        // ========== AYUDA ==========

        document.getElementById('helpBtn').addEventListener('click', () => {
            document.getElementById('helpModal').classList.add('active');
        });

        function closeHelpModal() {
            document.getElementById('helpModal').classList.remove('active');
        }

        // ========== UTILIDADES ==========

        function toggleSection(header) {
            const content = header.nextElementSibling;
            const arrow = header.querySelector('span');

            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                arrow.textContent = '‚ñº';
            } else {
                content.classList.add('collapsed');
                arrow.textContent = '‚ñ∂';
            }
        }

        // Cerrar modales con ESC o click fuera
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeStatsModal();
                closeVideoModal();
                closeHelpModal();
            }
        });

        ['statsModal', 'videoModal', 'helpModal'].forEach(modalId => {
            document.getElementById(modalId).addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    if (modalId === 'statsModal') closeStatsModal();
                    if (modalId === 'videoModal') closeVideoModal();
                    if (modalId === 'helpModal') closeHelpModal();
                }
            });
        });
    </script>
</body>
</html>
