<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>micro:bit DataLab Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- regression-js: Librer√≠a para ajuste de curvas por m√≠nimos cuadrados -->
    <!-- Autor: Tom Alexander - https://github.com/Tom-Alexander/regression-js -->
    <script src="https://cdn.jsdelivr.net/npm/regression@2.0.1/dist/regression.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: white;
            color: #000;
        }

        /* Toolbar minimalista */
        .toolbar {
            background: white;
            border-bottom: 2px solid black;
            padding: 12px 16px;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .toolbar-btn {
            background: white;
            border: 2px solid black;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .toolbar-btn:hover:not(:disabled) {
            background: black;
            color: white;
        }

        .toolbar-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .toolbar-btn.primary {
            background: black;
            color: white;
        }

        .toolbar-btn.primary:hover:not(:disabled) {
            background: #333;
        }

        .toolbar-btn.success {
            background: #2e7d32;
            color: white;
            border-color: #2e7d32;
        }

        .toolbar-btn.success:hover:not(:disabled) {
            background: #1b5e20;
        }

        .toolbar-separator {
            width: 2px;
            height: 24px;
            background: black;
            margin: 0 4px;
        }

        .status-text {
            margin-left: auto;
            font-size: 0.9rem;
            font-weight: 500;
            padding: 8px 16px;
            border: 2px solid black;
        }

        /* Layout principal */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 340px;
            height: calc(100vh - 58px);
        }

        /* Panel de gr√°ficas */
        .graph-panel {
            background: white;
            border-right: 2px solid black;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .graphs-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            flex: 1;
        }

        .graph-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 300px;
        }

        .graph-wrapper.single {
            min-height: 500px;
        }

        .graph-wrapper.double {
            min-height: 400px;
        }

        .graph-wrapper.triple {
            min-height: 300px;
        }

        .graph-title {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .chart-container {
            flex: 1;
            position: relative;
            min-height: 250px;
        }

        .chart-container canvas {
            position: relative;
        }

        /* Panel lateral */
        .side-panel {
            background: white;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .panel-section {
            border-bottom: 2px solid black;
        }

        .section-header {
            background: white;
            padding: 12px 16px;
            font-weight: 700;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ccc;
        }

        .section-header:hover {
            background: #f5f5f5;
        }

        .section-content {
            padding: 16px;
            background: white;
        }

        .section-content.collapsed {
            display: none;
        }

        .input-row {
            margin-bottom: 12px;
        }

        .input-row label {
            display: block;
            font-size: 0.85rem;
            margin-bottom: 6px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-row input, .input-row select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid black;
            font-size: 0.9rem;
            background: white;
        }

        .input-row input[type="color"] {
            height: 40px;
            padding: 4px;
        }

        .input-row input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        .input-row input:focus, .input-row select:focus {
            outline: none;
            background: #f5f5f5;
        }

        .btn-full {
            width: 100%;
            margin-top: 8px;
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            padding: 8px;
            border: 2px solid #e0e0e0;
            cursor: pointer;
        }

        .checkbox-row:hover {
            background: #f5f5f5;
        }

        .checkbox-row input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-row label {
            cursor: pointer;
            flex: 1;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        .variable-config {
            border: 2px solid black;
            padding: 12px;
            margin-bottom: 12px;
            background: #f9f9f9;
        }

        .variable-config h4 {
            font-size: 0.85rem;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .color-preview {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid black;
            vertical-align: middle;
            margin-left: 8px;
        }

        /* Tabla minimalista */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .data-table thead {
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        .data-table th {
            padding: 8px;
            text-align: left;
            border-bottom: 2px solid black;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.75rem;
        }

        .data-table td {
            padding: 6px 8px;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table tr:hover {
            background: #f5f5f5;
        }

        .data-table tr.selected {
            background: #ffebee;
            border-left: 3px solid #ff0000;
        }

        .data-table tr.selected td {
            color: #d32f2f;
            font-weight: 600;
        }

        .data-table input {
            width: 100%;
            border: none;
            background: transparent;
            padding: 4px;
            font-size: 0.85rem;
        }

        .data-table input:focus {
            background: white;
            border: 1px solid black;
            outline: none;
        }

        .delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            padding: 0 4px;
        }

        .delete-btn:hover {
            color: #666;
        }

        .table-controls {
            padding: 12px;
            background: #f5f5f5;
            border-bottom: 2px solid black;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .table-search {
            flex: 1;
            padding: 6px 10px;
            border: 2px solid black;
            font-size: 0.85rem;
        }

        .table-filter {
            padding: 6px 10px;
            border: 2px solid black;
            font-size: 0.85rem;
            background: white;
        }

        /* Caja de resultados minimalista */
        .fit-box {
            background: white;
            border: 2px solid black;
            padding: 12px;
            margin-top: 12px;
            font-family: 'Courier New', monospace;
        }

        .fit-box .title {
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .fit-box .equation {
            font-size: 1.1rem;
            margin: 8px 0;
            font-weight: 600;
        }

        .fit-box .stats {
            font-size: 0.85rem;
            margin-top: 8px;
            line-height: 1.6;
        }

        /* Stats modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border: 3px solid black;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .modal-body {
            font-family: 'Courier New', monospace;
            line-height: 2;
        }

        .modal-close {
            margin-top: 16px;
            width: 100%;
        }

        /* Help/Tutorial modal */
        .help-modal {
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .help-section {
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .help-section:last-child {
            border-bottom: none;
        }

        .help-section h3 {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .help-section p {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .help-section ul {
            margin-left: 20px;
            margin-bottom: 12px;
        }

        .help-section li {
            margin-bottom: 6px;
            line-height: 1.5;
        }

        /* Acorde√≥n para help modal */
        .help-accordion-header {
            background: #f5f5f5;
            padding: 12px 16px;
            font-weight: 700;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid #ddd;
            border-radius: 4px;
            margin-bottom: 2px;
            transition: background 0.2s;
        }

        .help-accordion-header:hover {
            background: #e8e8e8;
        }

        .help-accordion-content {
            padding: 16px;
            background: white;
            border-left: 2px solid #ddd;
            border-right: 2px solid #ddd;
            border-bottom: 2px solid #ddd;
            margin-bottom: 12px;
        }

        .help-accordion-content.collapsed {
            display: none;
        }

        .help-accordion-arrow {
            font-size: 0.9rem;
            transition: transform 0.2s;
        }

        .code-block {
            background: #f5f5f5;
            border: 2px solid black;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            margin: 12px 0;
        }

        .code-block pre {
            margin: 0;
            white-space: pre;
        }

        .step-number {
            display: inline-block;
            background: black;
            color: white;
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
            border-radius: 50%;
            font-weight: 700;
            margin-right: 8px;
        }

        .feature-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .feature-icon {
            font-weight: 700;
            font-size: 1.2rem;
            margin-right: 12px;
            min-width: 24px;
        }

        .feature-text {
            flex: 1;
        }

        .feature-text strong {
            display: block;
            margin-bottom: 4px;
        }

        /* Video modal */
        .video-modal {
            max-width: 900px;
            width: 95%;
        }

        .video-container {
            background: black;
            border: 2px solid black;
            margin-top: 16px;
            position: relative;
        }

        .video-container video {
            width: 100%;
            display: block;
        }

        .video-info {
            padding: 12px;
            background: white;
            border-top: 2px solid black;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .video-controls {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        /* Camera preview */
        .camera-preview {
            background: black;
            border: 2px solid black;
            margin-top: 12px;
            position: relative;
        }

        .camera-preview video {
            width: 100%;
            display: block;
        }

        .recording-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: black;
            color: white;
            padding: 6px 12px;
            font-size: 0.8rem;
            font-weight: 700;
            letter-spacing: 1px;
            display: none;
        }

        .recording-indicator.active {
            display: block;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .info-box {
            background: #e3f2fd;
            border: 2px solid #1976d2;
            padding: 12px;
            margin-bottom: 12px;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .info-box strong {
            display: block;
            margin-bottom: 4px;
            color: #1565c0;
        }

        .warning-box {
            background: #fff3e0;
            border: 2px solid #f57c00;
            padding: 12px;
            margin-bottom: 12px;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .warning-box strong {
            display: block;
            margin-bottom: 4px;
            color: #e65100;
        }

        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
            }
            .graph-panel {
                border-right: none;
                border-bottom: 2px solid black;
            }
        }
    </style>
</head>
<body>
    <!-- Toolbar -->
    <div class="toolbar">
        <button id="connectBtn" class="toolbar-btn primary">CONECTAR</button>
        <button id="collectBtn" class="toolbar-btn primary" style="display:none;">CAPTURAR</button>
        <button id="stopBtn" class="toolbar-btn" style="display:none;">DETENER</button>

        <div class="toolbar-separator"></div>

        <button id="cameraBtn" class="toolbar-btn">C√ÅMARA</button>
        <button id="statsBtn" class="toolbar-btn">ESTAD√çSTICAS</button>

        <div class="toolbar-separator"></div>

        <button id="exportBtn" class="toolbar-btn" disabled>EXPORTAR CSV</button>
        <button id="importBtn" class="toolbar-btn">IMPORTAR CSV</button>
        <input type="file" id="importFile" accept=".csv" style="display: none;">
        <button id="clearBtn" class="toolbar-btn">LIMPIAR</button>

        <div class="toolbar-separator"></div>

        <a href="https://makecode.microbit.org/" target="_blank" class="toolbar-btn" style="text-decoration: none; display: inline-flex; align-items: center;">
            MAKECODE ‚Üó
        </a>

        <div class="toolbar-separator"></div>

        <button id="helpBtn" class="toolbar-btn">AYUDA</button>

        <div class="toolbar-separator"></div>

        <!-- Selector de Idioma -->
        <select id="languageSelector" class="toolbar-btn" style="cursor: pointer; padding: 8px 12px;">
            <option value="es">ES</option>
            <option value="en">EN</option>
            <option value="pt">PT</option>
        </select>

        <span class="status-text" id="pointInfo" style="display: none; background: #ffebee; border-color: #ff0000; color: #d32f2f;"></span>
        <span class="status-text" id="statusText">DESCONECTADO</span>
    </div>

    <!-- Main -->
    <div class="main-container">
        <!-- Gr√°ficas -->
        <div class="graph-panel">
            <div class="graphs-container" id="graphsContainer">
                <!-- Las gr√°ficas se generan din√°micamente aqu√≠ -->
            </div>
        </div>

        <!-- Panel lateral -->
        <div class="side-panel">
            <!-- Video -->
            <div class="panel-section" id="videoSection" style="display:none;">
                <div class="section-header" onclick="toggleSection(this)">
                    VIDEO <span>‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="camera-preview">
                        <video id="cameraPreview" autoplay muted></video>
                        <div class="recording-indicator" id="recordingIndicator">‚óè REC</div>
                    </div>
                    <button class="toolbar-btn btn-full" id="stopCameraBtn">
                        DETENER C√ÅMARA
                    </button>
                </div>
            </div>

            <!-- Configuraci√≥n de Variables -->
            <div class="panel-section">
                <div class="section-header" onclick="toggleSection(this)">
                    VARIABLES <span>‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="input-row">
                        <label>N√∫mero de Variables</label>
                        <select id="numVariables">
                            <option value="1" selected>1 Variable</option>
                            <option value="2">2 Variables</option>
                            <option value="3">3 Variables</option>
                        </select>
                    </div>

                    <!-- Variable 1 -->
                    <div class="variable-config" id="var1Config">
                        <h4>Variable 1</h4>
                        <div class="input-row">
                            <label>Nombre</label>
                            <input type="text" id="var1Name" value="Variable 1">
                        </div>
                        <div class="input-row">
                            <label>Color <span class="color-preview" id="var1ColorPreview" style="background: #000000;"></span></label>
                            <input type="color" id="var1Color" value="#000000">
                        </div>
                    </div>

                    <!-- Variable 2 -->
                    <div class="variable-config hidden" id="var2Config">
                        <h4>Variable 2</h4>
                        <div class="input-row">
                            <label>Nombre</label>
                            <input type="text" id="var2Name" value="Variable 2">
                        </div>
                        <div class="input-row">
                            <label>Color <span class="color-preview" id="var2ColorPreview" style="background: #ff0000;"></span></label>
                            <input type="color" id="var2Color" value="#ff0000">
                        </div>
                    </div>

                    <!-- Variable 3 -->
                    <div class="variable-config hidden" id="var3Config">
                        <h4>Variable 3</h4>
                        <div class="input-row">
                            <label>Nombre</label>
                            <input type="text" id="var3Name" value="Variable 3">
                        </div>
                        <div class="input-row">
                            <label>Color <span class="color-preview" id="var3ColorPreview" style="background: #0000ff;"></span></label>
                            <input type="color" id="var3Color" value="#0000ff">
                        </div>
                    </div>

                    <button class="toolbar-btn primary btn-full" id="applyVarConfigBtn">
                        APLICAR CONFIGURACI√ìN
                    </button>
                </div>
            </div>

            <!-- Configuraci√≥n de Gr√°ficas -->
            <div class="panel-section">
                <div class="section-header" onclick="toggleSection(this)">
                    CONFIGURACI√ìN DE GR√ÅFICAS <span>‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="input-row">
                        <label>N√∫mero de Gr√°ficas</label>
                        <select id="numGraphs">
                            <option value="1" selected>1 Gr√°fica</option>
                            <option value="2">2 Gr√°ficas</option>
                            <option value="3">3 Gr√°ficas</option>
                        </select>
                    </div>

                    <div class="info-box">
                        <strong>CONFIGURACI√ìN DE EJES:</strong>
                        Personaliza qu√© variables mostrar en cada gr√°fica y en qu√© ejes.
                    </div>

                    <!-- Configuraci√≥n Gr√°fica 1 -->
                    <div id="graph1Config">
                        <h4 id="graph1Title" style="margin-bottom: 8px; font-size: 0.85rem;">GR√ÅFICA 1</h4>
                        <div class="input-row">
                            <label>Eje X</label>
                            <select id="graph1XAxis">
                                <option value="time">Tiempo</option>
                            </select>
                        </div>
                        <div class="input-row">
                            <label>Variables en Eje Y</label>
                            <div id="graph1YVars">
                                <!-- Checkboxes din√°micos -->
                            </div>
                        </div>
                        <div class="input-row">
                            <label>Etiqueta Eje X</label>
                            <input type="text" id="graph1XLabel" value="Tiempo (s)">
                        </div>
                        <div class="input-row">
                            <label>Etiqueta Eje Y</label>
                            <input type="text" id="graph1YLabel" value="Valor">
                        </div>
                    </div>

                    <!-- Configuraci√≥n Gr√°fica 2 -->
                    <div id="graph2Config" class="hidden" style="margin-top: 16px; padding-top: 16px; border-top: 2px solid #e0e0e0;">
                        <h4 id="graph2Title" style="margin-bottom: 8px; font-size: 0.85rem;">GR√ÅFICA 2</h4>
                        <div class="input-row">
                            <label>Eje X</label>
                            <select id="graph2XAxis">
                                <option value="time">Tiempo</option>
                            </select>
                        </div>
                        <div class="input-row">
                            <label>Variables en Eje Y</label>
                            <div id="graph2YVars">
                                <!-- Checkboxes din√°micos -->
                            </div>
                        </div>
                        <div class="input-row">
                            <label>Etiqueta Eje X</label>
                            <input type="text" id="graph2XLabel" value="Tiempo (s)">
                        </div>
                        <div class="input-row">
                            <label>Etiqueta Eje Y</label>
                            <input type="text" id="graph2YLabel" value="Valor">
                        </div>
                    </div>

                    <!-- Configuraci√≥n Gr√°fica 3 -->
                    <div id="graph3Config" class="hidden" style="margin-top: 16px; padding-top: 16px; border-top: 2px solid #e0e0e0;">
                        <h4 id="graph3Title" style="margin-bottom: 8px; font-size: 0.85rem;">GR√ÅFICA 3</h4>
                        <div class="input-row">
                            <label>Eje X</label>
                            <select id="graph3XAxis">
                                <option value="time">Tiempo</option>
                            </select>
                        </div>
                        <div class="input-row">
                            <label>Variables en Eje Y</label>
                            <div id="graph3YVars">
                                <!-- Checkboxes din√°micos -->
                            </div>
                        </div>
                        <div class="input-row">
                            <label>Etiqueta Eje X</label>
                            <input type="text" id="graph3XLabel" value="Tiempo (s)">
                        </div>
                        <div class="input-row">
                            <label>Etiqueta Eje Y</label>
                            <input type="text" id="graph3YLabel" value="Valor">
                        </div>
                    </div>

                    <div class="input-row" style="margin-top: 16px;">
                        <label>Unidad tiempo</label>
                        <select id="timeUnit">
                            <option value="1">Milisegundos</option>
                            <option value="1000" selected>Segundos</option>
                            <option value="60000">Minutos</option>
                        </select>
                    </div>

                    <div class="checkbox-row">
                        <input type="checkbox" id="showLinesToggle" checked>
                        <label for="showLinesToggle">Mostrar L√≠neas</label>
                    </div>

                    <button class="toolbar-btn primary btn-full" id="applyGraphConfigBtn">
                        APLICAR CONFIGURACI√ìN
                    </button>

                    <button class="toolbar-btn btn-full" id="setZeroBtn" disabled>
                        ESTABLECER T=0
                    </button>
                </div>
            </div>

            <!-- Ajuste de Curva -->
            <div class="panel-section">
                <div class="section-header" onclick="toggleSection(this)">
                    AJUSTE DE CURVA <span>‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="info-box">
                        <strong>REGRESI√ìN POR M√çNIMOS CUADRADOS:</strong>
                        Ajusta una funci√≥n matem√°tica a tus datos experimentales.
                    </div>

                    <div class="input-row">
                        <label>Tipo de Ajuste</label>
                        <select id="fitType">
                            <option value="linear">Lineal (y = mx + b)</option>
                            <option value="quadratic">Cuadr√°tico (y = ax¬≤ + bx + c)</option>
                            <option value="cubic">C√∫bico (y = ax¬≥ + bx¬≤ + cx + d)</option>
                            <option value="exponential">Exponencial (y = a¬∑e^(bx))</option>
                            <option value="power">Potencia (y = a¬∑x^b)</option>
                            <option value="logarithmic">Logar√≠tmico (y = a¬∑ln(x) + b)</option>
                            <option value="inverse">Inverso (y = a/x + b)</option>
                        </select>
                    </div>

                    <div class="input-row">
                        <label>Variable a Ajustar</label>
                        <select id="fitVariable">
                            <option value="0">Variable 1</option>
                        </select>
                    </div>

                    <div class="input-row">
                        <label>Gr√°fica de Referencia</label>
                        <select id="fitGraphSelect">
                            <option value="0">Gr√°fica 1</option>
                        </select>
                    </div>

                    <div style="margin-top: 12px; padding: 10px; background: #f9f9f9; border-radius: 4px;">
                        <div style="margin-bottom: 8px; font-weight: bold; font-size: 11px;">DATOS A AJUSTAR:</div>

                        <div class="checkbox-row">
                            <input type="radio" id="fitModeAll" name="fitMode" value="all" checked>
                            <label for="fitModeAll">Todos los Datos</label>
                        </div>

                        <div class="checkbox-row">
                            <input type="radio" id="fitModeSelected" name="fitMode" value="selected">
                            <label for="fitModeSelected">Puntos Seleccionados Manualmente</label>
                        </div>

                        <div class="checkbox-row">
                            <input type="radio" id="fitModeRange" name="fitMode" value="range">
                            <label for="fitModeRange">Rango de Puntos</label>
                        </div>

                        <div id="fitRangeInputs" style="margin-top: 8px; display: none;">
                            <div class="input-row">
                                <label>Desde Punto</label>
                                <input type="number" id="fitRangeFrom" placeholder="Ej: 1" min="1" style="font-size: 12px;">
                            </div>
                            <div class="input-row">
                                <label>Hasta Punto</label>
                                <input type="number" id="fitRangeTo" placeholder="Ej: 50" min="1" style="font-size: 12px;">
                            </div>
                        </div>
                    </div>

                    <button class="toolbar-btn primary btn-full" id="performFitBtn" disabled>
                        REALIZAR AJUSTE
                    </button>

                    <button class="toolbar-btn btn-full" id="clearFitBtn" disabled style="margin-top: 8px;">
                        LIMPIAR AJUSTE
                    </button>

                    <div id="fitResults" style="margin-top: 12px; padding: 12px; background: #f0f0f0; border-radius: 4px; font-family: monospace; font-size: 12px; display: none;">
                        <div style="margin-bottom: 8px;"><strong>Ecuaci√≥n:</strong></div>
                        <div id="fitEquation" style="margin-bottom: 12px; color: #0066cc;"></div>
                        <div style="margin-bottom: 4px;"><strong>Coeficiente R¬≤:</strong> <span id="fitR2"></span></div>
                        <div style="margin-bottom: 4px;"><strong>Puntos usados:</strong> <span id="fitPoints"></span></div>
                    </div>
                </div>
            </div>

            <!-- Depuraci√≥n de Datos -->
            <div class="panel-section">
                <div class="section-header" onclick="toggleSection(this)">
                    DEPURACI√ìN DE DATOS <span>‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="info-box">
                        <strong>ELIMINAR PUNTOS:</strong>
                        Usa estas herramientas para limpiar datos incorrectos o no deseados.
                    </div>

                    <div class="input-row">
                        <label>Eliminar Rango (desde)</label>
                        <input type="number" id="deleteRangeFrom" placeholder="Punto inicial" min="1">
                    </div>

                    <div class="input-row">
                        <label>Eliminar Rango (hasta)</label>
                        <input type="number" id="deleteRangeTo" placeholder="Punto final" min="1">
                    </div>

                    <button class="toolbar-btn btn-full" id="deleteRangeBtn" disabled>
                        ELIMINAR RANGO
                    </button>

                    <button class="toolbar-btn btn-full" id="deleteSelectedBtn" disabled style="margin-top: 8px;">
                        ELIMINAR SELECCIONADOS
                    </button>

                    <button class="toolbar-btn btn-full" id="clearSelectionBtn" disabled style="margin-top: 8px;">
                        LIMPIAR SELECCI√ìN
                    </button>
                </div>
            </div>

            <!-- Datos -->
            <div class="panel-section" style="flex: 1; display: flex; flex-direction: column;">
                <div class="section-header" onclick="toggleSection(this)">
                    DATOS <span>‚ñº</span>
                </div>
                <div class="table-controls">
                    <input type="text" id="tableSearch" class="table-search" placeholder="Buscar...">
                    <select id="tableFilter" class="table-filter">
                        <option value="all">Todos</option>
                        <option value="selected">Seleccionados</option>
                    </select>
                </div>
                <div class="section-content" style="flex: 1; overflow-y: auto; max-height: 400px; padding: 0;">
                    <table class="data-table">
                        <thead>
                            <tr id="dataTableHeader">
                                <th>#</th>
                                <th>T</th>
                                <th>V1</th>
                                <th>üìπ</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 20px;">SIN DATOS</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de estad√≠sticas -->
    <div class="modal" id="statsModal">
        <div class="modal-content">
            <div class="modal-header">ESTAD√çSTICAS</div>
            <div class="modal-body" id="statsBody"></div>
            <button class="toolbar-btn primary modal-close" onclick="closeStatsModal()">CERRAR</button>
        </div>
    </div>

    <!-- Modal de video -->
    <div class="modal" id="videoModal">
        <div class="modal-content video-modal">
            <div class="modal-header">REPRODUCCI√ìN DE VIDEO</div>
            <div class="video-container">
                <video id="playbackVideo" controls></video>
            </div>
            <div class="video-info" id="videoInfo"></div>
            <div class="video-controls">
                <button class="toolbar-btn primary" onclick="closeVideoModal()">CERRAR</button>
            </div>
        </div>
    </div>

    <!-- Modal de ayuda b√°sica -->
    <div class="modal" id="helpModal">
        <div class="modal-content help-modal">
            <div class="modal-header" id="helpModalTitle">TUTORIAL Y GU√çA DE USO</div>
            <div id="helpModalContent"></div>
            <button class="toolbar-btn primary modal-close" id="helpModalClose" onclick="closeHelpModal()">CERRAR</button>
        </div>
    </div>

    <footer id="footerContent" style="background: #f5f5f5; border-top: 2px solid #333; padding: 20px; text-align: center; font-size: 12px; margin-top: 20px;">
        <div id="footerInner" style="max-width: 800px; margin: 0 auto;">
            <p style="margin: 8px 0; font-weight: bold; font-size: 14px;">
                Sistema de Captura y An√°lisis de Datos - micro:bit
            </p>
            <p style="margin: 8px 0;">
                Desarrollado por <strong>Martin Ferreira</strong> y <strong>Pablo Godoy</strong>
            </p>
            <p style="margin: 8px 0;">
                <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="license"
                   style="color: #0066cc; text-decoration: none; font-weight: bold;">
                    üìÑ Licencia Creative Commons BY-SA 4.0
                </a>
            </p>
            <p style="margin: 8px 0; color: #666; font-size: 11px;">
                Esta obra est√° bajo una Licencia Creative Commons Atribuci√≥n-CompartirIgual 4.0 Internacional.
                <br>
                Eres libre de compartir y adaptar este material, siempre que des cr√©dito a los autores originales
                y distribuyas tus contribuciones bajo la misma licencia.
            </p>
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #ddd;">
                <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="license">
                    <img src="https://licensebuttons.net/l/by-sa/4.0/88x31.png"
                         alt="Licencia Creative Commons"
                         style="border: 0; margin: 4px auto; display: block;">
                </a>
            </div>
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #ddd; color: #666; font-size: 11px;">
                <p style="margin: 4px 0;">
                    <strong>Librer√≠as utilizadas:</strong>
                </p>
                <p style="margin: 4px 0;">
                    ‚Ä¢ <a href="https://github.com/Tom-Alexander/regression-js" target="_blank"
                         style="color: #0066cc; text-decoration: none;">
                        regression-js
                    </a> por <strong>Tom Alexander</strong> - Ajuste de curvas por m√≠nimos cuadrados
                </p>
                <p style="margin: 4px 0;">
                    ‚Ä¢ <a href="https://www.chartjs.org/" target="_blank"
                         style="color: #0066cc; text-decoration: none;">
                        Chart.js
                    </a> - Visualizaci√≥n de gr√°ficas
                </p>
            </div>
        </div>
    </footer>

    <script>
        // ========== SISTEMA DE TRADUCCIONES ==========
        const translations = {
            es: {
                // Toolbar
                connect: 'CONECTAR',
                capture: 'CAPTURAR',
                stop: 'DETENER',
                camera: 'C√ÅMARA',
                statistics: 'ESTAD√çSTICAS',
                exportCSV: 'EXPORTAR CSV',
                importCSV: 'IMPORTAR CSV',
                clear: 'LIMPIAR',
                help: 'AYUDA',
                disconnected: 'DESCONECTADO',
                connected: 'CONECTADO',
                capturing: 'CAPTURANDO',
                paused: 'PAUSADO',
                // Panel lateral
                varConfig: 'CONFIGURACI√ìN DE VARIABLES',
                numVars: 'N√∫mero de Variables',
                varName: 'Nombre Variable',
                varColor: 'Color',
                applyVarConfig: 'APLICAR CONFIGURACI√ìN',
                graphConfig: 'CONFIGURACI√ìN DE GR√ÅFICAS',
                numGraphs: 'N√∫mero de Gr√°ficas',
                xAxis: 'Eje X',
                yVars: 'Variables en Eje Y',
                xLabel: 'Etiqueta Eje X',
                yLabel: 'Etiqueta Eje Y',
                timeUnit: 'Unidad tiempo',
                milliseconds: 'Milisegundos',
                seconds: 'Segundos',
                minutes: 'Minutos',
                showLines: 'Mostrar L√≠neas',
                applyGraphConfig: 'APLICAR CONFIGURACI√ìN',
                setZero: 'ESTABLECER T=0',
                curveFit: 'AJUSTE DE CURVA',
                curveFitInfo: 'Ajusta una funci√≥n matem√°tica a tus datos experimentales.',
                fitType: 'Tipo de Ajuste',
                fitLinear: 'Lineal (y = mx + b)',
                fitQuadratic: 'Cuadr√°tico (y = ax¬≤ + bx + c)',
                fitCubic: 'C√∫bico (y = ax¬≥ + bx¬≤ + cx + d)',
                fitExponential: 'Exponencial (y = a¬∑e^(bx))',
                fitPower: 'Potencia (y = a¬∑x^b)',
                fitLogarithmic: 'Logar√≠tmico (y = a¬∑ln(x) + b)',
                fitInverse: 'Inverso (y = a/x + b)',
                fitVariable: 'Variable a Ajustar',
                fitGraph: 'Gr√°fica de Referencia',
                dataToFit: 'DATOS A AJUSTAR:',
                allData: 'Todos los Datos',
                selectedPoints: 'Puntos Seleccionados Manualmente',
                rangePoints: 'Rango de Puntos',
                fromPoint: 'Desde Punto',
                toPoint: 'Hasta Punto',
                performFit: 'REALIZAR AJUSTE',
                clearFit: 'LIMPIAR AJUSTE',
                equation: 'Ecuaci√≥n:',
                r2Coeff: 'Coeficiente R¬≤:',
                pointsUsed: 'Puntos usados:',
                dataDebug: 'DEPURACI√ìN DE DATOS',
                deletePoints: 'ELIMINAR PUNTOS:',
                deleteInfo: 'Usa estas herramientas para limpiar datos incorrectos o no deseados.',
                deleteRangeFrom: 'Eliminar Rango (desde)',
                deleteRangeTo: 'Eliminar Rango (hasta)',
                deleteRange: 'ELIMINAR RANGO',
                deleteSelected: 'ELIMINAR SELECCIONADOS',
                clearSelection: 'LIMPIAR SELECCI√ìN',
                data: 'DATOS',
                noData: 'SIN DATOS',
                time: 'Tiempo',
                graph: 'Gr√°fica',
                // Secciones del panel
                video: 'VIDEO',
                variables: 'VARIABLES',
                stopCamera: 'DETENER C√ÅMARA',
                variable: 'Variable',
                color: 'Color',
                oneVariable: '1 Variable',
                twoVariables: '2 Variables',
                threeVariables: '3 Variables',
                oneGraph: '1 Gr√°fica',
                twoGraphs: '2 Gr√°ficas',
                threeGraphs: '3 Gr√°ficas',
                axisConfig: 'CONFIGURACI√ìN DE EJES:',
                axisConfigInfo: 'Personaliza qu√© variables mostrar en cada gr√°fica y en qu√© ejes.',
                yAxisVars: 'Variables en Eje Y',
                regressionInfo: 'REGRESI√ìN POR M√çNIMOS CUADRADOS:',
                regressionInfoText: 'Ajusta una funci√≥n matem√°tica a tus datos experimentales.',
                // Tabla
                searchPlaceholder: 'Buscar...',
                all: 'Todos',
                selected: 'Seleccionados',
                close: 'CERRAR',
                statisticsTitle: 'ESTAD√çSTICAS',
                // Footer
                footerTitle: 'Sistema de Captura y An√°lisis de Datos - micro:bit',
                developedBy: 'Desarrollado por',
                licenseCC: 'Licencia Creative Commons BY-SA 4.0',
                licenseText: 'Esta obra est√° bajo una Licencia Creative Commons Atribuci√≥n-CompartirIgual 4.0 Internacional.',
                licenseText2: 'Eres libre de compartir y adaptar este material, siempre que des cr√©dito a los autores originales y distribuyas tus contribuciones bajo la misma licencia.',
                librariesUsed: 'Librer√≠as utilizadas:',
                by: 'por',
                curveFittingLib: 'Ajuste de curvas por m√≠nimos cuadrados',
                graphVisualization: 'Visualizaci√≥n de gr√°ficas',
                // Placeholders
                exampleFrom: 'Ej: 1',
                exampleTo: 'Ej: 50',
                initialPoint: 'Punto inicial',
                finalPoint: 'Punto final',
                // Valores por defecto
                variableDefault: 'Variable',
                graphDefault: 'Gr√°fica',
                timeSeconds: 'Tiempo (s)',
                value: 'Valor',
                recording: '‚óè REC',
                // Headers de tabla (se mantienen cortos intencionalmente)
                tableHeaderNumber: '#',
                tableHeaderTime: 'T',
                // Estad√≠sticas
                noDataAlert: 'No hay datos',
                mean: 'MEDIA',
                minimum: 'M√çNIMO',
                maximum: 'M√ÅXIMO',
                stdDev: 'DESV. EST',
                totalPoints: 'PUNTOS TOTALES'
            },
            en: {
                // Toolbar
                connect: 'CONNECT',
                capture: 'CAPTURE',
                stop: 'STOP',
                camera: 'CAMERA',
                statistics: 'STATISTICS',
                exportCSV: 'EXPORT CSV',
                importCSV: 'IMPORT CSV',
                clear: 'CLEAR',
                help: 'HELP',
                disconnected: 'DISCONNECTED',
                connected: 'CONNECTED',
                capturing: 'CAPTURING',
                paused: 'PAUSED',
                // Side panel
                varConfig: 'VARIABLE CONFIGURATION',
                numVars: 'Number of Variables',
                varName: 'Variable Name',
                varColor: 'Color',
                applyVarConfig: 'APPLY CONFIGURATION',
                graphConfig: 'GRAPH CONFIGURATION',
                numGraphs: 'Number of Graphs',
                xAxis: 'X Axis',
                yVars: 'Y Axis Variables',
                xLabel: 'X Axis Label',
                yLabel: 'Y Axis Label',
                timeUnit: 'Time Unit',
                milliseconds: 'Milliseconds',
                seconds: 'Seconds',
                minutes: 'Minutes',
                showLines: 'Show Lines',
                applyGraphConfig: 'APPLY CONFIGURATION',
                setZero: 'SET T=0',
                curveFit: 'CURVE FITTING',
                curveFitInfo: 'Fit a mathematical function to your experimental data.',
                fitType: 'Fit Type',
                fitLinear: 'Linear (y = mx + b)',
                fitQuadratic: 'Quadratic (y = ax¬≤ + bx + c)',
                fitCubic: 'Cubic (y = ax¬≥ + bx¬≤ + cx + d)',
                fitExponential: 'Exponential (y = a¬∑e^(bx))',
                fitPower: 'Power (y = a¬∑x^b)',
                fitLogarithmic: 'Logarithmic (y = a¬∑ln(x) + b)',
                fitInverse: 'Inverse (y = a/x + b)',
                fitVariable: 'Variable to Fit',
                fitGraph: 'Reference Graph',
                dataToFit: 'DATA TO FIT:',
                allData: 'All Data',
                selectedPoints: 'Manually Selected Points',
                rangePoints: 'Point Range',
                fromPoint: 'From Point',
                toPoint: 'To Point',
                performFit: 'PERFORM FIT',
                clearFit: 'CLEAR FIT',
                equation: 'Equation:',
                r2Coeff: 'R¬≤ Coefficient:',
                pointsUsed: 'Points used:',
                dataDebug: 'DATA DEBUGGING',
                deletePoints: 'DELETE POINTS:',
                deleteInfo: 'Use these tools to clean incorrect or unwanted data.',
                deleteRangeFrom: 'Delete Range (from)',
                deleteRangeTo: 'Delete Range (to)',
                deleteRange: 'DELETE RANGE',
                deleteSelected: 'DELETE SELECTED',
                clearSelection: 'CLEAR SELECTION',
                data: 'DATA',
                noData: 'NO DATA',
                time: 'Time',
                graph: 'Graph',
                // Panel sections
                video: 'VIDEO',
                variables: 'VARIABLES',
                stopCamera: 'STOP CAMERA',
                variable: 'Variable',
                color: 'Color',
                oneVariable: '1 Variable',
                twoVariables: '2 Variables',
                threeVariables: '3 Variables',
                oneGraph: '1 Graph',
                twoGraphs: '2 Graphs',
                threeGraphs: '3 Graphs',
                axisConfig: 'AXIS CONFIGURATION:',
                axisConfigInfo: 'Customize which variables to display on each graph and on which axes.',
                yAxisVars: 'Y Axis Variables',
                regressionInfo: 'LEAST SQUARES REGRESSION:',
                regressionInfoText: 'Fit a mathematical function to your experimental data.',
                // Table
                searchPlaceholder: 'Search...',
                all: 'All',
                selected: 'Selected',
                close: 'CLOSE',
                statisticsTitle: 'STATISTICS',
                // Footer
                footerTitle: 'Data Capture and Analysis System - micro:bit',
                developedBy: 'Developed by',
                licenseCC: 'Creative Commons BY-SA 4.0 License',
                licenseText: 'This work is licensed under a Creative Commons Attribution-ShareAlike 4.0 International License.',
                licenseText2: 'You are free to share and adapt this material, as long as you give credit to the original authors and distribute your contributions under the same license.',
                librariesUsed: 'Libraries used:',
                by: 'by',
                curveFittingLib: 'Curve fitting by least squares',
                graphVisualization: 'Graph visualization',
                // Placeholders
                exampleFrom: 'Ex: 1',
                exampleTo: 'Ex: 50',
                initialPoint: 'Initial point',
                finalPoint: 'Final point',
                // Default values
                variableDefault: 'Variable',
                graphDefault: 'Graph',
                timeSeconds: 'Time (s)',
                value: 'Value',
                recording: '‚óè REC',
                // Table headers (intentionally kept short)
                tableHeaderNumber: '#',
                tableHeaderTime: 'T',
                // Statistics
                noDataAlert: 'No data',
                mean: 'MEAN',
                minimum: 'MINIMUM',
                maximum: 'MAXIMUM',
                stdDev: 'STD. DEV',
                totalPoints: 'TOTAL POINTS'
            },
            pt: {
                // Toolbar
                connect: 'CONECTAR',
                capture: 'CAPTURAR',
                stop: 'PARAR',
                camera: 'C√ÇMERA',
                statistics: 'ESTAT√çSTICAS',
                exportCSV: 'EXPORTAR CSV',
                importCSV: 'IMPORTAR CSV',
                clear: 'LIMPAR',
                help: 'AJUDA',
                disconnected: 'DESCONECTADO',
                connected: 'CONECTADO',
                capturing: 'CAPTURANDO',
                paused: 'PAUSADO',
                // Painel lateral
                varConfig: 'CONFIGURA√á√ÉO DE VARI√ÅVEIS',
                numVars: 'N√∫mero de Vari√°veis',
                varName: 'Nome da Vari√°vel',
                varColor: 'Cor',
                applyVarConfig: 'APLICAR CONFIGURA√á√ÉO',
                graphConfig: 'CONFIGURA√á√ÉO DE GR√ÅFICOS',
                numGraphs: 'N√∫mero de Gr√°ficos',
                xAxis: 'Eixo X',
                yVars: 'Vari√°veis no Eixo Y',
                xLabel: 'R√≥tulo Eixo X',
                yLabel: 'R√≥tulo Eixo Y',
                timeUnit: 'Unidade de tempo',
                milliseconds: 'Milissegundos',
                seconds: 'Segundos',
                minutes: 'Minutos',
                showLines: 'Mostrar Linhas',
                applyGraphConfig: 'APLICAR CONFIGURA√á√ÉO',
                setZero: 'DEFINIR T=0',
                curveFit: 'AJUSTE DE CURVA',
                curveFitInfo: 'Ajuste uma fun√ß√£o matem√°tica aos seus dados experimentais.',
                fitType: 'Tipo de Ajuste',
                fitLinear: 'Linear (y = mx + b)',
                fitQuadratic: 'Quadr√°tico (y = ax¬≤ + bx + c)',
                fitCubic: 'C√∫bico (y = ax¬≥ + bx¬≤ + cx + d)',
                fitExponential: 'Exponencial (y = a¬∑e^(bx))',
                fitPower: 'Pot√™ncia (y = a¬∑x^b)',
                fitLogarithmic: 'Logar√≠tmico (y = a¬∑ln(x) + b)',
                fitInverse: 'Inverso (y = a/x + b)',
                fitVariable: 'Vari√°vel a Ajustar',
                fitGraph: 'Gr√°fico de Refer√™ncia',
                dataToFit: 'DADOS A AJUSTAR:',
                allData: 'Todos os Dados',
                selectedPoints: 'Pontos Selecionados Manualmente',
                rangePoints: 'Intervalo de Pontos',
                fromPoint: 'Do Ponto',
                toPoint: 'At√© o Ponto',
                performFit: 'REALIZAR AJUSTE',
                clearFit: 'LIMPAR AJUSTE',
                equation: 'Equa√ß√£o:',
                r2Coeff: 'Coeficiente R¬≤:',
                pointsUsed: 'Pontos usados:',
                dataDebug: 'DEPURA√á√ÉO DE DADOS',
                deletePoints: 'ELIMINAR PONTOS:',
                deleteInfo: 'Use essas ferramentas para limpar dados incorretos ou indesejados.',
                deleteRangeFrom: 'Eliminar Intervalo (de)',
                deleteRangeTo: 'Eliminar Intervalo (at√©)',
                deleteRange: 'ELIMINAR INTERVALO',
                deleteSelected: 'ELIMINAR SELECIONADOS',
                clearSelection: 'LIMPAR SELE√á√ÉO',
                data: 'DADOS',
                noData: 'SEM DADOS',
                time: 'Tempo',
                graph: 'Gr√°fico',
                // Se√ß√µes do painel
                video: 'V√çDEO',
                variables: 'VARI√ÅVEIS',
                stopCamera: 'PARAR C√ÇMERA',
                variable: 'Vari√°vel',
                color: 'Cor',
                oneVariable: '1 Vari√°vel',
                twoVariables: '2 Vari√°veis',
                threeVariables: '3 Vari√°veis',
                oneGraph: '1 Gr√°fico',
                twoGraphs: '2 Gr√°ficos',
                threeGraphs: '3 Gr√°ficos',
                axisConfig: 'CONFIGURA√á√ÉO DE EIXOS:',
                axisConfigInfo: 'Personalize quais vari√°veis mostrar em cada gr√°fico e em quais eixos.',
                yAxisVars: 'Vari√°veis no Eixo Y',
                regressionInfo: 'REGRESS√ÉO POR M√çNIMOS QUADRADOS:',
                regressionInfoText: 'Ajuste uma fun√ß√£o matem√°tica aos seus dados experimentais.',
                // Tabela
                searchPlaceholder: 'Buscar...',
                all: 'Todos',
                selected: 'Selecionados',
                close: 'FECHAR',
                statisticsTitle: 'ESTAT√çSTICAS',
                // Rodap√©
                footerTitle: 'Sistema de Captura e An√°lise de Dados - micro:bit',
                developedBy: 'Desenvolvido por',
                licenseCC: 'Licen√ßa Creative Commons BY-SA 4.0',
                licenseText: 'Esta obra est√° sob uma Licen√ßa Creative Commons Atribui√ß√£o-CompartilhaIgual 4.0 Internacional.',
                licenseText2: 'Voc√™ √© livre para compartilhar e adaptar este material, desde que d√™ cr√©dito aos autores originais e distribua suas contribui√ß√µes sob a mesma licen√ßa.',
                librariesUsed: 'Bibliotecas utilizadas:',
                by: 'por',
                curveFittingLib: 'Ajuste de curvas por m√≠nimos quadrados',
                graphVisualization: 'Visualiza√ß√£o de gr√°ficos',
                // Placeholders
                exampleFrom: 'Ex: 1',
                exampleTo: 'Ex: 50',
                initialPoint: 'Ponto inicial',
                finalPoint: 'Ponto final',
                // Valores padr√£o
                variableDefault: 'Vari√°vel',
                graphDefault: 'Gr√°fico',
                timeSeconds: 'Tempo (s)',
                value: 'Valor',
                recording: '‚óè REC',
                // Cabe√ßalhos da tabela (mantidos curtos intencionalmente)
                tableHeaderNumber: '#',
                tableHeaderTime: 'T',
                // Estat√≠sticas
                noDataAlert: 'Sem dados',
                mean: 'M√âDIA',
                minimum: 'M√çNIMO',
                maximum: 'M√ÅXIMO',
                stdDev: 'DESV. PAD',
                totalPoints: 'PONTOS TOTAIS'
            }
        };

        // Idioma actual (global para acceso desde funciones din√°micas)
        let currentLanguage = 'es';

        // Funci√≥n para actualizar el footer seg√∫n el idioma
        function updateFooter(lang) {
            const t = translations[lang];
            const footerInner = document.getElementById('footerInner');

            footerInner.innerHTML = `
                <p style="margin: 8px 0; font-weight: bold; font-size: 14px;">
                    ${t.footerTitle}
                </p>
                <p style="margin: 8px 0;">
                    ${t.developedBy} <strong>Martin Ferreira</strong> ${lang === 'en' ? 'and' : lang === 'pt' ? 'e' : 'y'} <strong>Pablo Godoy</strong>
                </p>
                <p style="margin: 8px 0;">
                    <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="license"
                       style="color: #0066cc; text-decoration: none; font-weight: bold;">
                        üìÑ ${t.licenseCC}
                    </a>
                </p>
                <p style="margin: 8px 0; color: #666; font-size: 11px;">
                    ${t.licenseText}
                    <br>
                    ${t.licenseText2}
                </p>
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #ddd;">
                    <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="license">
                        <img src="https://licensebuttons.net/l/by-sa/4.0/88x31.png"
                             alt="Licencia Creative Commons"
                             style="border: 0; margin: 4px auto; display: block;">
                    </a>
                </div>
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #ddd; color: #666; font-size: 11px;">
                    <p style="margin: 4px 0;">
                        <strong>${t.librariesUsed}</strong>
                    </p>
                    <p style="margin: 4px 0;">
                        ‚Ä¢ <a href="https://github.com/Tom-Alexander/regression-js" target="_blank"
                             style="color: #0066cc; text-decoration: none;">
                            regression-js
                        </a> ${t.by} <strong>Tom Alexander</strong> - ${t.curveFittingLib}
                    </p>
                    <p style="margin: 4px 0;">
                        ‚Ä¢ <a href="https://www.chartjs.org/" target="_blank"
                             style="color: #0066cc; text-decoration: none;">
                            Chart.js
                        </a> - ${t.graphVisualization}
                    </p>
                </div>
            `;
        }

        // Funci√≥n para cambiar idioma
        function changeLanguage(lang) {
            currentLanguage = lang; // Guardar idioma actual
            const t = translations[lang];

            // Toolbar
            document.getElementById('connectBtn').textContent = t.connect;
            document.getElementById('collectBtn').textContent = t.capture;
            document.getElementById('stopBtn').textContent = t.stop;
            document.getElementById('cameraBtn').textContent = t.camera;
            document.getElementById('statsBtn').textContent = t.statistics;
            document.getElementById('exportBtn').textContent = t.exportCSV;
            document.getElementById('importBtn').textContent = t.importCSV;
            document.getElementById('clearBtn').textContent = t.clear;
            document.getElementById('helpBtn').textContent = t.help;

            // Actualizar status seg√∫n estado actual
            const statusText = document.getElementById('statusText').textContent;
            if (statusText.includes('DESCONECTADO') || statusText.includes('DISCONNECTED') || statusText.includes('DESCONECTADO')) {
                document.getElementById('statusText').textContent = t.disconnected;
            } else if (statusText.includes('CONECTADO') || statusText.includes('CONNECTED')) {
                document.getElementById('statusText').textContent = t.connected;
            } else if (statusText.includes('CAPTURANDO') || statusText.includes('CAPTURING')) {
                document.getElementById('statusText').textContent = t.capturing;
            } else if (statusText.includes('PAUSADO') || statusText.includes('PAUSED')) {
                document.getElementById('statusText').textContent = t.paused;
            }

            // Panel lateral - Secciones
            document.querySelectorAll('.section-header').forEach((header, index) => {
                const text = header.textContent.trim();
                if (text.includes('VIDEO') || text.includes('V√çDEO')) {
                    header.innerHTML = `${t.video} <span>${header.querySelector('span').textContent}</span>`;
                } else if (text.includes('VARIABLE')) {
                    header.innerHTML = `${t.variables} <span>${header.querySelector('span').textContent}</span>`;
                } else if (text.includes('CONFIGURACI√ìN DE GR√ÅFICAS') || text.includes('GRAPH CONFIGURATION') || text.includes('CONFIGURA√á√ÉO DE GR√ÅFICOS')) {
                    header.innerHTML = `${t.graphConfig} <span>${header.querySelector('span').textContent}</span>`;
                } else if (text.includes('AJUSTE DE CURVA') || text.includes('CURVE FITTING')) {
                    header.innerHTML = `${t.curveFit} <span>${header.querySelector('span').textContent}</span>`;
                } else if (text.includes('DEPURACI√ìN DE DATOS') || text.includes('DATA DEBUGGING') || text.includes('DEPURA√á√ÉO DE DADOS')) {
                    header.innerHTML = `${t.dataDebug} <span>${header.querySelector('span').textContent}</span>`;
                } else if (text.includes('DATOS') || text.includes('DATA') || text.includes('DADOS')) {
                    header.innerHTML = `${t.data} <span>${header.querySelector('span').textContent}</span>`;
                }
            });

            // Panel lateral - Botones
            const stopCameraBtn = document.getElementById('stopCameraBtn');
            if (stopCameraBtn) stopCameraBtn.textContent = t.stopCamera;

            const applyVarConfigBtn = document.getElementById('applyVarConfigBtn');
            if (applyVarConfigBtn) applyVarConfigBtn.textContent = t.applyVarConfig;

            const applyGraphConfigBtn = document.getElementById('applyGraphConfigBtn');
            if (applyGraphConfigBtn) applyGraphConfigBtn.textContent = t.applyGraphConfig;

            const setZeroBtn = document.getElementById('setZeroBtn');
            if (setZeroBtn) setZeroBtn.textContent = t.setZero;

            // Panel lateral - Labels
            document.querySelectorAll('.input-row label').forEach(label => {
                const text = label.textContent.trim();
                if (text.startsWith('N√∫mero de Variables') || text.startsWith('Number of Variables') || text.startsWith('N√∫mero de Vari√°veis')) {
                    label.textContent = t.numVars;
                } else if (text.startsWith('N√∫mero de Gr√°ficas') || text.startsWith('Number of Graphs') || text.startsWith('N√∫mero de Gr√°ficos')) {
                    label.textContent = t.numGraphs;
                } else if (text.startsWith('Nombre') && !text.includes('Variable')) {
                    label.textContent = t.varName;
                } else if (text === 'Color' || text === 'Cor') {
                    // Preservar el color preview si existe
                    const preview = label.querySelector('.color-preview');
                    label.textContent = t.color + ' ';
                    if (preview) label.appendChild(preview);
                } else if (text.startsWith('Eje X') || text.startsWith('X Axis') || text.startsWith('Eixo X')) {
                    label.textContent = t.xAxis;
                } else if (text.startsWith('Variables en Eje Y') || text.startsWith('Y Axis Variables') || text.startsWith('Vari√°veis no Eixo Y')) {
                    label.textContent = t.yVars;
                } else if (text.startsWith('Etiqueta Eje X') || text.startsWith('X Axis Label') || text.startsWith('R√≥tulo Eixo X')) {
                    label.textContent = t.xLabel;
                } else if (text.startsWith('Etiqueta Eje Y') || text.startsWith('Y Axis Label') || text.startsWith('R√≥tulo Eixo Y')) {
                    label.textContent = t.yLabel;
                } else if (text.startsWith('Unidad tiempo') || text.startsWith('Time Unit') || text.startsWith('Unidade de tempo')) {
                    label.textContent = t.timeUnit;
                } else if (text.startsWith('Mostrar L√≠neas') || text.startsWith('Show Lines') || text.startsWith('Mostrar Linhas')) {
                    label.textContent = t.showLines;
                } else if (text.startsWith('Tipo de Ajuste') || text.startsWith('Fit Type') || text.startsWith('Tipo de Ajuste')) {
                    label.textContent = t.fitType;
                } else if (text.startsWith('Variable a Ajustar') || text.startsWith('Variable to Fit') || text.startsWith('Vari√°vel a Ajustar')) {
                    label.textContent = t.fitVariable;
                } else if (text.startsWith('Gr√°fica de Referencia') || text.startsWith('Reference Graph') || text.startsWith('Gr√°fico de Refer√™ncia')) {
                    label.textContent = t.fitGraph;
                } else if (text.startsWith('Desde Punto') || text.startsWith('From Point') || text.startsWith('Do Ponto')) {
                    label.textContent = t.fromPoint;
                } else if (text.startsWith('Hasta Punto') || text.startsWith('To Point') || text.startsWith('At√© o Ponto')) {
                    label.textContent = t.toPoint;
                }
            });

            // Panel lateral - Opciones de select
            const numVarsSelect = document.getElementById('numVariables');
            if (numVarsSelect) {
                numVarsSelect.options[0].textContent = t.oneVariable;
                numVarsSelect.options[1].textContent = t.twoVariables;
                numVarsSelect.options[2].textContent = t.threeVariables;
            }

            const numGraphsSelect = document.getElementById('numGraphs');
            if (numGraphsSelect) {
                numGraphsSelect.options[0].textContent = t.oneGraph;
                numGraphsSelect.options[1].textContent = t.twoGraphs;
                numGraphsSelect.options[2].textContent = t.threeGraphs;
            }

            // Unidades de tiempo
            const timeUnitSelect = document.getElementById('timeUnit');
            if (timeUnitSelect) {
                timeUnitSelect.options[0].textContent = t.milliseconds;
                timeUnitSelect.options[1].textContent = t.seconds;
                timeUnitSelect.options[2].textContent = t.minutes;
            }

            // Opciones de eje X (Tiempo en cada select de gr√°fica)
            ['graph1XAxis', 'graph2XAxis', 'graph3XAxis'].forEach(id => {
                const select = document.getElementById(id);
                if (select && select.options[0]) {
                    select.options[0].textContent = t.time;
                }
            });

            // Tipo de ajuste
            const fitTypeSelect = document.getElementById('fitType');
            if (fitTypeSelect) {
                fitTypeSelect.options[0].textContent = t.fitLinear;
                fitTypeSelect.options[1].textContent = t.fitQuadratic;
                fitTypeSelect.options[2].textContent = t.fitCubic;
                fitTypeSelect.options[3].textContent = t.fitExponential;
                fitTypeSelect.options[4].textContent = t.fitPower;
                fitTypeSelect.options[5].textContent = t.fitLogarithmic;
                fitTypeSelect.options[6].textContent = t.fitInverse;
            }

            // Info boxes
            document.querySelectorAll('.info-box').forEach(box => {
                const text = box.innerHTML;
                if (text.includes('CONFIGURACI√ìN DE EJES') || text.includes('AXIS CONFIGURATION') || text.includes('CONFIGURA√á√ÉO DE EIXOS')) {
                    box.innerHTML = `<strong>${t.axisConfig}</strong>\n${t.axisConfigInfo}`;
                } else if (text.includes('REGRESI√ìN') || text.includes('REGRESSION') || text.includes('REGRESS√ÉO')) {
                    box.innerHTML = `<strong>${t.regressionInfo}</strong>\n${t.regressionInfoText}`;
                } else if (text.includes('ELIMINAR PUNTOS') || text.includes('DELETE POINTS') || text.includes('ELIMINAR PONTOS')) {
                    box.innerHTML = `<strong>${t.deletePoints}</strong>\n${t.deleteInfo}`;
                }
            });

            // Ajuste de curva - Radio buttons
            const fitModeAllLabel = document.querySelector('label[for="fitModeAll"]');
            if (fitModeAllLabel) fitModeAllLabel.textContent = t.allData;

            const fitModeSelectedLabel = document.querySelector('label[for="fitModeSelected"]');
            if (fitModeSelectedLabel) fitModeSelectedLabel.textContent = t.selectedPoints;

            const fitModeRangeLabel = document.querySelector('label[for="fitModeRange"]');
            if (fitModeRangeLabel) fitModeRangeLabel.textContent = t.rangePoints;

            // Ajuste de curva - Botones
            const performFitBtn = document.getElementById('performFitBtn');
            if (performFitBtn) performFitBtn.textContent = t.performFit;

            const clearFitBtn = document.getElementById('clearFitBtn');
            if (clearFitBtn) clearFitBtn.textContent = t.clearFit;

            // Depuraci√≥n de datos - Botones
            const deleteRangeBtn = document.getElementById('deleteRangeBtn');
            if (deleteRangeBtn) deleteRangeBtn.textContent = t.deleteRange;

            const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
            if (deleteSelectedBtn) deleteSelectedBtn.textContent = t.deleteSelected;

            const clearSelectionBtn = document.getElementById('clearSelectionBtn');
            if (clearSelectionBtn) clearSelectionBtn.textContent = t.clearSelection;

            // T√≠tulos de variables y gr√°ficas
            document.querySelectorAll('.variable-config h4').forEach((h4, index) => {
                h4.textContent = `${t.variable} ${index + 1}`;
            });

            // Actualizar t√≠tulos de gr√°ficas espec√≠ficamente
            const graph1Title = document.getElementById('graph1Title');
            if (graph1Title) graph1Title.textContent = `${t.graphDefault.toUpperCase()} 1`;

            const graph2Title = document.getElementById('graph2Title');
            if (graph2Title) graph2Title.textContent = `${t.graphDefault.toUpperCase()} 2`;

            const graph3Title = document.getElementById('graph3Title');
            if (graph3Title) graph3Title.textContent = `${t.graphDefault.toUpperCase()} 3`;

            // DATOS A AJUSTAR (encabezado en ajuste de curva)
            document.querySelectorAll('div[style*="font-weight: bold"]').forEach(div => {
                const text = div.textContent.trim();
                if (text === 'DATOS A AJUSTAR:' || text === 'DATA TO FIT:' || text === 'DADOS A AJUSTAR:') {
                    div.textContent = t.dataToFit;
                }
            });

            // Tabla de datos
            const tableSearch = document.getElementById('tableSearch');
            if (tableSearch) tableSearch.placeholder = t.searchPlaceholder;

            const tableFilter = document.getElementById('tableFilter');
            if (tableFilter) {
                tableFilter.options[0].textContent = t.all;
                tableFilter.options[1].textContent = t.selected;
            }

            // Texto "SIN DATOS" en tabla vac√≠a
            const dataTableBody = document.getElementById('dataTableBody');
            if (dataTableBody && dataTableBody.querySelector('td[colspan]')) {
                const emptyCell = dataTableBody.querySelector('td[colspan]');
                if (emptyCell.textContent.includes('SIN DATOS') || emptyCell.textContent.includes('NO DATA') || emptyCell.textContent.includes('SEM DADOS')) {
                    emptyCell.textContent = t.noData;
                }
            }

            // Modales - Botones cerrar
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.textContent = t.close;
            });

            // Modal de estad√≠sticas - T√≠tulo
            const statsModalHeader = document.querySelector('#statsModal .modal-header');
            if (statsModalHeader) statsModalHeader.textContent = t.statisticsTitle;

            // Placeholders
            const fitRangeFrom = document.getElementById('fitRangeFrom');
            if (fitRangeFrom) fitRangeFrom.placeholder = t.exampleFrom;

            const fitRangeTo = document.getElementById('fitRangeTo');
            if (fitRangeTo) fitRangeTo.placeholder = t.exampleTo;

            const deleteRangeFrom = document.getElementById('deleteRangeFrom');
            if (deleteRangeFrom) deleteRangeFrom.placeholder = t.initialPoint;

            const deleteRangeTo = document.getElementById('deleteRangeTo');
            if (deleteRangeTo) deleteRangeTo.placeholder = t.finalPoint;

            // Valores por defecto de inputs - Variables
            const var1Name = document.getElementById('var1Name');
            if (var1Name && (var1Name.value === 'Variable 1' || var1Name.value === 'Vari√°vel 1')) {
                var1Name.value = `${t.variableDefault} 1`;
            }

            const var2Name = document.getElementById('var2Name');
            if (var2Name && (var2Name.value === 'Variable 2' || var2Name.value === 'Vari√°vel 2')) {
                var2Name.value = `${t.variableDefault} 2`;
            }

            const var3Name = document.getElementById('var3Name');
            if (var3Name && (var3Name.value === 'Variable 3' || var3Name.value === 'Vari√°vel 3')) {
                var3Name.value = `${t.variableDefault} 3`;
            }

            // Valores por defecto - Etiquetas de ejes
            ['graph1XLabel', 'graph2XLabel', 'graph3XLabel'].forEach(id => {
                const input = document.getElementById(id);
                if (input && (input.value === 'Tiempo (s)' || input.value === 'Time (s)' || input.value === 'Tempo (s)')) {
                    input.value = t.timeSeconds;
                }
            });

            ['graph1YLabel', 'graph2YLabel', 'graph3YLabel'].forEach(id => {
                const input = document.getElementById(id);
                if (input && (input.value === 'Valor' || input.value === 'Value')) {
                    input.value = t.value;
                }
            });

            // Indicador de grabaci√≥n
            const recordingIndicator = document.getElementById('recordingIndicator');
            if (recordingIndicator) recordingIndicator.textContent = t.recording;

            // Resultados de ajuste de curva (textos est√°ticos en el HTML)
            document.querySelectorAll('#fitResults strong').forEach(strong => {
                const text = strong.textContent.trim();
                if (text === 'Ecuaci√≥n:' || text === 'Equation:' || text === 'Equa√ß√£o:') {
                    strong.textContent = t.equation;
                } else if (text === 'Coeficiente R¬≤:' || text === 'R¬≤ Coefficient:' || text === 'Coeficiente R¬≤:') {
                    strong.textContent = t.r2Coeff;
                } else if (text === 'Puntos usados:' || text === 'Points used:' || text === 'Pontos usados:') {
                    strong.textContent = t.pointsUsed;
                }
            });

            // Actualizar contenido del modal de ayuda
            updateHelpModalContent(lang);

            // Actualizar footer
            updateFooter(lang);

            // Guardar preferencia
            localStorage.setItem('microbit-language', lang);

            console.log(`Idioma cambiado a: ${lang}`);
        }

        // Funci√≥n para actualizar contenido del modal de ayuda
        function updateHelpModalContent(lang) {
            const t = translations[lang];
            document.getElementById('helpModalTitle').textContent =
                lang === 'es' ? 'TUTORIAL Y GU√çA DE USO' :
                lang === 'en' ? 'TUTORIAL AND USER GUIDE' :
                'TUTORIAL E GUIA DE USO';

            document.getElementById('helpModalClose').textContent = t.help === 'HELP' ? 'CLOSE' : t.help === 'AJUDA' ? 'FECHAR' : 'CERRAR';

            // Generar contenido seg√∫n idioma
            const content = lang === 'es' ? getHelpContentES() :
                            lang === 'en' ? getHelpContentEN() :
                            getHelpContentPT();

            document.getElementById('helpModalContent').innerHTML = content;
        }

        // Contenido del tutorial en Espa√±ol
        function getHelpContentES() {
            return `
<div class="help-accordion-header" onclick="toggleSection(this)">
    üìã COMPONENTES DEL SISTEMA <span class="help-accordion-arrow">‚ñº</span>
</div>
<div class="help-accordion-content">
    <div class="feature-item">
        <div class="feature-icon">‚óè</div>
        <div class="feature-text">
            <strong>CONECTAR</strong> - Establece conexi√≥n serial con la micro:bit v√≠a USB. Usa Web Serial API del navegador.
        </div>
    </div>
    <div class="feature-item">
        <div class="feature-icon">‚ñ∂</div>
        <div class="feature-text">
            <strong>CAPTURAR / DETENER</strong> - Inicia y detiene la captura de datos. El tiempo comienza en 0 al presionar CAPTURAR.
        </div>
    </div>
    <div class="feature-item">
        <div class="feature-icon">üìπ</div>
        <div class="feature-text">
            <strong>C√ÅMARA</strong> - Activa webcam para video sincronizado con datos. Act√≠vala ANTES de capturar.
        </div>
    </div>
    <div class="feature-item">
        <div class="feature-icon">Œ£</div>
        <div class="feature-text">
            <strong>ESTAD√çSTICAS</strong> - Calcula media, m√≠nimo, m√°ximo, desviaci√≥n est√°ndar de los datos.
        </div>
    </div>
    <div class="feature-item">
        <div class="feature-icon">üíæ</div>
        <div class="feature-text">
            <strong>EXPORTAR/IMPORTAR CSV</strong> - Guarda o carga experimentos en formato CSV.
        </div>
    </div>
    <div class="feature-item">
        <div class="feature-icon">üóëÔ∏è</div>
        <div class="feature-text">
            <strong>LIMPIAR</strong> - Elimina todos los datos y reinicia el sistema.
        </div>
    </div>
</div>

<div class="help-accordion-header" onclick="toggleSection(this)">
    ‚öôÔ∏è CONFIGURACI√ìN DE VARIABLES <span class="help-accordion-arrow">‚ñ∂</span>
</div>
<div class="help-accordion-content collapsed">
    <p>Configura hasta 3 variables simult√°neas con nombres y colores personalizados:</p>
    <ul>
        <li><strong>N√∫mero de Variables:</strong> Selecciona 1, 2 o 3 variables</li>
        <li><strong>Nombre:</strong> Personaliza el nombre de cada variable</li>
        <li><strong>Color:</strong> Asigna un color √∫nico para identificaci√≥n visual</li>
        <li>Click en <strong>APLICAR CONFIGURACI√ìN</strong> para guardar cambios</li>
    </ul>
    <p><strong>Importante:</strong> El n√∫mero de valores que env√≠a tu micro:bit debe coincidir con el n√∫mero de variables configurado.</p>
</div>

<div class="help-accordion-header" onclick="toggleSection(this)">
    üìä CONFIGURACI√ìN DE GR√ÅFICAS <span class="help-accordion-arrow">‚ñ∂</span>
</div>
<div class="help-accordion-content collapsed">
    <p>Crea hasta 3 gr√°ficas independientes con configuraci√≥n personalizada:</p>
    <ul>
        <li><strong>N√∫mero de Gr√°ficas:</strong> 1, 2 o 3 gr√°ficas simult√°neas</li>
        <li><strong>Eje X:</strong> Selecciona Tiempo o cualquier variable</li>
        <li><strong>Variables en Eje Y:</strong> Marca qu√© variables mostrar en cada gr√°fica</li>
        <li><strong>Etiquetas de Ejes:</strong> Personaliza nombres de ejes X e Y</li>
        <li><strong>Unidad de Tiempo:</strong> Milisegundos, Segundos o Minutos</li>
        <li><strong>Mostrar L√≠neas:</strong> Toggle para conectar puntos con l√≠neas</li>
    </ul>
    <p><strong>ESTABLECER T=0:</strong> Selecciona un punto en la tabla y presiona este bot√≥n para establecerlo como tiempo cero.</p>
</div>

<div class="help-accordion-header" onclick="toggleSection(this)">
    üìà AJUSTE DE CURVA (M√≠nimos Cuadrados) <span class="help-accordion-arrow">‚ñ∂</span>
</div>
<div class="help-accordion-content collapsed">
    <p>Ajusta funciones matem√°ticas a tus datos experimentales usando regresi√≥n:</p>
    <ul>
        <li><strong>Tipos de Ajuste:</strong>
            <ul>
                <li>Lineal: y = mx + b</li>
                <li>Cuadr√°tico: y = ax¬≤ + bx + c</li>
                <li>C√∫bico: y = ax¬≥ + bx¬≤ + cx + d</li>
                <li>Exponencial: y = a¬∑e^(bx)</li>
                <li>Potencia: y = a¬∑x^b</li>
                <li>Logar√≠tmico: y = a¬∑ln(x) + b</li>
                <li>Inverso: y = a/x + b</li>
            </ul>
        </li>
        <li><strong>Variable a Ajustar:</strong> Selecciona cu√°l variable analizar</li>
        <li><strong>Gr√°fica de Referencia:</strong> En qu√© gr√°fica mostrar el ajuste</li>
        <li><strong>Datos a Ajustar:</strong>
            <ul>
                <li><em>Todos los Datos:</em> Usa todos los puntos capturados</li>
                <li><em>Puntos Seleccionados:</em> Solo puntos clickeados en la gr√°fica</li>
                <li><em>Rango de Puntos:</em> Especifica desde-hasta (ej: del punto 10 al 50)</li>
            </ul>
        </li>
    </ul>
    <p>El sistema muestra la ecuaci√≥n completa, coeficiente R¬≤ y dibuja la curva de ajuste en magenta punteado.</p>
    <p><strong>Librer√≠a:</strong> Usa regression-js por Tom Alexander para c√°lculos precisos.</p>
</div>

<div class="help-accordion-header" onclick="toggleSection(this)">
    üóëÔ∏è DEPURACI√ìN DE DATOS <span class="help-accordion-arrow">‚ñ∂</span>
</div>
<div class="help-accordion-content collapsed">
    <p>Herramientas para limpiar datos incorrectos o no deseados:</p>
    <ul>
        <li><strong>Eliminar Rango:</strong> Ingresa n√∫mero de punto inicial y final (ej: del 1 al 10)</li>
        <li><strong>Eliminar Seleccionados:</strong> Borra puntos clickeados en la gr√°fica o tabla</li>
        <li><strong>Limpiar Selecci√≥n:</strong> Deselecciona todos los puntos sin eliminarlos</li>
    </ul>
    <p>Click en puntos de la gr√°fica para seleccionarlos (se marcan en rojo).</p>
</div>

<div class="help-accordion-header" onclick="toggleSection(this)">
    üìã TABLA DE DATOS <span class="help-accordion-arrow">‚ñ∂</span>
</div>
<div class="help-accordion-content collapsed">
    <p>Visualiza todos los datos capturados en formato tabular:</p>
    <ul>
        <li><strong>Buscar:</strong> Filtra datos por valor o tiempo</li>
        <li><strong>Filtro:</strong> Muestra todos o solo seleccionados</li>
        <li><strong>Columnas:</strong> # (n√∫mero), T (tiempo), V1/V2/V3 (variables), üìπ (video), selecci√≥n</li>
        <li><strong>Click en fila:</strong> Selecciona/deselecciona punto</li>
        <li><strong>Bot√≥n ‚ñ∂:</strong> Reproduce video sincronizado en ese momento exacto</li>
    </ul>
</div>

<div class="help-accordion-header" onclick="toggleSection(this)">
    üíª C√ìDIGO MICRO:BIT - UNA VARIABLE <span class="help-accordion-arrow">‚ñ∂</span>
</div>
<div class="help-accordion-content collapsed">
    <p><strong>JavaScript (MakeCode):</strong></p>
    <div class="code-block">
        <pre>basic.forever(function () {
    serial.writeNumber(input.acceleration(Dimension.X))
    serial.writeLine("")
    basic.pause(100)  // 100ms = 10 datos/segundo
})</pre>
    </div>
    <p><strong>Python (MicroPython):</strong></p>
    <div class="code-block">
        <pre>from microbit import *
while True:
    print(temperature())
    sleep(100)</pre>
    </div>
</div>

<div class="help-accordion-header" onclick="toggleSection(this)">
    üíª C√ìDIGO MICRO:BIT - M√öLTIPLES VARIABLES <span class="help-accordion-arrow">‚ñ∂</span>
</div>
<div class="help-accordion-content collapsed">
    <p>Env√≠a valores <strong>separados por comas</strong>:</p>
    <p><strong>2 Variables (JavaScript):</strong></p>
    <div class="code-block">
        <pre>basic.forever(function () {
    let x = input.acceleration(Dimension.X)
    let y = input.acceleration(Dimension.Y)
    serial.writeLine("" + x + "," + y)
    basic.pause(100)
})</pre>
    </div>
    <p><strong>3 Variables (Python):</strong></p>
    <div class="code-block">
        <pre>from microbit import *
while True:
    x = accelerometer.get_x()
    y = accelerometer.get_y()
    z = accelerometer.get_z()
    print("{},{},{}".format(x, y, z))
    sleep(50)</pre>
    </div>
</div>

<div class="help-accordion-header" onclick="toggleSection(this)">
    üìπ VIDEO SINCRONIZADO <span class="help-accordion-arrow">‚ñ∂</span>
</div>
<div class="help-accordion-content collapsed">
    <ul>
        <li>Activa <strong>C√ÅMARA</strong> antes de presionar CAPTURAR</li>
        <li>El video y datos inician juntos autom√°ticamente</li>
        <li>Cada dato tiene timestamp vinculado al video</li>
        <li>Click en ‚ñ∂ en la tabla para ver ese momento exacto</li>
        <li>El video se reproduce desde el instante del punto</li>
    </ul>
</div>

<div class="help-accordion-header" onclick="toggleSection(this)">
    ‚ö° FRECUENCIAS RECOMENDADAS <span class="help-accordion-arrow">‚ñ∂</span>
</div>
<div class="help-accordion-content collapsed">
    <table style="width:100%; border-collapse:collapse; margin-top:10px;">
        <tr style="background:#f5f5f5; border-bottom:2px solid black;">
            <td style="padding:8px; font-weight:bold;">Experimento</td>
            <td style="padding:8px; font-weight:bold;">Frecuencia</td>
            <td style="padding:8px; font-weight:bold;">Pausa (ms)</td>
        </tr>
        <tr style="border-bottom:1px solid #ccc;">
            <td style="padding:8px;">Temperatura</td>
            <td style="padding:8px;">1-2 Hz</td>
            <td style="padding:8px;">500-1000</td>
        </tr>
        <tr style="border-bottom:1px solid #ccc;">
            <td style="padding:8px;">Luz ambiental</td>
            <td style="padding:8px;">5-10 Hz</td>
            <td style="padding:8px;">100-200</td>
        </tr>
        <tr style="border-bottom:1px solid #ccc;">
            <td style="padding:8px;">Aceler√≥metro</td>
            <td style="padding:8px;">20-100 Hz</td>
            <td style="padding:8px;">10-50</td>
        </tr>
    </table>
</div>

<div class="help-accordion-header" onclick="toggleSection(this)">
    ‚ùì SOLUCI√ìN DE PROBLEMAS <span class="help-accordion-arrow">‚ñ∂</span>
</div>
<div class="help-accordion-content collapsed">
    <p><strong>No aparece el puerto:</strong> Verifica cable USB, prueba otro puerto, reinicia navegador.</p>
    <p><strong>No llegan datos:</strong> Aseg√∫rate de usar serial.writeNumber() + serial.writeLine(""). No env√≠es texto.</p>
    <p><strong>C√°mara no funciona:</strong> Permite acceso cuando el navegador lo solicite. Verifica que otra app no la use.</p>
    <p><strong>Video no sincroniza:</strong> Activa c√°mara ANTES de presionar CAPTURAR.</p>
</div>

<div class="help-accordion-header" onclick="toggleSection(this)">
    üìú LICENCIA Y CR√âDITOS <span class="help-accordion-arrow">‚ñ∂</span>
</div>
<div class="help-accordion-content collapsed">
    <p>Desarrollado por <strong>Martin Ferreira</strong> y <strong>Pablo Godoy</strong></p>
    <p>Licencia: <strong>Creative Commons BY-SA 4.0</strong></p>
    <p>Librer√≠as: regression-js (Tom Alexander), Chart.js</p>
</div>
`;
        }

        // Contenido del tutorial en Ingl√©s
        function getHelpContentEN() {
            return `
<div class="help-accordion-header" onclick="toggleSection(this)">
    üìã SYSTEM COMPONENTS <span class="help-accordion-arrow">‚ñº</span>
</div>
<div class="help-accordion-content">
    <div class="feature-item">
        <div class="feature-icon">‚óè</div>
        <div class="feature-text">
            <strong>CONNECT</strong> - Establishes serial connection with micro:bit via USB. Uses browser's Web Serial API.
        </div>
    </div>
    <div class="feature-item">
        <div class="feature-icon">‚ñ∂</div>
        <div class="feature-text">
            <strong>CAPTURE / STOP</strong> - Starts and stops data capture. Time starts at 0 when pressing CAPTURE.
        </div>
    </div>
    <div class="feature-item">
        <div class="feature-icon">üìπ</div>
        <div class="feature-text">
            <strong>CAMERA</strong> - Activates webcam for synchronized video. Activate BEFORE capturing.
        </div>
    </div>
    <div class="feature-item">
        <div class="feature-icon">Œ£</div>
        <div class="feature-text">
            <strong>STATISTICS</strong> - Calculates mean, min, max, standard deviation of data.
        </div>
    </div>
    <div class="feature-item">
        <div class="feature-icon">üíæ</div>
        <div class="feature-text">
            <strong>EXPORT/IMPORT CSV</strong> - Save or load experiments in CSV format.
        </div>
    </div>
    <div class="feature-item">
        <div class="feature-icon">üóëÔ∏è</div>
        <div class="feature-text">
            <strong>CLEAR</strong> - Deletes all data and resets the system.
        </div>
    </div>
</div>

<div class="help-accordion-header" onclick="toggleSection(this)">
    ‚öôÔ∏è VARIABLE CONFIGURATION <span class="help-accordion-arrow">‚ñ∂</span>
</div>
<div class="help-accordion-content collapsed">
    <p>Configure up to 3 simultaneous variables with custom names and colors:</p>
    <ul>
        <li><strong>Number of Variables:</strong> Select 1, 2 or 3 variables</li>
        <li><strong>Name:</strong> Customize each variable's name</li>
        <li><strong>Color:</strong> Assign unique color for visual identification</li>
        <li>Click <strong>APPLY CONFIGURATION</strong> to save changes</li>
    </ul>
    <p><strong>Important:</strong> Number of values sent by your micro:bit must match the configured number of variables.</p>
</div>

<div class="help-accordion-header" onclick="toggleSection(this)">
    üìä GRAPH CONFIGURATION <span class="help-accordion-arrow">‚ñ∂</span>
</div>
<div class="help-accordion-content collapsed">
    <p>Create up to 3 independent graphs with custom settings:</p>
    <ul>
        <li><strong>Number of Graphs:</strong> 1, 2 or 3 simultaneous graphs</li>
        <li><strong>X Axis:</strong> Select Time or any variable</li>
        <li><strong>Y Axis Variables:</strong> Check which variables to display on each graph</li>
        <li><strong>Axis Labels:</strong> Customize X and Y axis names</li>
        <li><strong>Time Unit:</strong> Milliseconds, Seconds or Minutes</li>
        <li><strong>Show Lines:</strong> Toggle to connect points with lines</li>
    </ul>
    <p><strong>SET T=0:</strong> Select a point in the table and press this button to set it as time zero.</p>
</div>

<div class="help-accordion-header" onclick="toggleSection(this)">
    üìà CURVE FITTING (Least Squares) <span class="help-accordion-arrow">‚ñ∂</span>
</div>
<div class="help-accordion-content collapsed">
    <p>Fit mathematical functions to experimental data using regression:</p>
    <ul>
        <li><strong>Fit Types:</strong>
            <ul>
                <li>Linear: y = mx + b</li>
                <li>Quadratic: y = ax¬≤ + bx + c</li>
                <li>Cubic: y = ax¬≥ + bx¬≤ + cx + d</li>
                <li>Exponential: y = a¬∑e^(bx)</li>
                <li>Power: y = a¬∑x^b</li>
                <li>Logarithmic: y = a¬∑ln(x) + b</li>
                <li>Inverse: y = a/x + b</li>
            </ul>
        </li>
        <li><strong>Variable to Fit:</strong> Select which variable to analyze</li>
        <li><strong>Reference Graph:</strong> Which graph to show the fit on</li>
        <li><strong>Data to Fit:</strong>
            <ul>
                <li><em>All Data:</em> Use all captured points</li>
                <li><em>Selected Points:</em> Only points clicked on graph</li>
                <li><em>Point Range:</em> Specify from-to (e.g., point 10 to 50)</li>
            </ul>
        </li>
    </ul>
    <p>System displays complete equation, R¬≤ coefficient and draws fit curve in dashed magenta.</p>
    <p><strong>Library:</strong> Uses regression-js by Tom Alexander for precise calculations.</p>
</div>

<div class="help-accordion-header" onclick="toggleSection(this)">
    üóëÔ∏è DATA DEBUGGING <span class="help-accordion-arrow">‚ñ∂</span>
</div>
<div class="help-accordion-content collapsed">
    <p>Tools to clean incorrect or unwanted data:</p>
    <ul>
        <li><strong>Delete Range:</strong> Enter initial and final point numbers (e.g., 1 to 10)</li>
        <li><strong>Delete Selected:</strong> Remove points clicked on graph or table</li>
        <li><strong>Clear Selection:</strong> Deselect all points without deleting</li>
    </ul>
    <p>Click points on graph to select them (marked in red).</p>
</div>

<div class="help-accordion-header" onclick="toggleSection(this)">
    üìã DATA TABLE <span class="help-accordion-arrow">‚ñ∂</span>
</div>
<div class="help-accordion-content collapsed">
    <p>View all captured data in tabular format:</p>
    <ul>
        <li><strong>Search:</strong> Filter data by value or time</li>
        <li><strong>Filter:</strong> Show all or only selected</li>
        <li><strong>Columns:</strong> # (number), T (time), V1/V2/V3 (variables), üìπ (video), selection</li>
        <li><strong>Click row:</strong> Select/deselect point</li>
        <li><strong>‚ñ∂ Button:</strong> Play synchronized video at that exact moment</li>
    </ul>
</div>

<div class="help-accordion-header" onclick="toggleSection(this)">
    üíª MICRO:BIT CODE - SINGLE VARIABLE <span class="help-accordion-arrow">‚ñ∂</span>
</div>
<div class="help-accordion-content collapsed">
    <p><strong>JavaScript (MakeCode):</strong></p>
    <div class="code-block">
        <pre>basic.forever(function () {
    serial.writeNumber(input.acceleration(Dimension.X))
    serial.writeLine("")
    basic.pause(100)  // 100ms = 10 data/second
})</pre>
    </div>
    <p><strong>Python (MicroPython):</strong></p>
    <div class="code-block">
        <pre>from microbit import *
while True:
    print(temperature())
    sleep(100)</pre>
    </div>
</div>

<div class="help-accordion-header" onclick="toggleSection(this)">
    üíª MICRO:BIT CODE - MULTIPLE VARIABLES <span class="help-accordion-arrow">‚ñ∂</span>
</div>
<div class="help-accordion-content collapsed">
    <p>Send values <strong>separated by commas</strong>:</p>
    <p><strong>2 Variables (JavaScript):</strong></p>
    <div class="code-block">
        <pre>basic.forever(function () {
    let x = input.acceleration(Dimension.X)
    let y = input.acceleration(Dimension.Y)
    serial.writeLine("" + x + "," + y)
    basic.pause(100)
})</pre>
    </div>
    <p><strong>3 Variables (Python):</strong></p>
    <div class="code-block">
        <pre>from microbit import *
while True:
    x = accelerometer.get_x()
    y = accelerometer.get_y()
    z = accelerometer.get_z()
    print("{},{},{}".format(x, y, z))
    sleep(50)</pre>
    </div>
</div>

<div class="help-accordion-header" onclick="toggleSection(this)">
    üìπ SYNCHRONIZED VIDEO <span class="help-accordion-arrow">‚ñ∂</span>
</div>
<div class="help-accordion-content collapsed">
    <ul>
        <li>Activate <strong>CAMERA</strong> before pressing CAPTURE</li>
        <li>Video and data start together automatically</li>
        <li>Each data point has timestamp linked to video</li>
        <li>Click ‚ñ∂ in table to see that exact moment</li>
        <li>Video plays from the instant of the point</li>
    </ul>
</div>

<div class="help-accordion-header" onclick="toggleSection(this)">
    ‚ö° RECOMMENDED FREQUENCIES <span class="help-accordion-arrow">‚ñ∂</span>
</div>
<div class="help-accordion-content collapsed">
    <table style="width:100%; border-collapse:collapse; margin-top:10px;">
        <tr style="background:#f5f5f5; border-bottom:2px solid black;">
            <td style="padding:8px; font-weight:bold;">Experiment</td>
            <td style="padding:8px; font-weight:bold;">Frequency</td>
            <td style="padding:8px; font-weight:bold;">Pause (ms)</td>
        </tr>
        <tr style="border-bottom:1px solid #ccc;">
            <td style="padding:8px;">Temperature</td>
            <td style="padding:8px;">1-2 Hz</td>
            <td style="padding:8px;">500-1000</td>
        </tr>
        <tr style="border-bottom:1px solid #ccc;">
            <td style="padding:8px;">Ambient light</td>
            <td style="padding:8px;">5-10 Hz</td>
            <td style="padding:8px;">100-200</td>
        </tr>
        <tr style="border-bottom:1px solid #ccc;">
            <td style="padding:8px;">Accelerometer</td>
            <td style="padding:8px;">20-100 Hz</td>
            <td style="padding:8px;">10-50</td>
        </tr>
    </table>
</div>

<div class="help-accordion-header" onclick="toggleSection(this)">
    ‚ùì TROUBLESHOOTING <span class="help-accordion-arrow">‚ñ∂</span>
</div>
<div class="help-accordion-content collapsed">
    <p><strong>Port doesn't appear:</strong> Check USB cable, try another port, restart browser.</p>
    <p><strong>No data arriving:</strong> Make sure to use serial.writeNumber() + serial.writeLine(""). Don't send text.</p>
    <p><strong>Camera not working:</strong> Allow access when browser requests. Check no other app is using it.</p>
    <p><strong>Video doesn't sync:</strong> Activate camera BEFORE pressing CAPTURE.</p>
</div>

<div class="help-accordion-header" onclick="toggleSection(this)">
    üìú LICENSE AND CREDITS <span class="help-accordion-arrow">‚ñ∂</span>
</div>
<div class="help-accordion-content collapsed">
    <p>Developed by <strong>Martin Ferreira</strong> and <strong>Pablo Godoy</strong></p>
    <p>License: <strong>Creative Commons BY-SA 4.0</strong></p>
    <p>Libraries: regression-js (Tom Alexander), Chart.js</p>
</div>
`;
        }

        // Contenido del tutorial en Portugu√©s
        function getHelpContentPT() {
            return `
<div class="help-accordion-header" onclick="toggleSection(this)">
    üìã COMPONENTES DO SISTEMA <span class="help-accordion-arrow">‚ñº</span>
</div>
<div class="help-accordion-content">
    <div class="feature-item">
        <div class="feature-icon">‚óè</div>
        <div class="feature-text">
            <strong>CONECTAR</strong> - Estabelece conex√£o serial com micro:bit via USB. Usa Web Serial API do navegador.
        </div>
    </div>
    <div class="feature-item">
        <div class="feature-icon">‚ñ∂</div>
        <div class="feature-text">
            <strong>CAPTURAR / PARAR</strong> - Inicia e para captura de dados. O tempo come√ßa em 0 ao pressionar CAPTURAR.
        </div>
    </div>
    <div class="feature-item">
        <div class="feature-icon">üìπ</div>
        <div class="feature-text">
            <strong>C√ÇMERA</strong> - Ativa webcam para v√≠deo sincronizado. Ative ANTES de capturar.
        </div>
    </div>
    <div class="feature-item">
        <div class="feature-icon">Œ£</div>
        <div class="feature-text">
            <strong>ESTAT√çSTICAS</strong> - Calcula m√©dia, m√≠nimo, m√°ximo, desvio padr√£o dos dados.
        </div>
    </div>
    <div class="feature-item">
        <div class="feature-icon">üíæ</div>
        <div class="feature-text">
            <strong>EXPORTAR/IMPORTAR CSV</strong> - Salva ou carrega experimentos em formato CSV.
        </div>
    </div>
    <div class="feature-item">
        <div class="feature-icon">üóëÔ∏è</div>
        <div class="feature-text">
            <strong>LIMPAR</strong> - Elimina todos os dados e reinicia o sistema.
        </div>
    </div>
</div>

<div class="help-accordion-header" onclick="toggleSection(this)">
    ‚öôÔ∏è CONFIGURA√á√ÉO DE VARI√ÅVEIS <span class="help-accordion-arrow">‚ñ∂</span>
</div>
<div class="help-accordion-content collapsed">
    <p>Configure at√© 3 vari√°veis simult√¢neas com nomes e cores personalizadas:</p>
    <ul>
        <li><strong>N√∫mero de Vari√°veis:</strong> Selecione 1, 2 ou 3 vari√°veis</li>
        <li><strong>Nome:</strong> Personalize o nome de cada vari√°vel</li>
        <li><strong>Cor:</strong> Atribua cor √∫nica para identifica√ß√£o visual</li>
        <li>Clique em <strong>APLICAR CONFIGURA√á√ÉO</strong> para salvar altera√ß√µes</li>
    </ul>
    <p><strong>Importante:</strong> O n√∫mero de valores enviados pelo seu micro:bit deve coincidir com o n√∫mero de vari√°veis configuradas.</p>
</div>

<div class="help-accordion-header" onclick="toggleSection(this)">
    üìä CONFIGURA√á√ÉO DE GR√ÅFICOS <span class="help-accordion-arrow">‚ñ∂</span>
</div>
<div class="help-accordion-content collapsed">
    <p>Crie at√© 3 gr√°ficos independentes com configura√ß√£o personalizada:</p>
    <ul>
        <li><strong>N√∫mero de Gr√°ficos:</strong> 1, 2 ou 3 gr√°ficos simult√¢neos</li>
        <li><strong>Eixo X:</strong> Selecione Tempo ou qualquer vari√°vel</li>
        <li><strong>Vari√°veis no Eixo Y:</strong> Marque quais vari√°veis mostrar em cada gr√°fico</li>
        <li><strong>R√≥tulos dos Eixos:</strong> Personalize nomes dos eixos X e Y</li>
        <li><strong>Unidade de Tempo:</strong> Milissegundos, Segundos ou Minutos</li>
        <li><strong>Mostrar Linhas:</strong> Ative/desative para conectar pontos com linhas</li>
    </ul>
    <p><strong>DEFINIR T=0:</strong> Selecione um ponto na tabela e pressione este bot√£o para estabelec√™-lo como tempo zero.</p>
</div>

<div class="help-accordion-header" onclick="toggleSection(this)">
    üìà AJUSTE DE CURVA (M√≠nimos Quadrados) <span class="help-accordion-arrow">‚ñ∂</span>
</div>
<div class="help-accordion-content collapsed">
    <p>Ajuste fun√ß√µes matem√°ticas aos seus dados experimentais usando regress√£o:</p>
    <ul>
        <li><strong>Tipos de Ajuste:</strong>
            <ul>
                <li>Linear: y = mx + b</li>
                <li>Quadr√°tico: y = ax¬≤ + bx + c</li>
                <li>C√∫bico: y = ax¬≥ + bx¬≤ + cx + d</li>
                <li>Exponencial: y = a¬∑e^(bx)</li>
                <li>Pot√™ncia: y = a¬∑x^b</li>
                <li>Logar√≠tmico: y = a¬∑ln(x) + b</li>
                <li>Inverso: y = a/x + b</li>
            </ul>
        </li>
        <li><strong>Vari√°vel a Ajustar:</strong> Selecione qual vari√°vel analisar</li>
        <li><strong>Gr√°fico de Refer√™ncia:</strong> Em qual gr√°fico mostrar o ajuste</li>
        <li><strong>Dados a Ajustar:</strong>
            <ul>
                <li><em>Todos os Dados:</em> Usa todos os pontos capturados</li>
                <li><em>Pontos Selecionados:</em> Apenas pontos clicados no gr√°fico</li>
                <li><em>Intervalo de Pontos:</em> Especifique de-at√© (ex: do ponto 10 ao 50)</li>
            </ul>
        </li>
    </ul>
    <p>O sistema mostra a equa√ß√£o completa, coeficiente R¬≤ e desenha a curva de ajuste em magenta pontilhado.</p>
    <p><strong>Biblioteca:</strong> Usa regression-js por Tom Alexander para c√°lculos precisos.</p>
</div>

<div class="help-accordion-header" onclick="toggleSection(this)">
    üóëÔ∏è DEPURA√á√ÉO DE DADOS <span class="help-accordion-arrow">‚ñ∂</span>
</div>
<div class="help-accordion-content collapsed">
    <p>Ferramentas para limpar dados incorretos ou indesejados:</p>
    <ul>
        <li><strong>Eliminar Intervalo:</strong> Digite n√∫mero do ponto inicial e final (ex: de 1 a 10)</li>
        <li><strong>Eliminar Selecionados:</strong> Remove pontos clicados no gr√°fico ou tabela</li>
        <li><strong>Limpar Sele√ß√£o:</strong> Desmarca todos os pontos sem elimin√°-los</li>
    </ul>
    <p>Clique nos pontos do gr√°fico para selecion√°-los (marcados em vermelho).</p>
</div>

<div class="help-accordion-header" onclick="toggleSection(this)">
    üìã TABELA DE DADOS <span class="help-accordion-arrow">‚ñ∂</span>
</div>
<div class="help-accordion-content collapsed">
    <p>Visualize todos os dados capturados em formato tabular:</p>
    <ul>
        <li><strong>Buscar:</strong> Filtra dados por valor ou tempo</li>
        <li><strong>Filtro:</strong> Mostra todos ou apenas selecionados</li>
        <li><strong>Colunas:</strong> # (n√∫mero), T (tempo), V1/V2/V3 (vari√°veis), üìπ (v√≠deo), sele√ß√£o</li>
        <li><strong>Clicar em linha:</strong> Seleciona/deseleciona ponto</li>
        <li><strong>Bot√£o ‚ñ∂:</strong> Reproduz v√≠deo sincronizado naquele momento exato</li>
    </ul>
</div>

<div class="help-accordion-header" onclick="toggleSection(this)">
    üíª C√ìDIGO MICRO:BIT - UMA VARI√ÅVEL <span class="help-accordion-arrow">‚ñ∂</span>
</div>
<div class="help-accordion-content collapsed">
    <p><strong>JavaScript (MakeCode):</strong></p>
    <div class="code-block">
        <pre>basic.forever(function () {
    serial.writeNumber(input.acceleration(Dimension.X))
    serial.writeLine("")
    basic.pause(100)  // 100ms = 10 dados/segundo
})</pre>
    </div>
    <p><strong>Python (MicroPython):</strong></p>
    <div class="code-block">
        <pre>from microbit import *
while True:
    print(temperature())
    sleep(100)</pre>
    </div>
</div>

<div class="help-accordion-header" onclick="toggleSection(this)">
    üíª C√ìDIGO MICRO:BIT - M√öLTIPLAS VARI√ÅVEIS <span class="help-accordion-arrow">‚ñ∂</span>
</div>
<div class="help-accordion-content collapsed">
    <p>Envie valores <strong>separados por v√≠rgulas</strong>:</p>
    <p><strong>2 Vari√°veis (JavaScript):</strong></p>
    <div class="code-block">
        <pre>basic.forever(function () {
    let x = input.acceleration(Dimension.X)
    let y = input.acceleration(Dimension.Y)
    serial.writeLine("" + x + "," + y)
    basic.pause(100)
})</pre>
    </div>
    <p><strong>3 Vari√°veis (Python):</strong></p>
    <div class="code-block">
        <pre>from microbit import *
while True:
    x = accelerometer.get_x()
    y = accelerometer.get_y()
    z = accelerometer.get_z()
    print("{},{},{}".format(x, y, z))
    sleep(50)</pre>
    </div>
</div>

<div class="help-accordion-header" onclick="toggleSection(this)">
    üìπ V√çDEO SINCRONIZADO <span class="help-accordion-arrow">‚ñ∂</span>
</div>
<div class="help-accordion-content collapsed">
    <ul>
        <li>Ative <strong>C√ÇMERA</strong> antes de pressionar CAPTURAR</li>
        <li>V√≠deo e dados iniciam juntos automaticamente</li>
        <li>Cada dado tem timestamp vinculado ao v√≠deo</li>
        <li>Clique em ‚ñ∂ na tabela para ver aquele momento exato</li>
        <li>O v√≠deo √© reproduzido a partir do instante do ponto</li>
    </ul>
</div>

<div class="help-accordion-header" onclick="toggleSection(this)">
    ‚ö° FREQU√äNCIAS RECOMENDADAS <span class="help-accordion-arrow">‚ñ∂</span>
</div>
<div class="help-accordion-content collapsed">
    <table style="width:100%; border-collapse:collapse; margin-top:10px;">
        <tr style="background:#f5f5f5; border-bottom:2px solid black;">
            <td style="padding:8px; font-weight:bold;">Experimento</td>
            <td style="padding:8px; font-weight:bold;">Frequ√™ncia</td>
            <td style="padding:8px; font-weight:bold;">Pausa (ms)</td>
        </tr>
        <tr style="border-bottom:1px solid #ccc;">
            <td style="padding:8px;">Temperatura</td>
            <td style="padding:8px;">1-2 Hz</td>
            <td style="padding:8px;">500-1000</td>
        </tr>
        <tr style="border-bottom:1px solid #ccc;">
            <td style="padding:8px;">Luz ambiente</td>
            <td style="padding:8px;">5-10 Hz</td>
            <td style="padding:8px;">100-200</td>
        </tr>
        <tr style="border-bottom:1px solid #ccc;">
            <td style="padding:8px;">Aceler√¥metro</td>
            <td style="padding:8px;">20-100 Hz</td>
            <td style="padding:8px;">10-50</td>
        </tr>
    </table>
</div>

<div class="help-accordion-header" onclick="toggleSection(this)">
    ‚ùì SOLU√á√ÉO DE PROBLEMAS <span class="help-accordion-arrow">‚ñ∂</span>
</div>
<div class="help-accordion-content collapsed">
    <p><strong>Porta n√£o aparece:</strong> Verifique cabo USB, tente outra porta, reinicie navegador.</p>
    <p><strong>Dados n√£o chegam:</strong> Certifique-se de usar serial.writeNumber() + serial.writeLine(""). N√£o envie texto.</p>
    <p><strong>C√¢mera n√£o funciona:</strong> Permita acesso quando o navegador solicitar. Verifique se outro app n√£o est√° usando.</p>
    <p><strong>V√≠deo n√£o sincroniza:</strong> Ative c√¢mera ANTES de pressionar CAPTURAR.</p>
</div>

<div class="help-accordion-header" onclick="toggleSection(this)">
    üìú LICEN√áA E CR√âDITOS <span class="help-accordion-arrow">‚ñ∂</span>
</div>
<div class="help-accordion-content collapsed">
    <p>Desenvolvido por <strong>Martin Ferreira</strong> e <strong>Pablo Godoy</strong></p>
    <p>Licen√ßa: <strong>Creative Commons BY-SA 4.0</strong></p>
    <p>Bibliotecas: regression-js (Tom Alexander), Chart.js</p>
</div>
`;
        }

        // Cargar idioma guardado o detectar idioma del navegador
        function loadLanguage() {
            let savedLang = localStorage.getItem('microbit-language');

            if (!savedLang) {
                // Detectar idioma del navegador
                const browserLang = navigator.language || navigator.userLanguage;
                if (browserLang.startsWith('es')) savedLang = 'es';
                else if (browserLang.startsWith('pt')) savedLang = 'pt';
                else savedLang = 'en';
            }

            currentLanguage = savedLang; // Establecer idioma actual
            document.getElementById('languageSelector').value = savedLang;
            changeLanguage(savedLang);
        }

        // Estado global
        let state = {
            port: null,
            reader: null,
            isConnected: false,
            isCollecting: false,
            rawData: [],  // Array de objetos {time, values: [v1, v2, v3], id}
            selectedPoints: new Set(),
            timeZeroOffset: 0,
            // Configuraci√≥n de variables
            numVariables: 1,
            variables: [
                { name: 'Variable 1', color: '#000000' },
                { name: 'Variable 2', color: '#ff0000' },
                { name: 'Variable 3', color: '#0000ff' }
            ],
            // Configuraci√≥n de gr√°ficas
            numGraphs: 1,
            graphs: [
                { xAxis: 'time', yVars: [0], xLabel: 'Tiempo (s)', yLabel: 'Valor' },
                { xAxis: 'time', yVars: [0], xLabel: 'Tiempo (s)', yLabel: 'Valor' },
                { xAxis: 'time', yVars: [0], xLabel: 'Tiempo (s)', yLabel: 'Valor' }
            ],
            showLines: true,
            // Video
            cameraActive: false,
            mediaStream: null,
            mediaRecorder: null,
            recordedChunks: [],
            videoBlob: null,
            recordingStartTime: null,
            // Charts
            charts: [],
            // Curve Fitting
            fitResult: null  // {type, coeffs, equation, r2, graphIndex, varIndex, dataPoints}
        };

        // ========== INICIALIZACI√ìN ==========

        if (!('serial' in navigator)) {
            alert('Web Serial API no soportada. Usa Chrome, Edge u Opera.');
        }

        // Inicializar configuraci√≥n
        initializeConfiguration();
        updateGraphsDisplay();

        // Inicializar idioma
        loadLanguage();

        // Event listener para cambio de idioma
        document.getElementById('languageSelector').addEventListener('change', function() {
            changeLanguage(this.value);
        });

        // ========== CONFIGURACI√ìN DE VARIABLES ==========

        document.getElementById('numVariables').addEventListener('change', function() {
            const num = parseInt(this.value);
            document.getElementById('var1Config').classList.remove('hidden');
            document.getElementById('var2Config').classList.toggle('hidden', num < 2);
            document.getElementById('var3Config').classList.toggle('hidden', num < 3);
        });

        // Color previews
        ['var1', 'var2', 'var3'].forEach((varId, idx) => {
            const colorInput = document.getElementById(varId + 'Color');
            const preview = document.getElementById(varId + 'ColorPreview');
            colorInput.addEventListener('input', function() {
                preview.style.background = this.value;
            });
        });

        document.getElementById('applyVarConfigBtn').addEventListener('click', applyVariableConfiguration);

        function applyVariableConfiguration() {
            const num = parseInt(document.getElementById('numVariables').value);
            state.numVariables = num;

            for (let i = 0; i < 3; i++) {
                if (i < num) {
                    state.variables[i].name = document.getElementById(`var${i+1}Name`).value;
                    state.variables[i].color = document.getElementById(`var${i+1}Color`).value;
                }
            }

            updateGraphConfiguration();
            updateDataTableHeader();
            updateGraphsDisplay();
            updateFitVariableOptions();

            alert(`Configuraci√≥n aplicada: ${num} variable(s)`);
        }

        // ========== CONFIGURACI√ìN DE GR√ÅFICAS ==========

        document.getElementById('numGraphs').addEventListener('change', function() {
            const num = parseInt(this.value);
            document.getElementById('graph1Config').classList.remove('hidden');
            document.getElementById('graph2Config').classList.toggle('hidden', num < 2);
            document.getElementById('graph3Config').classList.toggle('hidden', num < 3);
        });

        document.getElementById('showLinesToggle').addEventListener('change', function() {
            state.showLines = this.checked;
            updateAllCharts();
        });

        document.getElementById('applyGraphConfigBtn').addEventListener('click', applyGraphConfiguration);

        function initializeConfiguration() {
            updateGraphConfiguration();
            updateFitVariableOptions();
            updateFitGraphOptions();
        }

        function updateGraphConfiguration() {
            const t = translations[currentLanguage];

            // Actualizar opciones de eje X para incluir variables
            for (let g = 1; g <= 3; g++) {
                const select = document.getElementById(`graph${g}XAxis`);
                select.innerHTML = `<option value="time">${t.time}</option>`;

                for (let i = 0; i < state.numVariables; i++) {
                    const option = document.createElement('option');
                    option.value = `var${i}`;
                    option.textContent = state.variables[i].name;
                    select.appendChild(option);
                }
            }

            // Actualizar checkboxes de variables en Y
            for (let g = 1; g <= 3; g++) {
                const container = document.getElementById(`graph${g}YVars`);
                container.innerHTML = '';

                for (let i = 0; i < state.numVariables; i++) {
                    const div = document.createElement('div');
                    div.className = 'checkbox-row';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `graph${g}Var${i}`;
                    checkbox.value = i;
                    checkbox.checked = (i === 0);

                    const label = document.createElement('label');
                    label.htmlFor = checkbox.id;
                    label.textContent = state.variables[i].name;

                    const colorSpan = document.createElement('span');
                    colorSpan.className = 'color-preview';
                    colorSpan.style.background = state.variables[i].color;

                    div.appendChild(checkbox);
                    div.appendChild(label);
                    label.appendChild(colorSpan);
                    container.appendChild(div);
                }
            }
        }

        function applyGraphConfiguration() {
            state.numGraphs = parseInt(document.getElementById('numGraphs').value);
            state.showLines = document.getElementById('showLinesToggle').checked;

            // Guardar configuraci√≥n de cada gr√°fica
            for (let g = 0; g < 3; g++) {
                const graphNum = g + 1;
                state.graphs[g].xAxis = document.getElementById(`graph${graphNum}XAxis`).value;
                state.graphs[g].xLabel = document.getElementById(`graph${graphNum}XLabel`).value;
                state.graphs[g].yLabel = document.getElementById(`graph${graphNum}YLabel`).value;

                // Obtener variables seleccionadas para eje Y
                const yVars = [];
                for (let i = 0; i < state.numVariables; i++) {
                    const checkbox = document.getElementById(`graph${graphNum}Var${i}`);
                    if (checkbox && checkbox.checked) {
                        yVars.push(i);
                    }
                }
                state.graphs[g].yVars = yVars;
            }

            // Limpiar ajuste de curva ya que la configuraci√≥n cambi√≥
            state.fitResult = null;
            document.getElementById('fitResults').style.display = 'none';

            updateGraphsDisplay();
            updateFitGraphOptions();
            alert('Configuraci√≥n de gr√°ficas aplicada');
        }

        function updateGraphsDisplay() {
            const container = document.getElementById('graphsContainer');
            container.innerHTML = '';
            state.charts = [];

            const classMap = { 1: 'single', 2: 'double', 3: 'triple' };

            for (let i = 0; i < state.numGraphs; i++) {
                const wrapper = document.createElement('div');
                wrapper.className = `graph-wrapper ${classMap[state.numGraphs]}`;

                const title = document.createElement('div');
                title.className = 'graph-title';
                title.id = `graphTitle${i}`;
                title.textContent = `GR√ÅFICA ${i + 1}`;

                const chartContainer = document.createElement('div');
                chartContainer.className = 'chart-container';

                const canvas = document.createElement('canvas');
                canvas.id = `chart${i}`;

                chartContainer.appendChild(canvas);
                wrapper.appendChild(title);
                wrapper.appendChild(chartContainer);
                container.appendChild(wrapper);

                // Crear chart
                createChart(i);
            }

            // Restaurar datos si existen
            if (state.rawData.length > 0) {
                updateAllCharts();
                updateDataTable();
            }
        }

        function createChart(index) {
            const canvas = document.getElementById(`chart${index}`);
            const ctx = canvas.getContext('2d');

            const chart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    onClick: (evt) => handleChartClick(evt, index),
                    plugins: {
                        legend: {
                            display: state.graphs[index].yVars.length > 1,
                            position: 'top'
                        },
                        tooltip: {
                            enabled: true,
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(4)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: state.graphs[index].xLabel.toUpperCase(),
                                font: { size: 11, weight: 'bold' }
                            },
                            grid: { color: '#e0e0e0', borderColor: '#000', borderWidth: 2 },
                            ticks: { font: { size: 10 } }
                        },
                        y: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: state.graphs[index].yLabel.toUpperCase(),
                                font: { size: 11, weight: 'bold' }
                            },
                            grid: { color: '#e0e0e0', borderColor: '#000', borderWidth: 2 },
                            ticks: { font: { size: 10 } }
                        }
                    }
                }
            });

            state.charts[index] = chart;
        }

        function updateDataTableHeader() {
            const header = document.getElementById('dataTableHeader');
            let html = '<th>#</th><th>T</th>';

            for (let i = 0; i < state.numVariables; i++) {
                html += `<th>${state.variables[i].name.substring(0, 8)}</th>`;
            }

            html += '<th>üìπ</th><th></th>';
            header.innerHTML = html;
        }

        // ========== CONEXI√ìN MICRO:BIT ==========

        document.getElementById('connectBtn').addEventListener('click', async () => {
            try {
                const filters = [
                    { usbVendorId: 0x0d28, usbProductId: 0x0204 },
                    { usbVendorId: 0x0d28 }
                ];

                state.port = await navigator.serial.requestPort({ filters });
                await state.port.open({ baudRate: 115200 });
                state.isConnected = true;

                document.getElementById('connectBtn').style.display = 'none';
                document.getElementById('collectBtn').style.display = 'inline-block';
                document.getElementById('statusText').textContent = 'CONECTADO';
            } catch (err) {
                alert('Error: ' + err.message);
            }
        });

        document.getElementById('collectBtn').addEventListener('click', () => {
            // Establecer tiempo inicial en el momento de comenzar a capturar
            // Esto hace que el primer dato tenga tiempo ‚âà 0
            state.timeZeroOffset = Date.now();

            state.isCollecting = true;
            document.getElementById('collectBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-block';
            document.getElementById('statusText').textContent = 'CAPTURANDO';

            if (state.cameraActive) {
                startVideoRecording();
            }

            startReading();
        });

        document.getElementById('stopBtn').addEventListener('click', async () => {
            state.isCollecting = false;
            stopVideoRecording();

            if (state.reader) {
                try {
                    await state.reader.cancel();
                } catch (err) {
                    console.error('Error al cancelar reader:', err);
                }
            }

            document.getElementById('collectBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('statusText').textContent = 'PAUSADO';
        });

        async function startReading() {
            try {
                const textDecoder = new TextDecoderStream();
                const readableStreamClosed = state.port.readable.pipeTo(textDecoder.writable);
                state.reader = textDecoder.readable.getReader();

                let buffer = '';
                let dataBuffer = [];
                let lastUpdate = Date.now();
                const UPDATE_INTERVAL = 50;

                while (state.isCollecting) {
                    const { value, done } = await state.reader.read();
                    if (done) break;

                    buffer += value;
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        const trimmed = line.trim();
                        if (trimmed) {
                            // Parsear valores separados por coma
                            const parts = trimmed.split(',').map(p => parseFloat(p.trim()));

                            // Verificar que tengamos el n√∫mero correcto de valores
                            if (parts.length === state.numVariables && parts.every(p => !isNaN(p))) {
                                const timestamp = Date.now();
                                const dataPoint = {
                                    time: timestamp,
                                    values: parts,
                                    id: `${timestamp}-${Math.random()}`
                                };

                                dataBuffer.push(dataPoint);

                                const now = Date.now();
                                if (now - lastUpdate >= UPDATE_INTERVAL) {
                                    state.rawData.push(...dataBuffer);
                                    dataBuffer = [];
                                    lastUpdate = now;
                                    requestAnimationFrame(() => updateDisplay());
                                }
                            }
                        }
                    }
                }

                if (dataBuffer.length > 0) {
                    state.rawData.push(...dataBuffer);
                    updateDisplay();
                }
            } catch (err) {
                if (err.name !== 'NetworkError') {
                    console.error('Error en lectura:', err);
                }
            } finally {
                if (state.reader) {
                    try {
                        state.reader.releaseLock();
                    } catch (err) {}
                }
            }
        }

        // ========== AJUSTE DE CURVAS - M√çNIMOS CUADRADOS ==========

        // Funciones auxiliares matem√°ticas
        function matrixSolve(matrix, vector) {
            // Soluci√≥n de sistema lineal Ax = b por eliminaci√≥n Gaussiana
            const n = vector.length;
            const augmented = matrix.map((row, i) => [...row, vector[i]]);

            // Forward elimination
            for (let i = 0; i < n; i++) {
                // Find pivot
                let maxRow = i;
                for (let k = i + 1; k < n; k++) {
                    if (Math.abs(augmented[k][i]) > Math.abs(augmented[maxRow][i])) {
                        maxRow = k;
                    }
                }
                [augmented[i], augmented[maxRow]] = [augmented[maxRow], augmented[i]];

                // Make all rows below this one 0 in current column
                for (let k = i + 1; k < n; k++) {
                    const factor = augmented[k][i] / augmented[i][i];
                    for (let j = i; j <= n; j++) {
                        augmented[k][j] -= factor * augmented[i][j];
                    }
                }
            }

            // Back substitution
            const solution = new Array(n);
            for (let i = n - 1; i >= 0; i--) {
                solution[i] = augmented[i][n];
                for (let j = i + 1; j < n; j++) {
                    solution[i] -= augmented[i][j] * solution[j];
                }
                solution[i] /= augmented[i][i];
            }

            return solution;
        }

        function calculateR2(xData, yData, predictFunc) {
            // Calcula coeficiente de determinaci√≥n R¬≤
            const yMean = yData.reduce((a, b) => a + b, 0) / yData.length;
            let ssRes = 0, ssTot = 0;

            for (let i = 0; i < xData.length; i++) {
                const yPred = predictFunc(xData[i]);
                ssRes += Math.pow(yData[i] - yPred, 2);
                ssTot += Math.pow(yData[i] - yMean, 2);
            }

            return 1 - (ssRes / ssTot);
        }

        // Funci√≥n para crear predictor basado en tipo y coeficientes
        function createPredictor(type, coeffs) {
            switch(type) {
                case 'linear':
                    // y = mx + b
                    return (x) => coeffs[0] * x + coeffs[1];
                case 'quadratic':
                    // y = ax¬≤ + bx + c
                    return (x) => coeffs[0] * x * x + coeffs[1] * x + coeffs[2];
                case 'cubic':
                    // y = ax¬≥ + bx¬≤ + cx + d
                    return (x) => coeffs[0] * x * x * x + coeffs[1] * x * x + coeffs[2] * x + coeffs[3];
                case 'exponential':
                    // y = a¬∑e^(bx)
                    return (x) => coeffs[0] * Math.exp(coeffs[1] * x);
                case 'power':
                    // y = a¬∑x^b
                    return (x) => coeffs[0] * Math.pow(x, coeffs[1]);
                case 'logarithmic':
                    // y = a¬∑ln(x) + b
                    return (x) => coeffs[0] * Math.log(x) + coeffs[1];
                case 'inverse':
                    // y = a/x + b
                    return (x) => coeffs[0] / x + coeffs[1];
                default:
                    return (x) => 0;
            }
        }

        // ========== AJUSTES USANDO REGRESSION-JS ==========
        // Librer√≠a: regression-js por Tom Alexander
        // https://github.com/Tom-Alexander/regression-js

        // Ajustes espec√≠ficos por tipo
        function fitLinear(xData, yData) {
            // y = mx + b usando regression.linear()
            console.log('=== AJUSTE LINEAL (regression-js) ===');
            console.log('N√∫mero de puntos:', xData.length);
            console.log('xData:', xData);
            console.log('yData:', yData);

            // Preparar datos en formato [[x, y], [x, y], ...]
            const data = xData.map((x, i) => [x, yData[i]]);
            console.log('Datos para regression-js:', data);

            // Usar regression-js para el ajuste
            const result = regression.linear(data);

            console.log('Resultado de regression-js:', result);

            // result.equation = [m, b] para y = mx + b
            const m = result.equation[0];
            const b = result.equation[1];

            console.log('Coeficientes: m =', m, ', b =', b);
            console.log('R¬≤ =', result.r2);

            const predict = (x) => m * x + b;
            const equation = `y = ${m.toFixed(4)}x ${b >= 0 ? '+' : ''} ${b.toFixed(4)}`;

            console.log('Ecuaci√≥n:', equation);
            console.log('=== FIN AJUSTE LINEAL ===');

            return { coeffs: [m, b], equation, r2: result.r2, predict };
        }

        function fitQuadratic(xData, yData) {
            // y = ax¬≤ + bx + c usando regression.polynomial(data, 2)
            console.log('=== AJUSTE CUADR√ÅTICO (regression-js) ===');

            const data = xData.map((x, i) => [x, yData[i]]);
            const result = regression.polynomial(data, 2);

            // result.equation = [a, b, c] para y = ax¬≤ + bx + c
            const a = result.equation[0];
            const b = result.equation[1];
            const c = result.equation[2];

            console.log('Coeficientes:', { a, b, c });
            console.log('R¬≤ =', result.r2);

            const predict = (x) => a * x * x + b * x + c;
            const equation = `y = ${a.toFixed(4)}x¬≤ ${b >= 0 ? '+' : ''} ${b.toFixed(4)}x ${c >= 0 ? '+' : ''} ${c.toFixed(4)}`;

            return { coeffs: [a, b, c], equation, r2: result.r2, predict };
        }

        function fitCubic(xData, yData) {
            // y = ax¬≥ + bx¬≤ + cx + d usando regression.polynomial(data, 3)
            console.log('=== AJUSTE C√öBICO (regression-js) ===');

            const data = xData.map((x, i) => [x, yData[i]]);
            const result = regression.polynomial(data, 3);

            // result.equation = [a, b, c, d] para y = ax¬≥ + bx¬≤ + cx + d
            const a = result.equation[0];
            const b = result.equation[1];
            const c = result.equation[2];
            const d = result.equation[3];

            console.log('Coeficientes:', { a, b, c, d });
            console.log('R¬≤ =', result.r2);

            const predict = (x) => a * x * x * x + b * x * x + c * x + d;
            const equation = `y = ${a.toFixed(4)}x¬≥ ${b >= 0 ? '+' : ''} ${b.toFixed(4)}x¬≤ ${c >= 0 ? '+' : ''} ${c.toFixed(4)}x ${d >= 0 ? '+' : ''} ${d.toFixed(4)}`;

            return { coeffs: [a, b, c, d], equation, r2: result.r2, predict };
        }

        function fitExponential(xData, yData) {
            // y = a¬∑e^(bx) usando regression.exponential()
            console.log('=== AJUSTE EXPONENCIAL (regression-js) ===');

            // Verificar que todos los y > 0
            if (yData.some(y => y <= 0)) {
                throw new Error('Datos insuficientes para ajuste exponencial (requiere y > 0)');
            }

            const data = xData.map((x, i) => [x, yData[i]]);
            const result = regression.exponential(data);

            // result.equation = [a, b] para y = a¬∑e^(bx)
            const a = result.equation[0];
            const b = result.equation[1];

            console.log('Coeficientes:', { a, b });
            console.log('R¬≤ =', result.r2);

            const predict = (x) => a * Math.exp(b * x);
            const equation = `y = ${a.toFixed(4)}¬∑e^(${b.toFixed(4)}x)`;

            return { coeffs: [a, b], equation, r2: result.r2, predict };
        }

        function fitPower(xData, yData) {
            // y = a¬∑x^b usando regression.power()
            console.log('=== AJUSTE POTENCIA (regression-js) ===');

            // Verificar que todos los x > 0 y y > 0
            if (xData.some(x => x <= 0) || yData.some(y => y <= 0)) {
                throw new Error('Datos insuficientes para ajuste potencia (requiere x > 0, y > 0)');
            }

            const data = xData.map((x, i) => [x, yData[i]]);
            const result = regression.power(data);

            // result.equation = [a, b] para y = a¬∑x^b
            const a = result.equation[0];
            const b = result.equation[1];

            console.log('Coeficientes:', { a, b });
            console.log('R¬≤ =', result.r2);

            const predict = (x) => a * Math.pow(x, b);
            const equation = `y = ${a.toFixed(4)}¬∑x^${b.toFixed(4)}`;

            return { coeffs: [a, b], equation, r2: result.r2, predict };
        }

        function fitLogarithmic(xData, yData) {
            // y = a¬∑ln(x) + b usando regression.logarithmic()
            console.log('=== AJUSTE LOGAR√çTMICO (regression-js) ===');

            // Verificar que todos los x > 0
            if (xData.some(x => x <= 0)) {
                throw new Error('Datos insuficientes para ajuste logar√≠tmico (requiere x > 0)');
            }

            const data = xData.map((x, i) => [x, yData[i]]);
            const result = regression.logarithmic(data);

            // result.equation = [a, b] para y = a¬∑ln(x) + b
            const a = result.equation[0];
            const b = result.equation[1];

            console.log('Coeficientes:', { a, b });
            console.log('R¬≤ =', result.r2);

            const predict = (x) => a * Math.log(x) + b;
            const equation = `y = ${a.toFixed(4)}¬∑ln(x) ${b >= 0 ? '+' : ''} ${b.toFixed(4)}`;

            return { coeffs: [a, b], equation, r2: result.r2, predict };
        }

        function fitInverse(xData, yData) {
            // y = a/x + b
            const validPoints = [];
            for (let i = 0; i < xData.length; i++) {
                if (xData[i] !== 0) {
                    validPoints.push({ x: xData[i], y: yData[i], invX: 1 / xData[i] });
                }
            }

            if (validPoints.length < 2) {
                throw new Error('Datos insuficientes para ajuste inverso (requiere x ‚â† 0)');
            }

            const xTransformed = validPoints.map(p => p.invX);
            const yOriginal = validPoints.map(p => p.y);

            const linearFit = fitLinear(xTransformed, yOriginal);
            const a = linearFit.coeffs[0];
            const b = linearFit.coeffs[1];

            const predict = (x) => a / x + b;
            const r2 = calculateR2(xData, yData, predict);

            const equation = `y = ${a.toFixed(4)}/x ${b >= 0 ? '+' : ''} ${b.toFixed(4)}`;

            return { coeffs: [a, b], equation, r2, predict };
        }

        // Funci√≥n principal para realizar ajuste
        function performCurveFit(fitType, xData, yData) {
            if (xData.length < 2 || yData.length < 2 || xData.length !== yData.length) {
                throw new Error('Datos insuficientes o inconsistentes para ajuste');
            }

            let result;
            switch (fitType) {
                case 'linear':
                    result = fitLinear(xData, yData);
                    break;
                case 'quadratic':
                    result = fitQuadratic(xData, yData);
                    break;
                case 'cubic':
                    result = fitCubic(xData, yData);
                    break;
                case 'exponential':
                    result = fitExponential(xData, yData);
                    break;
                case 'power':
                    result = fitPower(xData, yData);
                    break;
                case 'logarithmic':
                    result = fitLogarithmic(xData, yData);
                    break;
                case 'inverse':
                    result = fitInverse(xData, yData);
                    break;
                default:
                    throw new Error('Tipo de ajuste no reconocido');
            }

            return {
                type: fitType,
                coeffs: result.coeffs,
                equation: result.equation,
                r2: result.r2,
                predict: result.predict
            };
        }

        // ========== ACTUALIZACI√ìN DE DISPLAY ==========

        let updateScheduled = false;

        function updateDisplay() {
            if (updateScheduled) return;
            updateScheduled = true;

            requestAnimationFrame(() => {
                updateAllCharts();
                updateDataTable();

                document.getElementById('exportBtn').disabled = state.rawData.length === 0;
                document.getElementById('setZeroBtn').disabled = state.selectedPoints.size !== 1;

                updateScheduled = false;
            });
        }

        function updateAllCharts() {
            const timeUnitValue = parseFloat(document.getElementById('timeUnit').value);

            for (let i = 0; i < state.numGraphs; i++) {
                updateChart(i, timeUnitValue);
            }
        }

        function updateChart(index, timeUnitValue) {
            const chart = state.charts[index];
            const config = state.graphs[index];

            // Actualizar t√≠tulo
            document.getElementById(`graphTitle${index}`).textContent =
                `${config.yLabel.toUpperCase()} vs ${config.xLabel.toUpperCase()}`;

            // Actualizar etiquetas de ejes
            chart.options.scales.x.title.text = config.xLabel.toUpperCase();
            chart.options.scales.y.title.text = config.yLabel.toUpperCase();

            // Preparar datasets
            chart.data.datasets = [];

            for (const varIdx of config.yVars) {
                const data = state.rawData.map(d => {
                    let xVal;
                    if (config.xAxis === 'time') {
                        xVal = (d.time - state.timeZeroOffset) / timeUnitValue;
                    } else {
                        const xVarIdx = parseInt(config.xAxis.replace('var', ''));
                        xVal = d.values[xVarIdx];
                    }

                    return {
                        x: xVal,
                        y: d.values[varIdx],
                        id: d.id
                    };
                });

                const pointColors = data.map(d =>
                    state.selectedPoints.has(d.id) ? '#ff0000' : state.variables[varIdx].color
                );

                const pointSizes = data.map(d =>
                    state.selectedPoints.has(d.id) ? 6 : 3
                );

                chart.data.datasets.push({
                    label: state.variables[varIdx].name,
                    data: data,
                    borderColor: state.variables[varIdx].color,
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    pointRadius: pointSizes,
                    pointHoverRadius: 5,
                    pointBackgroundColor: pointColors,
                    pointBorderColor: pointColors,
                    showLine: state.showLines,
                    tension: 0
                });
            }

            // Agregar curva de ajuste si existe y corresponde a esta gr√°fica
            if (state.fitResult && state.fitResult.graphIndex === index) {
                console.log('=== DIBUJANDO CURVA DE AJUSTE ===');
                console.log('Tipo de ajuste:', state.fitResult.type);
                console.log('Coeficientes:', state.fitResult.coeffs);
                console.log('Ecuaci√≥n:', state.fitResult.equation);

                // Obtener rango de datos X
                const xValues = state.rawData.map(d => {
                    if (config.xAxis === 'time') {
                        return (d.time - state.timeZeroOffset) / timeUnitValue;
                    } else {
                        const xVarIdx = parseInt(config.xAxis.replace('var', ''));
                        return d.values[xVarIdx];
                    }
                });

                const xMin = Math.min(...xValues);
                const xMax = Math.max(...xValues);

                console.log('Rango X para curva:', { xMin, xMax });

                // RECREAR la funci√≥n predict bas√°ndose en tipo y coeficientes
                // Esto evita problemas de scope y serializaci√≥n
                const predict = createPredictor(state.fitResult.type, state.fitResult.coeffs);

                // Generar puntos para la curva de ajuste
                // Usar muchos puntos para que curvas complejas se vean suaves
                // pero siguiendo exactamente la ecuaci√≥n matem√°tica
                const numPoints = 300;
                const fitData = [];
                for (let i = 0; i <= numPoints; i++) {
                    const x = xMin + (xMax - xMin) * i / numPoints;
                    const y = predict(x);
                    fitData.push({ x, y });
                }

                console.log('Primeros 5 puntos de la curva:', fitData.slice(0, 5));
                console.log('√öltimos 5 puntos de la curva:', fitData.slice(-5));

                // Agregar dataset de la curva de ajuste
                chart.data.datasets.push({
                    label: `Ajuste: ${state.fitResult.equation}`,
                    data: fitData,
                    borderColor: '#ff00ff',
                    backgroundColor: 'transparent',
                    borderWidth: 3,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    pointHoverRadius: 0,
                    showLine: true,
                    tension: 0  // Sin tensi√≥n: la l√≠nea sigue EXACTAMENTE la ecuaci√≥n matem√°tica
                });

                console.log('=== FIN DIBUJANDO CURVA ===');
            }

            chart.update('none');
        }

        function updateDataTable() {
            const t = translations[currentLanguage];
            const tbody = document.getElementById('dataTableBody');
            const timeUnitValue = parseFloat(document.getElementById('timeUnit').value);
            const searchTerm = document.getElementById('tableSearch').value.toLowerCase();
            const filter = document.getElementById('tableFilter').value;

            if (state.rawData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" style="text-align: center; padding: 20px;">${t.noData}</td></tr>`;
                return;
            }

            let filteredData = state.rawData.filter((d, idx) => {
                // Filtro de selecci√≥n
                if (filter === 'selected' && !state.selectedPoints.has(d.id)) {
                    return false;
                }

                // Filtro de b√∫squeda
                if (searchTerm) {
                    const adjustedTime = ((d.time - state.timeZeroOffset) / timeUnitValue).toFixed(3);
                    const rowText = `${idx + 1} ${adjustedTime} ${d.values.join(' ')}`.toLowerCase();
                    return rowText.includes(searchTerm);
                }

                return true;
            });

            tbody.innerHTML = filteredData.map((d, displayIdx) => {
                const originalIdx = state.rawData.indexOf(d);
                const adjustedTime = (d.time - state.timeZeroOffset) / timeUnitValue;

                let valuesHtml = '';
                for (let i = 0; i < state.numVariables; i++) {
                    valuesHtml += `
                        <td>
                            <input type="number" value="${d.values[i]}"
                                   onchange="editValue('${d.id}', ${i}, this.value)"
                                   onclick="event.stopPropagation()" step="0.01">
                        </td>
                    `;
                }

                return `
                    <tr class="${state.selectedPoints.has(d.id) ? 'selected' : ''}" onclick="toggleSelect('${d.id}')">
                        <td>${originalIdx + 1}</td>
                        <td>${adjustedTime.toFixed(3)}</td>
                        ${valuesHtml}
                        <td>
                            <button class="toolbar-btn"
                                    style="padding: 2px 6px; font-size: 0.8rem; border: 1px solid black;"
                                    onclick="showVideoForPoint('${d.id}'); event.stopPropagation()">
                                ‚ñ∂
                            </button>
                        </td>
                        <td>
                            <button class="delete-btn" onclick="deletePoint('${d.id}'); event.stopPropagation()">
                                √ó
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ========== INTERACCI√ìN CON DATOS ==========

        function toggleSelect(id) {
            if (state.selectedPoints.has(id)) {
                state.selectedPoints.delete(id);
            } else {
                state.selectedPoints.add(id);
            }

            if (state.selectedPoints.size === 1) {
                const selectedId = Array.from(state.selectedPoints)[0];
                const selectedIndex = state.rawData.findIndex(d => d.id === selectedId);
                document.getElementById('pointInfo').textContent = `PUNTO #${selectedIndex + 1} SELECCIONADO`;
                document.getElementById('pointInfo').style.display = 'inline-block';
            } else if (state.selectedPoints.size > 1) {
                document.getElementById('pointInfo').textContent = `${state.selectedPoints.size} PUNTOS SELECCIONADOS`;
                document.getElementById('pointInfo').style.display = 'inline-block';
            } else {
                document.getElementById('pointInfo').style.display = 'none';
            }

            updateDisplay();
        }

        function editValue(id, varIndex, newValue) {
            const point = state.rawData.find(d => d.id === id);
            if (point) {
                point.values[varIndex] = parseFloat(newValue) || point.values[varIndex];
                updateDisplay();
            }
        }

        function deletePoint(id) {
            state.rawData = state.rawData.filter(d => d.id !== id);
            state.selectedPoints.delete(id);
            updateDisplay();
        }

        function handleChartClick(evt, chartIndex) {
            const chart = state.charts[chartIndex];
            const points = chart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);

            if (points.length > 0) {
                const datasetIndex = points[0].datasetIndex;
                const dataIndex = points[0].index;
                const dataset = chart.data.datasets[datasetIndex];
                const pointId = dataset.data[dataIndex].id;

                if (pointId) {
                    toggleSelect(pointId);
                }
            }
        }

        // ========== TABLA - B√öSQUEDA Y FILTROS ==========

        document.getElementById('tableSearch').addEventListener('input', updateDataTable);
        document.getElementById('tableFilter').addEventListener('change', updateDataTable);

        // ========== ESTABLECER TIEMPO CERO ==========

        document.getElementById('setZeroBtn').addEventListener('click', () => {
            if (state.selectedPoints.size === 1) {
                const selectedId = Array.from(state.selectedPoints)[0];
                const point = state.rawData.find(d => d.id === selectedId);
                if (point) {
                    state.timeZeroOffset = point.time;
                    updateDisplay();
                }
            }
        });

        document.getElementById('timeUnit').addEventListener('change', updateDisplay);

        // ========== DEPURACI√ìN DE DATOS ==========

        // Habilitar/deshabilitar botones seg√∫n datos disponibles
        function updateDebugButtons() {
            const hasData = state.rawData.length > 0;
            const hasSelection = state.selectedPoints.size > 0;
            const from = parseInt(document.getElementById('deleteRangeFrom').value);
            const to = parseInt(document.getElementById('deleteRangeTo').value);
            const hasValidRange = !isNaN(from) && !isNaN(to) && from > 0 && to > 0 && from <= to && to <= state.rawData.length;

            document.getElementById('deleteRangeBtn').disabled = !hasData || !hasValidRange;
            document.getElementById('deleteSelectedBtn').disabled = !hasSelection;
            document.getElementById('clearSelectionBtn').disabled = !hasSelection;
        }

        // Actualizar botones cuando cambien los inputs
        document.getElementById('deleteRangeFrom').addEventListener('input', updateDebugButtons);
        document.getElementById('deleteRangeTo').addEventListener('input', updateDebugButtons);

        // Eliminar rango
        document.getElementById('deleteRangeBtn').addEventListener('click', () => {
            const from = parseInt(document.getElementById('deleteRangeFrom').value);
            const to = parseInt(document.getElementById('deleteRangeTo').value);

            if (from && to && from <= to) {
                const fromIdx = from - 1;
                const toIdx = to - 1;

                if (fromIdx >= 0 && toIdx < state.rawData.length) {
                    const pointsToRemove = state.rawData.slice(fromIdx, toIdx + 1);
                    pointsToRemove.forEach(p => state.selectedPoints.delete(p.id));
                    state.rawData.splice(fromIdx, toIdx - fromIdx + 1);

                    document.getElementById('deleteRangeFrom').value = '';
                    document.getElementById('deleteRangeTo').value = '';

                    updateDisplay();
                    updateDebugButtons();
                }
            }
        });

        // Eliminar seleccionados
        document.getElementById('deleteSelectedBtn').addEventListener('click', () => {
            if (state.selectedPoints.size > 0) {
                const idsToDelete = Array.from(state.selectedPoints);
                state.rawData = state.rawData.filter(d => !idsToDelete.includes(d.id));
                state.selectedPoints.clear();
                document.getElementById('pointInfo').style.display = 'none';

                updateDisplay();
                updateDebugButtons();
            }
        });

        // Limpiar selecci√≥n
        document.getElementById('clearSelectionBtn').addEventListener('click', () => {
            state.selectedPoints.clear();
            document.getElementById('pointInfo').style.display = 'none';
            updateDisplay();
            updateDebugButtons();
        });

        // Actualizar botones con cada cambio en los datos
        const originalUpdateDisplay = updateDisplay;
        updateDisplay = function() {
            originalUpdateDisplay();
            updateDebugButtons();
            updateCurveFitButtons();
        };

        // ========== AJUSTE DE CURVAS - CONTROLES ==========

        function updateCurveFitButtons() {
            const hasData = state.rawData.length >= 2;
            const hasSelection = state.selectedPoints.size >= 2;
            const fitModeChecked = document.querySelector('input[name="fitMode"]:checked');
            const fitMode = fitModeChecked ? fitModeChecked.value : 'all';

            let canPerformFit = hasData;

            if (fitMode === 'selected') {
                // Necesita puntos seleccionados
                canPerformFit = hasSelection;
            } else if (fitMode === 'range') {
                // Necesita rango v√°lido
                const from = parseInt(document.getElementById('fitRangeFrom').value);
                const to = parseInt(document.getElementById('fitRangeTo').value);
                canPerformFit = hasData && from >= 1 && to >= 1 && from <= to &&
                                from <= state.rawData.length && to <= state.rawData.length &&
                                (to - from + 1) >= 2; // Al menos 2 puntos en el rango
            }

            document.getElementById('performFitBtn').disabled = !canPerformFit;
            document.getElementById('clearFitBtn').disabled = !state.fitResult;
        }

        function updateFitVariableOptions() {
            const select = document.getElementById('fitVariable');
            select.innerHTML = '';
            for (let i = 0; i < state.numVariables; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = state.variables[i].name;
                select.appendChild(option);
            }
        }

        function updateFitGraphOptions() {
            const t = translations[currentLanguage];
            const select = document.getElementById('fitGraphSelect');
            select.innerHTML = '';
            for (let i = 0; i < state.numGraphs; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${t.graphDefault} ${i + 1}`;
                select.appendChild(option);
            }
        }

        // Event handlers para curve fitting
        // Mostrar/ocultar inputs de rango seg√∫n modo seleccionado
        document.querySelectorAll('input[name="fitMode"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const rangeInputs = document.getElementById('fitRangeInputs');
                rangeInputs.style.display = this.value === 'range' ? 'block' : 'none';
                updateCurveFitButtons();
            });
        });

        // Actualizar botones cuando cambien los inputs de rango
        document.getElementById('fitRangeFrom').addEventListener('input', updateCurveFitButtons);
        document.getElementById('fitRangeTo').addEventListener('input', updateCurveFitButtons);

        document.getElementById('performFitBtn').addEventListener('click', () => {
            try {
                const fitType = document.getElementById('fitType').value;
                const varIndex = parseInt(document.getElementById('fitVariable').value);
                const graphIndex = parseInt(document.getElementById('fitGraphSelect').value);
                const fitMode = document.querySelector('input[name="fitMode"]:checked').value;

                // Obtener configuraci√≥n del gr√°fico seleccionado
                const graphConfig = state.graphs[graphIndex];

                // Preparar datos seg√∫n el modo seleccionado
                let dataToFit = state.rawData;

                if (fitMode === 'selected') {
                    // Solo puntos seleccionados manualmente
                    dataToFit = state.rawData.filter(d => state.selectedPoints.has(d.id));
                } else if (fitMode === 'range') {
                    // Rango de puntos
                    const from = parseInt(document.getElementById('fitRangeFrom').value);
                    const to = parseInt(document.getElementById('fitRangeTo').value);

                    if (!from || !to || from < 1 || to < 1 || from > to) {
                        alert('Por favor ingresa un rango v√°lido (desde ‚â§ hasta)');
                        return;
                    }

                    if (from > state.rawData.length || to > state.rawData.length) {
                        alert(`El rango excede el n√∫mero de datos (m√°ximo: ${state.rawData.length})`);
                        return;
                    }

                    // Extraer el rango (los √≠ndices son base-1, convertir a base-0)
                    const fromIdx = from - 1;
                    const toIdx = to - 1;
                    dataToFit = state.rawData.slice(fromIdx, toIdx + 1);

                    console.log(`Ajustando rango: puntos ${from} a ${to} (${dataToFit.length} puntos)`);
                }
                // Si fitMode === 'all', dataToFit ya es state.rawData

                if (dataToFit.length < 2) {
                    alert('Necesitas al menos 2 puntos de datos para realizar el ajuste');
                    return;
                }

                // Extraer datos X e Y seg√∫n configuraci√≥n del gr√°fico
                const timeUnit = parseFloat(document.getElementById('timeUnit').value);
                let xData, yData;

                if (graphConfig.xAxis === 'time') {
                    // Eje X es tiempo
                    xData = dataToFit.map(d => (d.time - state.timeZeroOffset) / timeUnit);
                    yData = dataToFit.map(d => d.values[varIndex]);
                } else {
                    // Eje X es otra variable
                    const xVarIndex = parseInt(graphConfig.xAxis.replace('var', ''));
                    xData = dataToFit.map(d => d.values[xVarIndex]);
                    yData = dataToFit.map(d => d.values[varIndex]);
                }

                // Debug: verificar que los datos son v√°lidos
                console.log('Datos para ajuste:', { fitType, xData, yData, varIndex, graphConfig });

                if (xData.some(x => isNaN(x)) || yData.some(y => isNaN(y))) {
                    alert('Error: Datos inv√°lidos detectados. Verifica la configuraci√≥n de la gr√°fica.');
                    console.error('Datos inv√°lidos:', { xData, yData });
                    return;
                }

                // Realizar ajuste
                const fitResult = performCurveFit(fitType, xData, yData);

                // Guardar resultado en estado
                state.fitResult = {
                    ...fitResult,
                    graphIndex: graphIndex,
                    varIndex: varIndex,
                    xAxis: graphConfig.xAxis,
                    dataPoints: dataToFit.length
                };

                // Mostrar resultados
                document.getElementById('fitResults').style.display = 'block';
                document.getElementById('fitEquation').textContent = fitResult.equation;
                document.getElementById('fitR2').textContent = fitResult.r2.toFixed(6);
                document.getElementById('fitPoints').textContent = dataToFit.length;

                // Actualizar gr√°fico con la curva de ajuste
                updateAllCharts();
                updateCurveFitButtons();

            } catch (error) {
                alert('Error al realizar el ajuste: ' + error.message);
                console.error('Error en curve fit:', error);
            }
        });

        document.getElementById('clearFitBtn').addEventListener('click', () => {
            state.fitResult = null;
            document.getElementById('fitResults').style.display = 'none';
            updateAllCharts();
            updateCurveFitButtons();
        });

        // ========== ESTAD√çSTICAS ==========

        document.getElementById('statsBtn').addEventListener('click', () => {
            const t = translations[currentLanguage];

            if (state.rawData.length === 0) {
                alert(t.noDataAlert);
                return;
            }

            let statsHtml = '';

            for (let i = 0; i < state.numVariables; i++) {
                const values = state.rawData.map(d => d.values[i]);
                const mean = values.reduce((a, b) => a + b, 0) / values.length;
                const min = Math.min(...values);
                const max = Math.max(...values);
                const stdDev = Math.sqrt(values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length);

                statsHtml += `
                    <strong>${state.variables[i].name}:</strong><br>
                    ${t.mean}: ${mean.toFixed(4)}<br>
                    ${t.minimum}: ${min.toFixed(4)}<br>
                    ${t.maximum}: ${max.toFixed(4)}<br>
                    ${t.stdDev}: ${stdDev.toFixed(4)}<br>
                    <br>
                `;
            }

            statsHtml += `${t.totalPoints}: ${state.rawData.length}`;

            document.getElementById('statsBody').innerHTML = statsHtml;
            document.getElementById('statsModal').classList.add('active');
        });

        function closeStatsModal() {
            document.getElementById('statsModal').classList.remove('active');
        }

        // ========== EXPORTAR/IMPORTAR ==========

        document.getElementById('exportBtn').addEventListener('click', () => {
            const timeUnitValue = parseFloat(document.getElementById('timeUnit').value);

            // Header
            let header = 'Tiempo';
            for (let i = 0; i < state.numVariables; i++) {
                header += ',' + state.variables[i].name;
            }

            // Datos
            const dataRows = state.rawData.map(d => {
                const adjustedTime = (d.time - state.timeZeroOffset) / timeUnitValue;
                let row = adjustedTime.toFixed(6);
                for (let i = 0; i < state.numVariables; i++) {
                    row += ',' + d.values[i].toFixed(6);
                }
                return row;
            }).join('\n');

            const csv = header + '\n' + dataRows;

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;

            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            a.download = `microbit_data_${timestamp}.csv`;

            a.click();
            URL.revokeObjectURL(url);
        });

        document.getElementById('importBtn').addEventListener('click', () => {
            document.getElementById('importFile').click();
        });

        document.getElementById('importFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const csv = event.target.result;
                    const lines = csv.split('\n');

                    if (lines.length < 2) {
                        alert('Archivo CSV vac√≠o o inv√°lido');
                        return;
                    }

                    // Parsear header
                    const header = lines[0].split(',').map(h => h.trim());
                    const numVars = header.length - 1; // Menos la columna de tiempo

                    if (numVars < 1 || numVars > 3) {
                        alert('El CSV debe tener entre 1 y 3 variables (m√°s la columna de tiempo)');
                        return;
                    }

                    // Parsear datos
                    const importedData = [];
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;

                        const parts = line.split(',').map(p => parseFloat(p.trim()));
                        if (parts.length !== numVars + 1 || parts.some(p => isNaN(p))) continue;

                        const [time, ...values] = parts;

                        // Convertir tiempo relativo a timestamp
                        const timeUnitValue = parseFloat(document.getElementById('timeUnit').value);
                        const timestamp = Date.now() + (time * timeUnitValue);

                        importedData.push({
                            time: timestamp,
                            values: values,
                            id: `${timestamp}-${Math.random()}`
                        });
                    }

                    if (importedData.length === 0) {
                        alert('No se pudieron importar datos v√°lidos');
                        return;
                    }

                    // Configurar variables seg√∫n el CSV
                    document.getElementById('numVariables').value = numVars;
                    document.getElementById('numVariables').dispatchEvent(new Event('change'));

                    for (let i = 0; i < numVars; i++) {
                        if (header[i + 1]) {
                            document.getElementById(`var${i+1}Name`).value = header[i + 1];
                        }
                    }

                    // Aplicar configuraci√≥n y cargar datos
                    applyVariableConfiguration();
                    state.rawData = importedData;
                    updateDisplay();

                    alert(`Se importaron ${importedData.length} puntos con ${numVars} variable(s)`);
                } catch (err) {
                    alert('Error al importar CSV: ' + err.message);
                }
            };

            reader.readAsText(file);
            e.target.value = ''; // Reset input
        });

        // ========== LIMPIAR ==========

        document.getElementById('clearBtn').addEventListener('click', () => {
            if (confirm('¬øEliminar todos los datos y video?')) {
                state.rawData = [];
                state.selectedPoints.clear();
                state.timeZeroOffset = 0;
                state.videoBlob = null;
                state.recordedChunks = [];
                document.getElementById('pointInfo').style.display = 'none';
                updateDisplay();
            }
        });

        // ========== C√ÅMARA Y VIDEO ==========

        document.getElementById('cameraBtn').addEventListener('click', async () => {
            if (!state.cameraActive) {
                try {
                    state.mediaStream = await navigator.mediaDevices.getUserMedia({
                        video: true,
                        audio: false
                    });
                    document.getElementById('cameraPreview').srcObject = state.mediaStream;
                    state.cameraActive = true;
                    document.getElementById('videoSection').style.display = 'block';
                    document.getElementById('cameraBtn').classList.add('primary');
                } catch (err) {
                    alert('No se pudo acceder a la c√°mara: ' + err.message);
                }
            }
        });

        document.getElementById('stopCameraBtn').addEventListener('click', () => {
            stopCamera();
        });

        function stopCamera() {
            if (state.mediaStream) {
                state.mediaStream.getTracks().forEach(track => track.stop());
                state.mediaStream = null;
                document.getElementById('cameraPreview').srcObject = null;
            }
            state.cameraActive = false;
            document.getElementById('videoSection').style.display = 'none';
            document.getElementById('cameraBtn').classList.remove('primary');

            if (state.mediaRecorder && state.mediaRecorder.state === 'recording') {
                state.mediaRecorder.stop();
            }
        }

        function startVideoRecording() {
            if (!state.cameraActive || !state.mediaStream) return;

            state.recordedChunks = [];
            state.recordingStartTime = Date.now();

            state.mediaRecorder = new MediaRecorder(state.mediaStream, {
                mimeType: 'video/webm;codecs=vp9'
            });

            state.mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    state.recordedChunks.push(event.data);
                }
            };

            state.mediaRecorder.onstop = () => {
                state.videoBlob = new Blob(state.recordedChunks, { type: 'video/webm' });
            };

            state.mediaRecorder.start();
            document.getElementById('recordingIndicator').classList.add('active');
        }

        function stopVideoRecording() {
            if (state.mediaRecorder && state.mediaRecorder.state === 'recording') {
                state.mediaRecorder.stop();
                document.getElementById('recordingIndicator').classList.remove('active');
            }
        }

        function showVideoForPoint(id) {
            const point = state.rawData.find(d => d.id === id);
            if (!point) return;

            if (!state.videoBlob) {
                alert('No hay video grabado para este experimento');
                return;
            }

            const timeUnitValue = parseFloat(document.getElementById('timeUnit').value);
            const adjustedTime = (point.time - state.timeZeroOffset) / timeUnitValue;
            const videoTime = (point.time - state.recordingStartTime) / 1000;

            if (videoTime < 0) {
                alert('Este punto fue capturado antes de iniciar la grabaci√≥n');
                return;
            }

            const videoURL = URL.createObjectURL(state.videoBlob);
            const playbackVideo = document.getElementById('playbackVideo');
            playbackVideo.src = videoURL;
            playbackVideo.currentTime = videoTime;

            let valuesText = '';
            for (let i = 0; i < state.numVariables; i++) {
                valuesText += `${state.variables[i].name}: ${point.values[i].toFixed(4)}<br>`;
            }

            document.getElementById('videoInfo').innerHTML = `
                TIEMPO: ${adjustedTime.toFixed(3)} s<br>
                ${valuesText}
                VIDEO EN: ${videoTime.toFixed(2)} segundos
            `;

            document.getElementById('videoModal').classList.add('active');
        }

        function closeVideoModal() {
            document.getElementById('videoModal').classList.remove('active');
            document.getElementById('playbackVideo').pause();
            document.getElementById('playbackVideo').src = '';
        }

        // ========== AYUDA ==========

        document.getElementById('helpBtn').addEventListener('click', () => {
            document.getElementById('helpModal').classList.add('active');
        });

        function closeHelpModal() {
            document.getElementById('helpModal').classList.remove('active');
        }

        // ========== UTILIDADES ==========

        function toggleSection(header) {
            const content = header.nextElementSibling;
            const arrow = header.querySelector('span');

            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                arrow.textContent = '‚ñº';
            } else {
                content.classList.add('collapsed');
                arrow.textContent = '‚ñ∂';
            }
        }

        // Cerrar modales con ESC o click fuera
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeStatsModal();
                closeVideoModal();
                closeHelpModal();
            }
        });

        ['statsModal', 'videoModal', 'helpModal'].forEach(modalId => {
            document.getElementById(modalId).addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    if (modalId === 'statsModal') closeStatsModal();
                    if (modalId === 'videoModal') closeVideoModal();
                    if (modalId === 'helpModal') closeHelpModal();
                }
            });
        });
    </script>
</body>
</html>
